<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://esm.sh https://www.gstatic.com https://www.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com https://esm.sh; img-src 'self' data: https:; frame-src 'none';">
    <title>Spades - Secure Student Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              display: ['Outfit', 'sans-serif'],
              mono: ['JetBrains Mono', 'monospace'],
            },
            colors: {
              brand: {
                obsidian: '#050505',
                charcoal: '#0a0a0a',
                card: '#121212',
                red: '#d92323',
                deepRed: '#500808',
                gold: '#e2b15b',
                goldDim: '#8a6d3b',
              }
            },
            animation: {
              'pulse-slow': 'pulse 8s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'float': 'float 10s ease-in-out infinite',
              'shine': 'shine 6s linear infinite',
              'shimmer': 'shimmer 3s ease-in-out infinite alternate',
              'glow': 'glow 4s ease-in-out infinite alternate',
            },
            keyframes: {
              float: {
                '0%, 100%': { transform: 'translateY(0)' },
                '50%': { transform: 'translateY(-15px)' },
              },
              shine: {
                '0%': { backgroundPosition: '200% center' },
                '100%': { backgroundPosition: '-200% center' },
              },
              shimmer: {
                '0%': { opacity: 0.5 },
                '100%': { opacity: 1 },
              },
              glow: {
                '0%': { boxShadow: '0 0 10px rgba(217, 35, 35, 0.1)' },
                '100%': { boxShadow: '0 0 30px rgba(217, 35, 35, 0.3), 0 0 15px rgba(226, 177, 91, 0.1)' }
              }
            }
          }
        }
      }
    </script>
    <style>
      body {
        background-color: #020202;
        color: #f5f5f5;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      
      /* Ultra-Premium Background */
      .cinematic-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: -1;
        background: radial-gradient(circle at 50% -20%, #1a0505 0%, #020202 50%);
        pointer-events: none;
      }

      .noise-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        opacity: 0.04;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        pointer-events: none;
        mix-blend-mode: overlay;
      }

      /* Refined Scrollbar */
      ::-webkit-scrollbar {
        width: 4px;
      }
      ::-webkit-scrollbar-track {
        background: #020202;
      }
      ::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #d92323;
      }
      
      /* High-End Glassmorphism */
      .glass-panel {
        background: rgba(10, 10, 10, 0.6);
        backdrop-filter: blur(24px) saturate(180%);
        -webkit-backdrop-filter: blur(24px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.05);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      }
      
      .glass-card-hover {
        transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
      }
      .glass-card-hover:hover {
        background: rgba(20, 20, 20, 0.8);
        border-color: rgba(255, 255, 255, 0.1);
        transform: translateY(-4px);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
      }

      /* Gold Text Effect */
      .text-gradient-gold {
        background: linear-gradient(135deg, #fceeb5 0%, #e2b15b 50%, #8a6d3b 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-size: 100% auto;
      }
      
      /* Red Text Effect */
      .text-gradient-red {
        background: linear-gradient(135deg, #ff8080 0%, #d92323 60%, #500808 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      /* Custom Scrollbar for Content Areas */
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(217, 35, 35, 0.5);
      }

      /* Animation Classes */
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      @keyframes slideInFromTop {
        from { transform: translateY(-20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      
      .animate-in {
        animation: fadeIn 0.5s ease-out;
      }
      
      .fade-in {
        animation: fadeIn 0.5s ease-out;
      }
      
      .slide-in-from-top-2 {
        animation: slideInFromTop 0.3s ease-out;
      }
    </style>

    <!-- Background Elements -->
    <div class="cinematic-bg"></div>
    <div class="noise-overlay"></div>
  </head>
  <body>
    <div id="root"></div>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>

    <script type="module">
      import React from 'react';
      import ReactDOM from 'react-dom/client';
      import { initializeApp } from 'firebase/app';
      import { 
        getFirestore, 
        collection, 
        doc, 
        getDoc, 
        getDocs, 
        setDoc, 
        updateDoc, 
        deleteDoc, 
        query, 
        orderBy, 
        writeBatch 
      } from 'firebase/firestore';

      const { useState, useEffect, useCallback, useRef, useMemo } = React;

      // ============================================
      // SECURITY: Password Hashing Utility
      // ============================================
      class SecureAuth {
        static async hashPassword(password) {
          const encoder = new TextEncoder();
          const data = encoder.encode(password);
          const hashBuffer = await crypto.subtle.digest('SHA-256', data);
          const hashArray = Array.from(new Uint8Array(hashBuffer));
          return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        static async verifyPassword(password, hash) {
          const passwordHash = await this.hashPassword(password);
          return passwordHash === hash;
        }

        static generateSalt() {
          const array = new Uint8Array(16);
          crypto.getRandomValues(array);
          return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
        }

        static async hashPasswordWithSalt(password, salt) {
          const encoder = new TextEncoder();
          const data = encoder.encode(password + salt);
          const hashBuffer = await crypto.subtle.digest('SHA-256', data);
          const hashArray = Array.from(new Uint8Array(hashBuffer));
          return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        static sanitizeInput(input) {
          if (typeof input !== 'string') return '';
          return input.trim().replace(/[<>]/g, '');
        }
      }

      // ============================================
      // FIREBASE CONFIGURATION
      // ============================================
      // Firebase configuration provided by user
      const firebaseConfig = {
        apiKey: "AIzaSyBYfyPC_PEejSVytCmgljnKQ2HUSROlIFc",
        authDomain: "spades-c87ee.firebaseapp.com",
        projectId: "spades-c87ee",
        storageBucket: "spades-c87ee.firebasestorage.app",
        messagingSenderId: "930924627451",
        appId: "1:930924627451:web:99576f0d2d88f508e6375e",
        measurementId: "G-X49C6SCGGW"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // ============================================
      // CONSTANTS AND CONFIGURATION
      // ============================================
      const RANK_CONFIG = {
        '2‚ô†': { name: '2 of Spades', minPoints: 0, color: '#666' },
        '3‚ô†': { name: '3 of Spades', minPoints: 100, color: '#777' },
        '4‚ô†': { name: '4 of Spades', minPoints: 250, color: '#888' },
        '5‚ô†': { name: '5 of Spades', minPoints: 500, color: '#999' },
        '6‚ô†': { name: '6 of Spades', minPoints: 1000, color: '#aaa' },
        '7‚ô†': { name: '7 of Spades', minPoints: 2000, color: '#bbb' },
        '8‚ô†': { name: '8 of Spades', minPoints: 3500, color: '#ccc' },
        '9‚ô†': { name: '9 of Spades', minPoints: 5500, color: '#ddd' },
        '10‚ô†': { name: '10 of Spades', minPoints: 8000, color: '#e2b15b' },
        'J‚ô†': { name: 'Jack of Spades', minPoints: 12000, color: '#e2b15b' },
        'Q‚ô†': { name: 'Queen of Spades', minPoints: 18000, color: '#e2b15b' },
        'K‚ô†': { name: 'King of Spades', minPoints: 27000, color: '#e2b15b' },
        'A‚ô†': { name: 'Ace of Spades', minPoints: 50000, color: '#d92323' }
      };

      const POINTS_CONFIG = {
        POST: 10,
        COMMENT: 5,
        UPVOTE_RECEIVED: 2,
        STUDY_MINUTE: 1,
        STREAK_FREEZE_COST: 500,
        MAX_STREAK_FREEZES: 3
      };

      const RANK_ORDER = ['2‚ô†', '3‚ô†', '4‚ô†', '5‚ô†', '6‚ô†', '7‚ô†', '8‚ô†', '9‚ô†', '10‚ô†', 'J‚ô†', 'Q‚ô†', 'K‚ô†', 'A‚ô†'];

      // ============================================
      // DATABASE SERVICE
      // ============================================
      class DatabaseService {
        // User Management
        async getUser(studentId) {
          try {
            const userDoc = await getDoc(doc(db, 'users', studentId));
            return userDoc.exists() ? userDoc.data() : null;
          } catch (error) {
            console.error('Error getting user:', error);
            return null;
          }
        }

        async saveUser(userData) {
          try {
            await setDoc(doc(db, 'users', userData.studentId), userData);
          } catch (error) {
            console.error('Error saving user:', error);
          }
        }

        async getAllUsers() {
          try {
            const usersSnapshot = await getDocs(collection(db, 'users'));
            return usersSnapshot.docs.map(doc => doc.data());
          } catch (error) {
            console.error('Error getting all users:', error);
            return [];
          }
        }

        async updatePassword(studentId, newPassword) {
          try {
            const salt = SecureAuth.generateSalt();
            const passwordHash = await SecureAuth.hashPasswordWithSalt(newPassword, salt);
            await updateDoc(doc(db, 'users', studentId), {
              passwordHash,
              salt,
              requiresPasswordChange: false
            });
          } catch (error) {
            console.error('Error updating password:', error);
          }
        }

        async authenticateUser(studentId, password) {
          try {
            const user = await this.getUser(studentId);
            if (!user) return { success: false, message: 'User not found' };
            
            if (user.isBanned) {
              return { success: false, message: 'Account suspended' };
            }

            // Support both legacy (unsalted) and new (salted) password hashing
            let isValid = false;
            if (user.salt) {
              const hash = await SecureAuth.hashPasswordWithSalt(password, user.salt);
              isValid = hash === user.passwordHash;
            } else {
              // Legacy support - will be migrated on next password change
              isValid = await SecureAuth.verifyPassword(password, user.passwordHash);
            }

            if (!isValid) {
              return { success: false, message: 'Invalid credentials' };
            }

            // Update last login
            await updateDoc(doc(db, 'users', studentId), {
              lastLoginDate: new Date().toISOString(),
              lastActive: new Date().toISOString()
            });

            return { success: true, user };
          } catch (error) {
            console.error('Error authenticating user:', error);
            return { success: false, message: 'Authentication error' };
          }
        }

        async createUser(studentId, username, password, yearGroup, house) {
          try {
            const existingUser = await this.getUser(studentId);
            if (existingUser) {
              return { success: false, message: 'User already exists' };
            }

            const salt = SecureAuth.generateSalt();
            const passwordHash = await SecureAuth.hashPasswordWithSalt(password, salt);

            const newUser = {
              studentId: SecureAuth.sanitizeInput(studentId),
              username: SecureAuth.sanitizeInput(username),
              passwordHash,
              salt,
              currentRank: '2 of Spades',
              currentCard: '2‚ô†',
              totalPoints: 0,
              spadesBalance: 0,
              streak: 0,
              streakFreezes: 0,
              lastLoginDate: new Date().toISOString(),
              joinDate: new Date().toISOString(),
              lastActive: new Date().toISOString(),
              yearGroup: parseInt(yearGroup),
              house: SecureAuth.sanitizeInput(house),
              stats: {
                postsCreated: 0,
                commentsCreated: 0,
                votesGiven: 0,
                resourcesShared: 0,
                moderationsPerformed: 0,
                minutesStudied: 0
              },
              isAdmin: false,
              isBanned: false,
              requiresPasswordChange: false,
              inventory: []
            };

            await this.saveUser(newUser);
            return { success: true, user: newUser };
          } catch (error) {
            console.error('Error creating user:', error);
            return { success: false, message: 'Error creating account' };
          }
        }

        // Guest Access
        async createGuestUser() {
          const guestId = `guest-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
          const guestUser = {
            studentId: guestId,
            username: `Guest_${Math.random().toString(36).substr(2, 6)}`,
            currentRank: 'Guest',
            currentCard: '2‚ô†',
            totalPoints: 0,
            spadesBalance: 0,
            streak: 0,
            streakFreezes: 0,
            lastLoginDate: new Date().toISOString(),
            joinDate: new Date().toISOString(),
            lastActive: new Date().toISOString(),
            yearGroup: 0,
            house: 'Guest',
            stats: {
              postsCreated: 0,
              commentsCreated: 0,
              votesGiven: 0,
              resourcesShared: 0,
              moderationsPerformed: 0,
              minutesStudied: 0
            },
            isAdmin: false,
            isBanned: false,
            isGuest: true,
            inventory: []
          };
          return guestUser;
        }

        // Posts Management
        async getPosts() {
          try {
            const postsQuery = query(collection(db, 'posts'), orderBy('createdAt', 'desc'));
            const postsSnapshot = await getDocs(postsQuery);
            return postsSnapshot.docs.map(doc => doc.data());
          } catch (error) {
            console.error('Error getting posts:', error);
            return [];
          }
        }

        async savePost(postData) {
          try {
            await setDoc(doc(db, 'posts', postData.id), postData);
          } catch (error) {
            console.error('Error saving post:', error);
          }
        }

        async deletePost(postId) {
          try {
            await deleteDoc(doc(db, 'posts', postId));
          } catch (error) {
            console.error('Error deleting post:', error);
          }
        }

        async deleteComment(postId, commentId) {
          try {
            const postDoc = await getDoc(doc(db, 'posts', postId));
            if (postDoc.exists()) {
              const post = postDoc.data();
              const updatedComments = post.comments.filter(c => c.id !== commentId);
              await updateDoc(doc(db, 'posts', postId), { comments: updatedComments });
            }
          } catch (error) {
            console.error('Error deleting comment:', error);
          }
        }

        // Art Gallery Management
        async getArtPieces() {
          try {
            const artQuery = query(collection(db, 'artPieces'), orderBy('createdAt', 'desc'));
            const artSnapshot = await getDocs(artQuery);
            return artSnapshot.docs.map(doc => doc.data());
          } catch (error) {
            console.error('Error getting art pieces:', error);
            return [];
          }
        }

        async uploadArt(artData) {
          try {
            await setDoc(doc(db, 'artPieces', artData.id), artData);
          } catch (error) {
            console.error('Error uploading art:', error);
          }
        }

        async deleteArt(artId) {
          try {
            await deleteDoc(doc(db, 'artPieces', artId));
          } catch (error) {
            console.error('Error deleting art:', error);
          }
        }

        async purchaseArt(userId, artId, currency) {
          try {
            const user = await this.getUser(userId);
            const artDoc = await getDoc(doc(db, 'artPieces', artId));
            
            if (!user) return { success: false, message: 'User not found' };
            if (!artDoc.exists()) return { success: false, message: 'Art not found' };
            
            const art = artDoc.data();
            if (art.ownerId) return { success: false, message: 'Already purchased' };

            let cost = 0;
            if (currency === 'points') {
              if (!art.allowPoints) return { success: false, message: 'Points not accepted' };
              if (user.totalPoints < art.price) return { success: false, message: 'Insufficient points' };
              cost = art.price;
            } else {
              if (!art.allowSpades) return { success: false, message: 'Spades not accepted' };
              if (user.spadesBalance < art.spadesPrice) return { success: false, message: 'Insufficient spades' };
              cost = art.spadesPrice;
            }

            const batch = writeBatch(db);
            const updatedInventory = [...(user.inventory || []), art.id];
            const userUpdate = currency === 'points' 
              ? { totalPoints: user.totalPoints - cost, inventory: updatedInventory }
              : { spadesBalance: user.spadesBalance - cost, inventory: updatedInventory };

            batch.update(doc(db, 'users', userId), userUpdate);
            batch.update(doc(db, 'artPieces', artId), {
              ownerId: user.studentId,
              ownerName: user.username
            });

            const purchaseLog = {
              id: `purchase-${Date.now()}`,
              buyerId: user.studentId,
              buyerName: user.username,
              artId: art.id,
              artTitle: art.title,
              price: cost,
              currencyUsed: currency,
              timestamp: new Date().toISOString(),
              delivered: false
            };
            batch.set(doc(db, 'purchaseLogs', purchaseLog.id), purchaseLog);

            await batch.commit();
            return { success: true, message: 'Purchase successful' };
          } catch (error) {
            console.error('Error purchasing art:', error);
            return { success: false, message: 'Purchase failed' };
          }
        }

        // Settings Management
        async getSettings() {
          try {
            const settingsDoc = await getDoc(doc(db, 'systemSettings', 'settings'));
            return settingsDoc.exists() ? settingsDoc.data() : {
              minRankToPost: '2‚ô†',
              allowPublicSignups: true,
              allowGuestAccess: true,
              emergencyLockdown: false
            };
          } catch (error) {
            console.error('Error getting settings:', error);
            return {
              minRankToPost: '2‚ô†',
              allowPublicSignups: true,
              allowGuestAccess: true,
              emergencyLockdown: false
            };
          }
        }

        async updateSettings(settings) {
          try {
            const currentSettings = await this.getSettings();
            await setDoc(doc(db, 'systemSettings', 'settings'), {
              ...currentSettings,
              ...settings
            });
          } catch (error) {
            console.error('Error updating settings:', error);
          }
        }

        // Purchase Logs
        async getPurchaseLogs() {
          try {
            const logsQuery = query(collection(db, 'purchaseLogs'), orderBy('timestamp', 'desc'));
            const logsSnapshot = await getDocs(logsQuery);
            return logsSnapshot.docs.map(doc => doc.data());
          } catch (error) {
            console.error('Error getting purchase logs:', error);
            return [];
          }
        }

        async markDelivered(logId) {
          try {
            await updateDoc(doc(db, 'purchaseLogs', logId), { delivered: true });
          } catch (error) {
            console.error('Error marking delivered:', error);
          }
        }

        // Streak Freeze Purchase
        async purchaseStreakFreeze(userId) {
          try {
            const user = await this.getUser(userId);
            if (!user) return { success: false, message: 'User not found' };
            
            if (user.streakFreezes >= POINTS_CONFIG.MAX_STREAK_FREEZES) {
              return { success: false, message: 'Maximum streak freezes reached' };
            }
            
            if (user.totalPoints < POINTS_CONFIG.STREAK_FREEZE_COST) {
              return { success: false, message: `Insufficient points. Need ${POINTS_CONFIG.STREAK_FREEZE_COST}` };
            }

            await updateDoc(doc(db, 'users', userId), {
              totalPoints: user.totalPoints - POINTS_CONFIG.STREAK_FREEZE_COST,
              streakFreezes: user.streakFreezes + 1
            });

            return { success: true, message: 'Streak freeze purchased' };
          } catch (error) {
            console.error('Error purchasing streak freeze:', error);
            return { success: false, message: 'Purchase failed' };
          }
        }

        // Initialize System
        async init() {
          try {
            const aceDoc = doc(db, 'users', 'ace-of-spades');
            const aceSnapshot = await getDoc(aceDoc);
            
            if (!aceSnapshot.exists()) {
              // Create Ace of Spades admin account with secure password
              const salt = SecureAuth.generateSalt();
              const passwordHash = await SecureAuth.hashPasswordWithSalt('SecureAdminPassword2024!', salt);
              
              const aceUser = {
                studentId: 'ace-of-spades',
                username: 'Ace of Spades',
                passwordHash,
                salt,
                currentRank: 'Ace of Spades',
                currentCard: 'A‚ô†',
                totalPoints: 50000,
                spadesBalance: 100,
                streak: 1,
                streakFreezes: 0,
                lastLoginDate: new Date().toISOString(),
                joinDate: new Date().toISOString(),
                lastActive: new Date().toISOString(),
                yearGroup: 13,
                house: 'Phoenix',
                stats: {
                  postsCreated: 0,
                  commentsCreated: 0,
                  votesGiven: 0,
                  resourcesShared: 0,
                  moderationsPerformed: 0,
                  minutesStudied: 0
                },
                isAdmin: true,
                isBanned: false,
                requiresPasswordChange: true,
                inventory: []
              };
              await setDoc(aceDoc, aceUser);
              console.log('Admin account created. Default password: SecureAdminPassword2024!');
            }

            const settingsDoc = doc(db, 'systemSettings', 'settings');
            const settingsSnapshot = await getDoc(settingsDoc);
            
            if (!settingsSnapshot.exists()) {
              await setDoc(settingsDoc, {
                minRankToPost: '2‚ô†',
                allowPublicSignups: true,
                allowGuestAccess: true,
                emergencyLockdown: false
              });
            }
          } catch (error) {
            console.error('Error initializing system:', error);
          }
        }
      }

      const dbService = new DatabaseService();

      // ============================================
      // CONTENT MODERATION
      // ============================================
      class ContentModerator {
        static profanityList = [
          'fuck', 'shit', 'piss', 'cunt', 'nigger', 'faggot', 
          'retard', 'bastard', 'bitch', 'asshole', 'dick', 'pussy'
        ];

        static sanitizeText(text) {
          let sanitized = SecureAuth.sanitizeInput(text);
          this.profanityList.forEach(word => {
            const regex = new RegExp(`\\b${word}\\b`, 'gi');
            sanitized = sanitized.replace(regex, '#'.repeat(word.length));
          });
          return sanitized;
        }

        static async checkContent(text) {
          // Basic content check - can be enhanced with API calls
          const lowerText = text.toLowerCase();
          const severeKeywords = ['kill', 'bomb', 'attack', 'illegal'];
          const hasSevereContent = severeKeywords.some(keyword => lowerText.includes(keyword));
          
          return {
            safe: !hasSevereContent,
            reason: hasSevereContent ? 'Content flagged for review' : ''
          };
        }
      }

      // ============================================
      // REACT COMPONENTS
      // ============================================

      // Card Component
      const RankCard = ({ rankId, size = 'md', className = '' }) => {
        const sizes = {
          sm: 'w-10 h-14 text-[10px] rounded',
          md: 'w-28 h-40 text-xl rounded-xl',
          lg: 'w-56 h-80 text-5xl rounded-2xl'
        };

        const suit = '‚ô†';
        const value = rankId.replace('‚ô†', '');
        const isFaceCard = ['J', 'Q', 'K', 'A'].includes(value);
        const isAce = value === 'A';

        return (
          <div className={`
            ${sizes[size]} ${className}
            relative bg-gradient-to-br from-white via-gray-50 to-gray-100
            border-2 ${isAce ? 'border-brand-red' : 'border-gray-300'}
            shadow-2xl flex flex-col items-center justify-between p-2
            ${isAce ? 'animate-glow' : ''}
          `}>
            <div className={`font-bold ${isAce ? 'text-brand-red' : 'text-black'}`}>
              {value}{suit}
            </div>
            <div className={`text-6xl ${size === 'sm' ? 'text-2xl' : size === 'lg' ? 'text-8xl' : 'text-6xl'} ${isAce ? 'text-brand-red animate-pulse-slow' : 'text-black'}`}>
              {suit}
            </div>
            <div className={`font-bold transform rotate-180 ${isAce ? 'text-brand-red' : 'text-black'}`}>
              {value}{suit}
            </div>
          </div>
        );
      };

      // Landing Page Component
      const LandingPage = ({ onEnterSystem }) => {
        return (
          <div className="min-h-screen flex items-center justify-center p-4">
            <div className="text-center space-y-12 max-w-4xl animate-in fade-in duration-1000">
              <div className="space-y-6">
                <h1 className="text-7xl md:text-9xl font-display font-black text-gradient-gold uppercase tracking-tight">
                  Spades
                </h1>
                <p className="text-neutral-500 text-sm md:text-base font-mono uppercase tracking-widest">
                  Elite Student Platform
                </p>
              </div>

              <div className="flex justify-center">
                <RankCard rankId="A‚ô†" size="lg" className="animate-float" />
              </div>

              <button
                onClick={onEnterSystem}
                className="group relative px-12 py-5 bg-brand-red text-white font-black text-lg uppercase tracking-widest rounded-xl overflow-hidden transition-all hover:scale-105 hover:shadow-2xl"
              >
                <span className="relative z-10">Enter System</span>
                <div className="absolute inset-0 bg-gradient-to-r from-brand-red via-red-600 to-brand-red bg-size-200 animate-shine"></div>
              </button>

              <div className="text-neutral-700 text-xs font-mono">
                Secure Platform ‚Ä¢ Version 2.0
              </div>
            </div>
          </div>
        );
      };

      // Authentication Page Component
      const AuthPage = ({ onLogin, onBack }) => {
        const [mode, setMode] = useState('login');
        const [studentId, setStudentId] = useState('');
        const [password, setPassword] = useState('');
        const [username, setUsername] = useState('');
        const [yearGroup, setYearGroup] = useState('');
        const [house, setHouse] = useState('');
        const [error, setError] = useState('');
        const [loading, setLoading] = useState(false);

        const handleLogin = async (e) => {
          e.preventDefault();
          setError('');
          setLoading(true);

          const result = await dbService.authenticateUser(studentId, password);
          setLoading(false);

          if (result.success) {
            onLogin(result.user);
          } else {
            setError(result.message);
          }
        };

        const handleSignup = async (e) => {
          e.preventDefault();
          setError('');

          if (password.length < 8) {
            setError('Password must be at least 8 characters');
            return;
          }

          setLoading(true);
          const result = await dbService.createUser(studentId, username, password, yearGroup, house);
          setLoading(false);

          if (result.success) {
            onLogin(result.user);
          } else {
            setError(result.message);
          }
        };

        const handleGuestAccess = async () => {
          const settings = await dbService.getSettings();
          if (!settings.allowGuestAccess) {
            setError('Guest access is currently disabled');
            return;
          }

          const guestUser = await dbService.createGuestUser();
          onLogin(guestUser);
        };

        return (
          <div className="min-h-screen flex items-center justify-center p-4">
            <div className="max-w-md w-full space-y-8">
              <div className="text-center">
                <h2 className="text-4xl font-display font-bold text-white uppercase">
                  {mode === 'login' ? 'Access System' : 'Register'}
                </h2>
                <p className="mt-2 text-neutral-500 text-xs font-mono uppercase tracking-widest">
                  Secure Authentication
                </p>
              </div>

              <div className="glass-panel rounded-2xl p-8 space-y-6">
                {mode === 'login' ? (
                  <form onSubmit={handleLogin} className="space-y-4">
                    <input
                      type="text"
                      value={studentId}
                      onChange={(e) => setStudentId(e.target.value)}
                      placeholder="Student ID"
                      className="w-full bg-black/30 border border-white/10 rounded-xl p-4 text-white outline-none focus:border-white/20"
                      required
                    />
                    <input
                      type="password"
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      placeholder="Password"
                      className="w-full bg-black/30 border border-white/10 rounded-xl p-4 text-white outline-none focus:border-white/20"
                      required
                    />
                    {error && (
                      <div className="p-3 bg-red-950/20 text-red-400 text-xs font-bold text-center border border-red-900/40 rounded-xl">
                        {error}
                      </div>
                    )}
                    <button
                      type="submit"
                      disabled={loading}
                      className="w-full bg-brand-red text-white font-black py-4 rounded-xl uppercase tracking-widest text-xs hover:bg-red-600 transition-colors"
                    >
                      {loading ? 'Authenticating...' : 'Access'}
                    </button>
                  </form>
                ) : (
                  <form onSubmit={handleSignup} className="space-y-4">
                    <input
                      type="text"
                      value={studentId}
                      onChange={(e) => setStudentId(e.target.value)}
                      placeholder="Student ID"
                      className="w-full bg-black/30 border border-white/10 rounded-xl p-4 text-white outline-none focus:border-white/20"
                      required
                    />
                    <input
                      type="text"
                      value={username}
                      onChange={(e) => setUsername(e.target.value)}
                      placeholder="Username"
                      className="w-full bg-black/30 border border-white/10 rounded-xl p-4 text-white outline-none focus:border-white/20"
                      required
                    />
                    <input
                      type="password"
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      placeholder="Password (min 8 characters)"
                      className="w-full bg-black/30 border border-white/10 rounded-xl p-4 text-white outline-none focus:border-white/20"
                      required
                    />
                    <input
                      type="number"
                      value={yearGroup}
                      onChange={(e) => setYearGroup(e.target.value)}
                      placeholder="Year Group"
                      className="w-full bg-black/30 border border-white/10 rounded-xl p-4 text-white outline-none focus:border-white/20"
                      required
                    />
                    <input
                      type="text"
                      value={house}
                      onChange={(e) => setHouse(e.target.value)}
                      placeholder="House"
                      className="w-full bg-black/30 border border-white/10 rounded-xl p-4 text-white outline-none focus:border-white/20"
                      required
                    />
                    {error && (
                      <div className="p-3 bg-red-950/20 text-red-400 text-xs font-bold text-center border border-red-900/40 rounded-xl">
                        {error}
                      </div>
                    )}
                    <button
                      type="submit"
                      disabled={loading}
                      className="w-full bg-brand-red text-white font-black py-4 rounded-xl uppercase tracking-widest text-xs hover:bg-red-600 transition-colors"
                    >
                      {loading ? 'Creating Account...' : 'Register'}
                    </button>
                  </form>
                )}

                <div className="flex gap-2">
                  <button
                    onClick={() => setMode(mode === 'login' ? 'signup' : 'login')}
                    className="flex-1 text-neutral-500 hover:text-white text-xs font-bold uppercase tracking-widest transition-colors"
                  >
                    {mode === 'login' ? 'Create Account' : 'Back to Login'}
                  </button>
                  <button
                    onClick={handleGuestAccess}
                    className="flex-1 text-neutral-500 hover:text-white text-xs font-bold uppercase tracking-widest transition-colors"
                  >
                    Guest Access
                  </button>
                </div>

                <button
                  onClick={onBack}
                  className="w-full text-neutral-600 hover:text-neutral-400 text-xs font-mono uppercase tracking-widest transition-colors"
                >
                  ‚Üê Back
                </button>
              </div>
            </div>
          </div>
        );
      };

      // Password Change Component
      const PasswordChangeScreen = ({ user, onSuccess }) => {
        const [newPassword, setNewPassword] = useState('');
        const [confirmPassword, setConfirmPassword] = useState('');
        const [error, setError] = useState('');
        const [loading, setLoading] = useState(false);

        const handleSubmit = async (e) => {
          e.preventDefault();
          setError('');

          if (newPassword.length < 8) {
            setError('Password must be at least 8 characters');
            return;
          }

          if (newPassword !== confirmPassword) {
            setError('Passwords do not match');
            return;
          }

          setLoading(true);
          await dbService.updatePassword(user.studentId, newPassword);
          setLoading(false);
          onSuccess();
        };

        return (
          <div className="min-h-screen bg-[#020202] flex items-center justify-center p-4">
            <div className="max-w-md w-full bg-[#080808] border border-red-900/40 rounded-3xl p-10 shadow-[0_0_50px_rgba(220,38,38,0.2)]">
              <div className="flex justify-center mb-6">
                <div className="w-16 h-16 rounded-full bg-red-900/20 flex items-center justify-center animate-pulse">
                  <svg className="w-8 h-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                  </svg>
                </div>
              </div>

              <h2 className="text-2xl font-display font-bold text-white text-center mb-2 uppercase">
                Security Reset Required
              </h2>
              <p className="text-center text-neutral-500 text-[10px] font-mono uppercase tracking-widest mb-8">
                Please set a new secure password
              </p>

              <form onSubmit={handleSubmit} className="space-y-4">
                <input
                  type="password"
                  value={newPassword}
                  onChange={(e) => setNewPassword(e.target.value)}
                  placeholder="New Password"
                  className="w-full bg-[#111] border border-[#222] rounded-xl p-4 text-white font-mono placeholder-neutral-700 outline-none focus:border-brand-red"
                  required
                />
                <input
                  type="password"
                  value={confirmPassword}
                  onChange={(e) => setConfirmPassword(e.target.value)}
                  placeholder="Confirm Password"
                  className="w-full bg-[#111] border border-[#222] rounded-xl p-4 text-white font-mono placeholder-neutral-700 outline-none focus:border-brand-red"
                  required
                />
                {error && (
                  <div className="p-3 bg-red-950/20 text-red-400 text-xs font-bold text-center border border-red-900/40 rounded-xl">
                    {error}
                  </div>
                )}
                <button
                  type="submit"
                  disabled={loading}
                  className="w-full bg-brand-red text-white font-black py-4 rounded-xl uppercase tracking-widest text-xs hover:bg-red-600 transition-colors shadow-2xl"
                >
                  {loading ? 'Updating...' : 'Set New Password'}
                </button>
              </form>
            </div>
          </div>
        );
      };

      // Sidebar Component
      const Sidebar = ({ user, activeTab, onTabChange, onLogout }) => {
        const tabs = [
          { id: 'dashboard', label: 'Dashboard', icon: 'üìä' },
          { id: 'feed', label: 'Feed', icon: 'üì°' },
          { id: 'focus', label: 'Focus Timer', icon: '‚è±Ô∏è' },
          { id: 'gallery', label: 'Gallery', icon: 'üé®' },
          { id: 'leaderboard', label: 'Leaderboard', icon: 'üèÜ' },
          { id: 'council', label: 'Council', icon: 'üîí' },
          { id: 'guide', label: 'Guide', icon: 'üìñ' },
          { id: 'settings', label: 'Settings', icon: '‚öôÔ∏è' }
        ];

        if (user.isAdmin) {
          tabs.push({ id: 'admin', label: 'Admin', icon: 'üëë' });
        }

        return (
          <aside className="fixed left-0 top-0 h-screen w-72 bg-[#0a0a0a] border-r border-white/5 p-6 overflow-y-auto z-50 hidden md:block">
            <div className="mb-10">
              <h1 className="text-3xl font-display font-black text-gradient-gold uppercase">Spades</h1>
              <p className="text-neutral-600 text-[10px] font-mono uppercase tracking-widest mt-1">
                v2.0 Secure
              </p>
            </div>

            <div className="mb-8 p-4 glass-panel rounded-xl">
              <div className="flex items-center gap-3 mb-3">
                <RankCard rankId={user.currentCard} size="sm" />
                <div>
                  <div className="text-white font-bold text-sm">{user.username}</div>
                  <div className="text-neutral-500 text-[10px] font-mono">{user.currentRank}</div>
                </div>
              </div>
              <div className="text-xs text-neutral-400">
                <div className="flex justify-between">
                  <span>Points:</span>
                  <span className="text-brand-gold font-bold">{user.totalPoints?.toLocaleString()}</span>
                </div>
                <div className="flex justify-between mt-1">
                  <span>Spades:</span>
                  <span className="text-brand-red font-bold">{user.spadesBalance}</span>
                </div>
              </div>
            </div>

            <nav className="space-y-2">
              {tabs.map(tab => (
                <button
                  key={tab.id}
                  onClick={() => onTabChange(tab.id)}
                  className={`w-full text-left px-4 py-3 rounded-xl font-bold text-sm uppercase tracking-wide transition-all ${
                    activeTab === tab.id
                      ? 'bg-brand-red text-white shadow-lg'
                      : 'text-neutral-500 hover:text-white hover:bg-white/5'
                  }`}
                >
                  <span className="mr-3">{tab.icon}</span>
                  {tab.label}
                </button>
              ))}
            </nav>

            <button
              onClick={onLogout}
              className="w-full mt-8 px-4 py-3 rounded-xl font-bold text-sm uppercase tracking-wide text-neutral-600 hover:text-red-500 hover:bg-red-950/20 transition-all"
            >
              Logout
            </button>
          </aside>
        );
      };

      // Dashboard Component
      const Dashboard = ({ user }) => {
        const currentRankIndex = RANK_ORDER.indexOf(user.currentCard);
        const nextRank = currentRankIndex < RANK_ORDER.length - 1 ? RANK_ORDER[currentRankIndex + 1] : null;
        const nextRankPoints = nextRank ? RANK_CONFIG[nextRank].minPoints : 0;
        const progress = nextRank ? ((user.totalPoints - RANK_CONFIG[user.currentCard].minPoints) / (nextRankPoints - RANK_CONFIG[user.currentCard].minPoints)) * 100 : 100;

        return (
          <div className="space-y-8 animate-in fade-in">
            <div>
              <h1 className="text-4xl font-display font-black text-white uppercase">Dashboard</h1>
              <p className="text-neutral-500 text-sm font-mono mt-2">Welcome back, {user.username}</p>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div className="glass-panel rounded-2xl p-6 border border-white/5">
                <div className="text-neutral-500 text-xs font-mono uppercase tracking-widest mb-2">Total Points</div>
                <div className="text-3xl font-black text-brand-gold">{user.totalPoints?.toLocaleString()}</div>
              </div>
              <div className="glass-panel rounded-2xl p-6 border border-white/5">
                <div className="text-neutral-500 text-xs font-mono uppercase tracking-widest mb-2">Spades Balance</div>
                <div className="text-3xl font-black text-brand-red">{user.spadesBalance}</div>
              </div>
              <div className="glass-panel rounded-2xl p-6 border border-white/5">
                <div className="text-neutral-500 text-xs font-mono uppercase tracking-widest mb-2">Current Streak</div>
                <div className="text-3xl font-black text-white">{user.streak} days</div>
              </div>
            </div>

            {nextRank && (
              <div className="glass-panel rounded-2xl p-6 border border-white/5">
                <div className="flex justify-between items-center mb-4">
                  <div>
                    <div className="text-white font-bold text-lg">Rank Progress</div>
                    <div className="text-neutral-500 text-sm">Next: {RANK_CONFIG[nextRank].name}</div>
                  </div>
                  <div className="text-brand-gold font-black text-2xl">{Math.floor(progress)}%</div>
                </div>
                <div className="w-full bg-black/50 rounded-full h-4 overflow-hidden">
                  <div 
                    className="h-full bg-gradient-to-r from-brand-gold to-brand-red transition-all duration-500"
                    style={{ width: `${Math.min(progress, 100)}%` }}
                  ></div>
                </div>
                <div className="text-neutral-600 text-xs mt-2">
                  {user.totalPoints.toLocaleString()} / {nextRankPoints.toLocaleString()} points
                </div>
              </div>
            )}

            <div className="glass-panel rounded-2xl p-6 border border-white/5">
              <h2 className="text-xl font-display font-bold text-white mb-4 uppercase">Statistics</h2>
              <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                <div>
                  <div className="text-neutral-500 text-xs">Posts Created</div>
                  <div className="text-white font-bold text-xl">{user.stats?.postsCreated || 0}</div>
                </div>
                <div>
                  <div className="text-neutral-500 text-xs">Comments</div>
                  <div className="text-white font-bold text-xl">{user.stats?.commentsCreated || 0}</div>
                </div>
                <div>
                  <div className="text-neutral-500 text-xs">Study Minutes</div>
                  <div className="text-white font-bold text-xl">{user.stats?.minutesStudied || 0}</div>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // Feed Component (Simplified)
      const Feed = ({ currentUser, refreshTrigger, onActivity }) => {
        const [posts, setPosts] = useState([]);
        const [postContent, setPostContent] = useState('');
        const [loading, setLoading] = useState(false);
        const [feedType, setFeedType] = useState('public');

        useEffect(() => {
          loadPosts();
        }, [refreshTrigger, feedType]);

        const loadPosts = async () => {
          const allPosts = await dbService.getPosts();
          const filtered = feedType === 'public' 
            ? allPosts.filter(p => p.category !== 'ticket')
            : allPosts.filter(p => p.category === 'ticket' && (currentUser.isAdmin || p.authorId === currentUser.studentId));
          setPosts(filtered);
        };

        const handlePost = async () => {
          if (!postContent.trim()) return;
          setLoading(true);

          const sanitized = ContentModerator.sanitizeText(postContent);
          const safetyCheck = await ContentModerator.checkContent(sanitized);

          const newPost = {
            id: `post-${Date.now()}`,
            authorId: currentUser.studentId,
            authorName: currentUser.username,
            authorRank: currentUser.currentCard,
            content: sanitized,
            category: feedType === 'public' ? 'general' : 'ticket',
            status: safetyCheck.safe ? 'approved' : 'flagged',
            upvotes: [],
            downvotes: [],
            comments: [],
            createdAt: new Date().toISOString()
          };

          await dbService.savePost(newPost);
          await dbService.saveUser({
            ...currentUser,
            totalPoints: currentUser.totalPoints + POINTS_CONFIG.POST,
            stats: {
              ...currentUser.stats,
              postsCreated: (currentUser.stats?.postsCreated || 0) + 1
            }
          });

          setPostContent('');
          setLoading(false);
          loadPosts();
          onActivity();
        };

        const handleDelete = async (postId) => {
          await dbService.deletePost(postId);
          loadPosts();
          onActivity();
        };

        return (
          <div className="max-w-3xl mx-auto space-y-8 pb-32 animate-in fade-in">
            <div className="flex bg-black border border-white/10 rounded-xl p-1">
              <button
                onClick={() => setFeedType('public')}
                className={`flex-1 py-3 text-xs font-bold uppercase tracking-widest rounded-lg transition-all ${
                  feedType === 'public' ? 'bg-white text-black shadow-lg' : 'text-neutral-500 hover:text-white'
                }`}
              >
                Public Feed
              </button>
              <button
                onClick={() => setFeedType('council')}
                className={`flex-1 py-3 text-xs font-bold uppercase tracking-widest rounded-lg transition-all ${
                  feedType === 'council' ? 'bg-emerald-900/50 text-emerald-400 border border-emerald-500/50' : 'text-neutral-500 hover:text-emerald-500'
                }`}
              >
                Council Tickets
              </button>
            </div>

            <div className="glass-panel rounded-2xl border border-white/5 p-6">
              <textarea
                value={postContent}
                onChange={(e) => setPostContent(e.target.value)}
                placeholder={feedType === 'public' ? 'Share your thoughts...' : 'Submit a ticket...'}
                className="w-full bg-black/30 border border-white/10 rounded-xl p-4 text-sm text-white outline-none h-24 resize-none focus:border-white/20"
              />
              <div className="flex justify-end mt-4">
                <button
                  onClick={handlePost}
                  disabled={loading}
                  className="px-6 py-2 text-white text-xs font-bold uppercase rounded-lg shadow-lg bg-brand-red hover:bg-brand-red/80"
                >
                  {loading ? '...' : 'Post'}
                </button>
              </div>
            </div>

            <div className="space-y-6">
              {posts.map(post => (
                <div key={post.id} className="glass-panel border border-white/5 rounded-2xl p-6 relative group">
                  {(currentUser.isAdmin || post.authorId === currentUser.studentId) && (
                    <button
                      onClick={() => handleDelete(post.id)}
                      className="absolute top-4 right-4 p-2 bg-black hover:bg-red-500 text-neutral-500 hover:text-white rounded-lg transition-all border border-white/10"
                    >
                      <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                    </button>
                  )}
                  <div className="flex items-center gap-4 mb-4">
                    <RankCard rankId={post.authorRank} size="sm" />
                    <div>
                      <div className="font-bold text-sm text-white">{post.authorName}</div>
                      <div className="text-[10px] text-neutral-600 font-mono">
                        {new Date(post.createdAt).toLocaleDateString()}
                      </div>
                    </div>
                  </div>
                  <p className="text-neutral-300 text-sm font-light leading-relaxed whitespace-pre-wrap">
                    {post.content}
                  </p>
                </div>
              ))}
              {posts.length === 0 && (
                <div className="text-center py-20 text-neutral-600 font-mono text-sm border-2 border-dashed border-white/5 rounded-2xl">
                  No posts yet
                </div>
              )}
            </div>
          </div>
        );
      };

      // Placeholder Components (simplified versions)
      const FocusTimer = () => (
        <div className="text-center py-20">
          <h2 className="text-3xl font-display font-bold text-white uppercase mb-4">Focus Timer</h2>
          <p className="text-neutral-500">Focus timer feature coming soon</p>
        </div>
      );

      const Gallery = () => (
        <div className="text-center py-20">
          <h2 className="text-3xl font-display font-bold text-white uppercase mb-4">Gallery</h2>
          <p className="text-neutral-500">Art gallery feature coming soon</p>
        </div>
      );

      const Leaderboard = () => (
        <div className="text-center py-20">
          <h2 className="text-3xl font-display font-bold text-white uppercase mb-4">Leaderboard</h2>
          <p className="text-neutral-500">Leaderboard feature coming soon</p>
        </div>
      );

      const Council = () => (
        <div className="text-center py-20">
          <h2 className="text-3xl font-display font-bold text-white uppercase mb-4">Council</h2>
          <p className="text-neutral-500">Council feature coming soon</p>
        </div>
      );

      const Guide = () => (
        <div className="text-center py-20">
          <h2 className="text-3xl font-display font-bold text-white uppercase mb-4">Guide</h2>
          <p className="text-neutral-500">Platform guide coming soon</p>
        </div>
      );

      const Settings = ({ currentUser, onUpdate }) => (
        <div className="max-w-2xl mx-auto space-y-8">
          <h2 className="text-3xl font-display font-bold text-white uppercase">Settings</h2>
          <div className="glass-panel rounded-2xl p-6 border border-white/5">
            <p className="text-neutral-400">Settings panel coming soon</p>
          </div>
        </div>
      );

      const AdminPanel = () => (
        <div className="text-center py-20">
          <h2 className="text-3xl font-display font-bold text-white uppercase mb-4">Admin Panel</h2>
          <p className="text-neutral-500">Admin features coming soon</p>
        </div>
      );

      // Main App Component
      const App = () => {
        const [currentUser, setCurrentUser] = useState(null);
        const [appState, setAppState] = useState('portfolio');
        const [activeTab, setActiveTab] = useState('dashboard');
        const [refreshTrigger, setRefreshTrigger] = useState(0);

        const checkAndUpgradeRank = useCallback(async (user) => {
          const currentIndex = RANK_ORDER.indexOf(user.currentCard);
          let newIndex = 0;
          
          for (let i = 0; i < RANK_ORDER.length; i++) {
            if (user.totalPoints >= RANK_CONFIG[RANK_ORDER[i]].minPoints) {
              newIndex = i;
            }
          }

          if (newIndex > currentIndex) {
            const newCard = RANK_ORDER[newIndex];
            const updatedUser = {
              ...user,
              currentCard: newCard,
              currentRank: RANK_CONFIG[newCard].name
            };
            await dbService.saveUser(updatedUser);
            setCurrentUser(updatedUser);
          } else {
            setCurrentUser(user);
          }
        }, []);

        const refreshUser = useCallback(async () => {
          const userId = localStorage.getItem('session_user_id');
          if (!userId) return;

          const user = await dbService.getUser(userId);
          if (user) {
            if (user.isBanned) {
              handleLogout();
            } else {
              checkAndUpgradeRank(user);
              setRefreshTrigger(prev => prev + 1);
            }
          }
        }, [checkAndUpgradeRank]);

        useEffect(() => {
          const userId = localStorage.getItem('session_user_id');
          if (userId) {
            dbService.getUser(userId).then(user => {
              if (user) {
                if (user.isBanned) {
                  handleLogout();
                } else {
                  setCurrentUser(user);
                  setAppState('app');
                  checkAndUpgradeRank(user);
                }
              }
            });
          }
        }, [checkAndUpgradeRank]);

        const handleLogin = (user) => {
          localStorage.setItem('session_user_id', user.studentId);
          setCurrentUser(user);
          setAppState('app');
          checkAndUpgradeRank(user);
        };

        const handleLogout = () => {
          localStorage.removeItem('session_user_id');
          setCurrentUser(null);
          setAppState('portfolio');
        };

        if (appState === 'portfolio') {
          return <LandingPage onEnterSystem={() => setAppState('auth')} />;
        }

        if (appState === 'auth' && !currentUser) {
          return <AuthPage onLogin={handleLogin} onBack={() => setAppState('portfolio')} />;
        }

        if (currentUser) {
          if (currentUser.requiresPasswordChange && !currentUser.isGuest) {
            return <PasswordChangeScreen user={currentUser} onSuccess={refreshUser} />;
          }

          return (
            <div className="min-h-screen bg-[#020202] text-neutral-100 flex font-sans">
              <Sidebar 
                user={currentUser} 
                activeTab={activeTab} 
                onTabChange={setActiveTab} 
                onLogout={handleLogout} 
              />
              <main className="flex-1 md:ml-72 p-4 md:p-10 overflow-x-hidden relative">
                <div className="max-w-6xl mx-auto mt-20 md:mt-0 relative z-10">
                  {activeTab === 'dashboard' && <Dashboard user={currentUser} />}
                  {activeTab === 'feed' && <Feed currentUser={currentUser} refreshTrigger={refreshTrigger} onActivity={refreshUser} />}
                  {activeTab === 'focus' && <FocusTimer />}
                  {activeTab === 'gallery' && <Gallery />}
                  {activeTab === 'leaderboard' && <Leaderboard />}
                  {activeTab === 'council' && <Council />}
                  {activeTab === 'guide' && <Guide />}
                  {activeTab === 'settings' && <Settings currentUser={currentUser} onUpdate={refreshUser} />}
                  {activeTab === 'admin' && currentUser.isAdmin && <AdminPanel />}
                </div>
              </main>
            </div>
          );
        }

        return <LandingPage onEnterSystem={() => setAppState('auth')} />;
      };

      // Initialize and render
      dbService.init().then(() => {
        const root = document.getElementById('root');
        if (!root) throw new Error('Failed to find root element');
        ReactDOM.createRoot(root).render(<App />);
      });
    </script>
  </body>
</html>

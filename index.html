<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Spades Protocol</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script>tailwind.config={darkMode:'class',theme:{extend:{fontFamily:{sans:['Inter','sans-serif'],display:['Outfit','sans-serif'],mono:['JetBrains Mono','monospace']},colors:{brand:{obsidian:'#050505',charcoal:'#0a0a0a',card:'#121212',red:'#d92323',deepRed:'#500808',gold:'#e2b15b',goldDim:'#8a6d3b'}},animation:{'pulse-slow':'pulse 8s cubic-bezier(0.4,0,0.6,1) infinite','float':'float 10s ease-in-out infinite','shine':'shine 6s linear infinite','shimmer':'shimmer 3s ease-in-out infinite alternate','glow':'glow 4s ease-in-out infinite alternate'},keyframes:{float:{'0%,100%':{transform:'translateY(0)'},'50%':{transform:'translateY(-15px)'}},shine:{'0%':{backgroundPosition:'200% center'},'100%':{backgroundPosition:'-200% center'}},shimmer:{'0%':{opacity:0.5},'100%':{opacity:1}},glow:{'0%':{boxShadow:'0 0 10px rgba(217,35,35,0.1)'},'100%':{boxShadow:'0 0 30px rgba(217,35,35,0.3), 0 0 15px rgba(226,177,91,0.1)'}}}}}}</script>
<style>
body{background-color:#020202;color:#f5f5f5;overflow-x:hidden;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
.cinematic-bg{position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:-1;background:radial-gradient(circle at 50% -20%,#1a0505 0%,#020202 50%);pointer-events:none}
.noise-overlay{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;opacity:0.04;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");pointer-events:none;mix-blend-mode:overlay}
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:#020202}
::-webkit-scrollbar-thumb{background:#333;border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:#d92323}
.glass-panel{background:rgba(10,10,10,0.6);backdrop-filter:blur(24px) saturate(180%);-webkit-backdrop-filter:blur(24px) saturate(180%);border:1px solid rgba(255,255,255,0.05);box-shadow:0 8px 32px 0 rgba(0,0,0,0.3)}
.glass-card-hover{transition:all 0.5s cubic-bezier(0.2,0.8,0.2,1)}
.glass-card-hover:hover{background:rgba(20,20,20,0.8);border-color:rgba(255,255,255,0.1);transform:translateY(-4px);box-shadow:0 20px 60px rgba(0,0,0,0.7)}
.text-gradient-gold{background:linear-gradient(135deg,#fceeb5 0%,#e2b15b 50%,#8a6d3b 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-size:100% auto}
.text-gradient-red{background:linear-gradient(135deg,#ff8080 0%,#d92323 60%,#500808 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
</style>
</head>
<body>
<div class="cinematic-bg"></div>
<div class="noise-overlay"></div>
<div id="root"></div>
<script type="module">
// SPADES PROTOCOL - SINGLE FILE VERSION WITH FIREBASE
import {initializeApp} from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import {getFirestore,collection,doc,getDoc,getDocs,setDoc,updateDoc,deleteDoc,query,orderBy,writeBatch,increment} from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
import React from 'https://esm.sh/react@18.2.0';
import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
const {useState,useEffect,useCallback,useRef,useMemo}=React;
const firebaseConfig={apiKey:"AIzaSyBYfyPC_PEejSVytCmgljnKQ2HUSROlIFc",authDomain:"spades-c87ee.firebaseapp.com",projectId:"spades-c87ee",storageBucket:"spades-c87ee.firebasestorage.app",messagingSenderId:"930924627451",appId:"1:930924627451:web:99576f0d2d88f508e6375e",measurementId:"G-X49C6SCGGW"};
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const RANKS={"2â™ ":{id:"2â™ ",name:"2 of Spades",minPoints:0,maxPoints:199,tier:"Prospect",permissions:["view","vote"],voteWeight:1},"3â™ ":{id:"3â™ ",name:"3 of Spades",minPoints:200,maxPoints:499,tier:"Initiate",permissions:["view","vote","post","comment"],voteWeight:1},"4â™ ":{id:"4â™ ",name:"4 of Spades",minPoints:500,maxPoints:999,tier:"Member",permissions:["view","vote","post","comment"],voteWeight:1},"5â™ ":{id:"5â™ ",name:"5 of Spades",minPoints:1000,maxPoints:2499,tier:"Active",permissions:["view","vote","post","comment"],voteWeight:1},"6â™ ":{id:"6â™ ",name:"6 of Spades",minPoints:2500,maxPoints:4999,tier:"Contributor",permissions:["view","vote","post","comment","createPoll","award"],voteWeight:2},"7â™ ":{id:"7â™ ",name:"7 of Spades",minPoints:5000,maxPoints:7999,tier:"Collaborator",permissions:["view","vote","post","comment","createPoll","award"],voteWeight:2},"8â™ ":{id:"8â™ ",name:"8 of Spades",minPoints:8000,maxPoints:11999,tier:"Advocate",permissions:["view","vote","post","comment","createPoll","award"],voteWeight:2},"9â™ ":{id:"9â™ ",name:"9 of Spades",minPoints:12000,maxPoints:17999,tier:"Scholar",permissions:["view","vote","post","comment","createPoll","award","submitPolicy","communityHub"],voteWeight:5},"10â™ ":{id:"10â™ ",name:"10 of Spades",minPoints:18000,maxPoints:24999,tier:"Architect",permissions:["view","vote","post","comment","createPoll","award","submitPolicy","communityHub"],voteWeight:5},"Jâ™ ":{id:"Jâ™ ",name:"Jack of Spades",minPoints:25000,maxPoints:34999,tier:"Voice",permissions:["view","vote","post","comment","createPoll","award","submitPolicy","communityHub","instantPost","nominate"],voteWeight:10},"Qâ™ ":{id:"Qâ™ ",name:"Queen of Spades",minPoints:35000,maxPoints:49999,tier:"Advisor",permissions:["view","vote","post","comment","createPoll","award","submitPolicy","communityHub","instantPost","nominate","moderate","messageCouncil"],voteWeight:25},"Kâ™ ":{id:"Kâ™ ",name:"King of Spades",minPoints:50000,maxPoints:74999,tier:"Council",permissions:["view","vote","post","comment","createPoll","award","submitPolicy","communityHub","instantPost","nominate","moderate","messageCouncil","messageAce","createChallenge","finalModeration"],voteWeight:50},"Aâ™ ":{id:"Aâ™ ",name:"Ace of Spades",minPoints:75000,maxPoints:9999999,tier:"System Ace",permissions:["all"],voteWeight:100}};
const ECONOMY={SPADE_TO_POINT_CONVERSION:5000,POINT_TO_SPADE_CONVERSION:10000,STREAK_FREEZE_POINT_COST:5000,MAX_STREAK_FREEZES:2};
const POINT_VALUES={POST:5,COMMENT:2,VOTE_ACTION:10,LOGIN:20,FOCUS_MINUTE:2};
const HOUSES=['Phoenix','Dragon','Griffin','Raven'];
class FirebaseStorage{
async getUser(studentId){try{const docRef=doc(db,'users',studentId);const docSnap=await getDoc(docRef);return docSnap.exists()?docSnap.data():null;}catch(e){console.error('Error:',e);return null;}}
async userExists(studentId){return!!(await this.getUser(studentId));}
async saveUser(user){try{await setDoc(doc(db,'users',user.studentId),user);}catch(e){console.error('Error:',e);}}
async deleteUser(studentId){try{await deleteDoc(doc(db,'users',studentId));}catch(e){console.error('Error:',e);}}
async updatePassword(studentId,newPass){try{await updateDoc(doc(db,'users',studentId),{passwordHash:newPass,requiresPasswordChange:false});}catch(e){console.error('Error:',e);}}
async updateUserStatus(studentId,updates){try{await updateDoc(doc(db,'users',studentId),updates);}catch(e){console.error('Error:',e);}}
async convertCurrency(studentId,amount,direction){try{const user=await this.getUser(studentId);if(!user)return{success:false,message:"User not found."};if(direction==='p2s'){const cost=amount*ECONOMY.POINT_TO_SPADE_CONVERSION;if(user.totalPoints<cost)return{success:false,message:`Insufficient Points. Need ${cost.toLocaleString()} P.`};await updateDoc(doc(db,'users',studentId),{totalPoints:user.totalPoints-cost,spadesBalance:user.spadesBalance+amount});}else{if(user.spadesBalance<amount)return{success:false,message:"Insufficient Spades."};await updateDoc(doc(db,'users',studentId),{spadesBalance:user.spadesBalance-amount,totalPoints:user.totalPoints+(amount*ECONOMY.SPADE_TO_POINT_CONVERSION)});}return{success:true,message:"Conversion complete."};}catch(e){console.error('Error:',e);return{success:false,message:"Error occurred."};}}
async processLoginStreak(studentId){try{const user=await this.getUser(studentId);if(!user)return;const now=new Date();const today=new Date(now.getFullYear(),now.getMonth(),now.getDate()).toISOString();const lastLogin=user.lastLoginDate?new Date(user.lastLoginDate):null;let newStreak=user.streak||1;let newFreezes=user.streakFreezes||0;if(lastLogin){const lastLoginMidnight=new Date(lastLogin.getFullYear(),lastLogin.getMonth(),lastLogin.getDate());const diffTime=now.getTime()-lastLoginMidnight.getTime();const diffDays=Math.floor(diffTime/(1000*60*60*24));if(diffDays===0){}else if(diffDays===1){newStreak+=1;}else{if(newFreezes>0){newFreezes-=1;}else{newStreak=1;}}}else{newStreak=1;}await updateDoc(doc(db,'users',studentId),{streak:newStreak,streakFreezes:newFreezes,lastLoginDate:today});}catch(e){console.error('Error:',e);}}
async purchaseStreakFreeze(studentId){try{const user=await this.getUser(studentId);if(!user)return{success:false,message:"User not found."};if(user.streakFreezes>=ECONOMY.MAX_STREAK_FREEZES)return{success:false,message:"Maximum freezes equipped."};if(user.totalPoints<ECONOMY.STREAK_FREEZE_POINT_COST)return{success:false,message:`Need ${ECONOMY.STREAK_FREEZE_POINT_COST.toLocaleString()} P.`};await updateDoc(doc(db,'users',studentId),{totalPoints:user.totalPoints-ECONOMY.STREAK_FREEZE_POINT_COST,streakFreezes:user.streakFreezes+1});return{success:true,message:"Streak Freeze equipped."};}catch(e){console.error('Error:',e);return{success:false,message:"Error occurred."};}}
async getAllUsers(){try{const querySnapshot=await getDocs(collection(db,'users'));return querySnapshot.docs.map(doc=>doc.data());}catch(e){console.error('Error:',e);return[];}}
async getPosts(){try{const q=query(collection(db,'posts'),orderBy('createdAt','desc'));const querySnapshot=await getDocs(q);return querySnapshot.docs.map(doc=>doc.data());}catch(e){console.error('Error:',e);return[];}}
async savePost(post){try{await setDoc(doc(db,'posts',post.id),post);}catch(e){console.error('Error:',e);}}
async deletePost(postId){try{await deleteDoc(doc(db,'posts',postId));}catch(e){console.error('Error:',e);}}
async deleteComment(postId,commentId){try{const postDoc=await getDoc(doc(db,'posts',postId));if(postDoc.exists()){const post=postDoc.data();const updatedComments=post.comments.filter(c=>c.id!==commentId);await updateDoc(doc(db,'posts',postId),{comments:updatedComments});}}catch(e){console.error('Error:',e);}}
async getArtPieces(){try{const q=query(collection(db,'artPieces'),orderBy('createdAt','desc'));const querySnapshot=await getDocs(q);return querySnapshot.docs.map(doc=>doc.data());}catch(e){console.error('Error:',e);return[];}}
async uploadArt(art){try{await setDoc(doc(db,'artPieces',art.id),art);}catch(e){console.error('Error:',e);}}
async deleteArt(artId){try{await deleteDoc(doc(db,'artPieces',artId));}catch(e){console.error('Error:',e);}}
async purchaseArt(studentId,artId,currency){try{const user=await this.getUser(studentId);const artDoc=await getDoc(doc(db,'artPieces',artId));if(!user)return{success:false,message:"User not found."};if(!artDoc.exists())return{success:false,message:"Asset not found."};const art=artDoc.data();if(art.ownerId)return{success:false,message:"Asset already owned."};let price=0;if(currency==='points'){if(!art.allowPoints)return{success:false,message:"Points not accepted."};if(user.totalPoints<art.price)return{success:false,message:"Insufficient points."};price=art.price;}else{if(!art.allowSpades)return{success:false,message:"Spades not accepted."};if(user.spadesBalance<art.spadesPrice)return{success:false,message:"Insufficient Spades."};price=art.spadesPrice;}const batch=writeBatch(db);const newInventory=[...(user.inventory||[]),art.id];const userUpdate=currency==='points'?{totalPoints:user.totalPoints-price,inventory:newInventory}:{spadesBalance:user.spadesBalance-price,inventory:newInventory};batch.update(doc(db,'users',studentId),userUpdate);batch.update(doc(db,'artPieces',artId),{ownerId:user.studentId,ownerName:user.username});const log={id:`req-${Date.now()}`,buyerId:user.studentId,buyerName:user.username,artId:art.id,artTitle:art.title,price:price,currencyUsed:currency,timestamp:new Date().toISOString(),delivered:false};batch.set(doc(db,'purchaseLogs',log.id),log);await batch.commit();return{success:true,message:"Asset secured."};}catch(e){console.error('Error:',e);return{success:false,message:"Error occurred."};}}
async getPurchaseLogs(){try{const q=query(collection(db,'purchaseLogs'),orderBy('timestamp','desc'));const querySnapshot=await getDocs(q);return querySnapshot.docs.map(doc=>doc.data());}catch(e){console.error('Error:',e);return[];}}
async markDelivered(logId){try{await updateDoc(doc(db,'purchaseLogs',logId),{delivered:true});}catch(e){console.error('Error:',e);}}
async getSettings(){try{const docRef=doc(db,'systemSettings','settings');const docSnap=await getDoc(docRef);return docSnap.exists()?docSnap.data():{minRankToPost:'2â™ ',allowPublicSignups:true,allowGuestAccess:true,emergencyLockdown:false};}catch(e){console.error('Error:',e);return{minRankToPost:'2â™ ',allowPublicSignups:true,allowGuestAccess:true,emergencyLockdown:false};}}
async updateSettings(updates){try{const current=await this.getSettings();await setDoc(doc(db,'systemSettings','settings'),{...current,...updates});}catch(e){console.error('Error:',e);}}
async init(){try{const adminRef=doc(db,'users','ace of spades');const adminSnap=await getDoc(adminRef);if(!adminSnap.exists()){const admin={studentId:'ace of spades',username:'ace of spades',passwordHash:'ayanokoji',currentRank:'Ace of Spades',currentCard:'Aâ™ ',totalPoints:50000,spadesBalance:100,streak:1,streakFreezes:0,lastLoginDate:new Date().toISOString(),joinDate:new Date().toISOString(),lastActive:new Date().toISOString(),yearGroup:13,house:'Phoenix',stats:{postsCreated:0,commentsCreated:0,votesGiven:0,resourcesShared:0,moderationsPerformed:0,minutesStudied:0},isAdmin:true,requiresPasswordChange:true,inventory:[]};await setDoc(adminRef,admin);}const settingsRef=doc(db,'systemSettings','settings');const settingsSnap=await getDoc(settingsRef);if(!settingsSnap.exists()){await setDoc(settingsRef,{minRankToPost:'2â™ ',allowPublicSignups:true,allowGuestAccess:true,emergencyLockdown:false});}}catch(e){console.error('Error:',e);}}
}
const storage=new FirebaseStorage();
const getRankFromPoints=(points)=>{const rankIds=['2â™ ','3â™ ','4â™ ','5â™ ','6â™ ','7â™ ','8â™ ','9â™ ','10â™ ','Jâ™ ','Qâ™ ','Kâ™ ','Aâ™ '];for(const id of rankIds){const rank=RANKS[id];if(points>=rank.minPoints&&points<=rank.maxPoints)return rank;}return RANKS['2â™ '];};
const formatDate=(dateStr)=>{if(!dateStr)return'N/A';const date=new Date(dateStr);const now=new Date();const diffMs=now-date;const diffMins=Math.floor(diffMs/60000);const diffHours=Math.floor(diffMs/3600000);const diffDays=Math.floor(diffMs/86400000);if(diffMins<1)return'Just now';if(diffMins<60)return`${diffMins}m ago`;if(diffHours<24)return`${diffHours}h ago`;if(diffDays<7)return`${diffDays}d ago`;return date.toLocaleDateString();};
// Component: Sidebar

interface SidebarProps {
  activeTab: AppTab;
  onTabChange: (tab: AppTab) => void;
}

const Sidebar: React.FC<SidebarProps> = ({ activeTab, onTabChange }) => {
  const tabs = [
    { id: AppTab.CHAT, label: 'Intelligent Chat', icon: 'fa-comment-alt' },
    { id: AppTab.STUDIO, label: 'Media Studio', icon: 'fa-photo-video' },
    { id: AppTab.LIVE, label: 'Live Interaction', icon: 'fa-microphone-lines' },
    { id: AppTab.SETTINGS, label: 'Settings', icon: 'fa-cog' },
  ];

  return (
    <div className="flex flex-col h-full glass border-r border-white/5 p-4">
      <div className="flex items-center gap-3 mb-10 px-2">
        <div className="w-10 h-10 rounded-xl bg-gradient-to-tr from-blue-600 via-purple-600 to-pink-600 flex items-center justify-center shadow-lg shadow-purple-900/20">
          <i className="fas fa-sparkles text-white text-lg"></i>
        </div>
        <div>
          <h1 className="font-bold text-xl tracking-tight">Gemini Hub</h1>
          <p className="text-[10px] text-gray-500 uppercase tracking-widest font-semibold">Pro Studio</p>
        </div>
      </div>

      <nav className="space-y-2 flex-1">
        {tabs.map((tab) => (
          <button
            key={tab.id}
            onClick={() => onTabChange(tab.id)}
            className={`
              w-full flex items-center gap-4 px-4 py-3 rounded-xl transition-all duration-200 group
              ${activeTab === tab.id 
                ? 'bg-gradient-to-r from-blue-600/10 to-purple-600/10 text-blue-400 border border-blue-500/20 shadow-inner' 
                : 'text-gray-400 hover:bg-white/5 hover:text-white border border-transparent'}
            `}
          >
            <i className={`fas ${tab.icon} w-5 text-center group-hover:scale-110 transition-transform`}></i>
            <span className="font-medium">{tab.label}</span>
          </button>
        ))}
      </nav>

      <div className="mt-auto space-y-4">
        <div className="p-4 glass rounded-2xl border-white/5 space-y-3">
          <div className="flex items-center justify-between text-xs">
            <span className="text-gray-500">API Usage</span>
            <span className="text-gray-400 font-medium">82%</span>
          </div>
          <div className="w-full bg-white/5 h-1.5 rounded-full overflow-hidden">
            <div className="bg-gradient-to-r from-blue-500 to-purple-500 h-full w-[82%]"></div>
          </div>
          <p className="text-[10px] text-gray-500">Upgrade to Enterprise for limitless tokens and dedicated support.</p>
        </div>

        <div className="flex items-center gap-3 px-2 py-3 border-t border-white/5">
          <img src="https://picsum.photos/seed/gemini/40/40" className="w-10 h-10 rounded-full border border-white/10" alt="User" />
          <div className="flex-1 min-w-0">
            <p className="text-sm font-semibold truncate">Senior Engineer</p>
            <p className="text-xs text-gray-500 truncate">Pro Account</p>
          </div>
          <button className="text-gray-500 hover:text-white">
            <i className="fas fa-sign-out-alt"></i>
          </button>
        </div>
      </div>
    </div>
  );
};

default Sidebar;

// Component: ChatView

const ChatView: React.FC = () => {
  const [messages, setMessages] = useState<ChatMessage[]>([]);
  const [inputValue, setInputValue] = useState('');
  const [isTyping, setIsTyping] = useState(false);
  const [thinkingBudget, setThinkingBudget] = useState(0); // 0 = off
  const [useSearch, setUseSearch] = useState(false);
  const scrollRef = useRef<HTMLDivElement>(null);

  const scrollToBottom = () => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
    }
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  const handleSend = async () => {
    if (!inputValue.trim() || isTyping) return;

    const userMsg: ChatMessage = {
      id: Date.now().toString(),
      role: 'user',
      text: inputValue,
      timestamp: Date.now(),
    };

    setMessages(prev => [...prev, userMsg]);
    setInputValue('');
    setIsTyping(true);

    const modelMsgId = (Date.now() + 1).toString();
    const initialModelMsg: ChatMessage = {
      id: modelMsgId,
      role: 'model',
      text: '',
      timestamp: Date.now(),
      isStreaming: true
    };
    
    setMessages(prev => [...prev, initialModelMsg]);

    try {
      const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
      const config: any = {
        thinkingConfig: thinkingBudget > 0 ? { thinkingBudget } : undefined,
      };

      if (useSearch) {
        config.tools = [{ googleSearch: {} }];
      }

      const stream = await ai.models.generateContentStream({
        model: 'gemini-3-flash-preview',
        contents: inputValue,
        config
      });

      let fullText = '';
      let groundingUrls: any[] = [];

      for await (const chunk of stream) {
        const c = chunk as GenerateContentResponse;
        if (c.text) {
          fullText += c.text;
          setMessages(prev => 
            prev.map(m => m.id === modelMsgId ? { ...m, text: fullText } : m)
          );
        }
        
        // Extract grounding metadata and URLs if present
        const chunks = c.candidates?.[0]?.groundingMetadata?.groundingChunks;
        if (chunks) {
           const urls = chunks
            .filter((chunk: any) => chunk.web)
            .map((chunk: any) => ({
              uri: chunk.web.uri,
              title: chunk.web.title
            }));
           groundingUrls = [...groundingUrls, ...urls];
        }
      }

      // Finalize model message with grounding data
      setMessages(prev => 
        prev.map(m => m.id === modelMsgId ? { 
          ...m, 
          isStreaming: false, 
          groundingUrls: groundingUrls.length > 0 ? groundingUrls : undefined 
        } : m)
      );

    } catch (error) {
      console.error('Chat error:', error);
      setMessages(prev => 
        prev.map(m => m.id === modelMsgId ? { ...m, text: 'Error generating response. Please check your API key or connection.', isStreaming: false } : m)
      );
    } finally {
      setIsTyping(false);
    }
  };

  return (
    <div className="flex flex-col h-full bg-transparent">
      {/* Header Info */}
      <div className="flex items-center justify-between px-6 py-4 border-b border-white/5 glass">
        <div className="flex items-center gap-3">
          <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
          <div>
            <h2 className="text-sm font-bold">Gemini 3 Flash</h2>
            <p className="text-[10px] text-gray-500 uppercase tracking-tighter">Streaming Enabled â€¢ Ultra Low Latency</p>
          </div>
        </div>
        <div className="flex items-center gap-4">
          <div className="flex items-center gap-2 px-3 py-1.5 glass rounded-full border-white/5">
             <i className="fas fa-search text-xs text-gray-400"></i>
             <span className="text-xs text-gray-300">Search</span>
             <button 
                onClick={() => setUseSearch(!useSearch)}
                className={`w-8 h-4 rounded-full transition-colors relative ${useSearch ? 'bg-blue-600' : 'bg-gray-700'}`}
             >
                <div className={`absolute top-0.5 w-3 h-3 bg-white rounded-full transition-all ${useSearch ? 'left-4.5' : 'left-0.5'}`}></div>
             </button>
          </div>
          <div className="flex items-center gap-2 px-3 py-1.5 glass rounded-full border-white/5">
             <i className="fas fa-brain text-xs text-gray-400"></i>
             <span className="text-xs text-gray-300">Reasoning</span>
             <select 
                value={thinkingBudget} 
                onChange={(e) => setThinkingBudget(Number(e.target.value))}
                className="bg-transparent text-xs text-blue-400 focus:outline-none cursor-pointer"
             >
                <option value={0}>Off</option>
                <option value={1000}>Lite (1k)</option>
                <option value={8000}>Pro (8k)</option>
                <option value={24576}>Max (24k)</option>
             </select>
          </div>
        </div>
      </div>

      {/* Messages */}
      <div ref={scrollRef} className="flex-1 overflow-y-auto p-6 space-y-6 scroll-smooth">
        {messages.length === 0 ? (
          <div className="flex flex-col items-center justify-center h-full text-center space-y-6 opacity-40">
             <div className="w-16 h-16 rounded-full bg-white/5 flex items-center justify-center text-3xl">
                <i className="fas fa-ghost"></i>
             </div>
             <div>
                <h3 className="text-lg font-medium">Start a new conversation</h3>
                <p className="text-sm">Gemini is ready to help you with coding, creative writing, or complex reasoning.</p>
             </div>
          </div>
        ) : (
          messages.map((msg) => (
            <div key={msg.id} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
              <div className={`max-w-[85%] lg:max-w-[70%] space-y-2`}>
                <div className={`
                  px-5 py-3.5 rounded-2xl text-sm leading-relaxed
                  ${msg.role === 'user' 
                    ? 'bg-blue-600 text-white rounded-tr-none' 
                    : 'glass border-white/5 text-gray-200 rounded-tl-none'}
                `}>
                  {msg.text || (msg.isStreaming && <span className="animate-pulse">|</span>)}
                </div>
                {msg.groundingUrls && msg.groundingUrls.length > 0 && (
                  <div className="flex flex-wrap gap-2 pt-1">
                    {msg.groundingUrls.map((url, i) => (
                      <a 
                        key={i} 
                        href={url.uri} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        className="text-[10px] px-2 py-1 glass rounded-md border-white/5 text-blue-400 hover:text-blue-300 transition-colors"
                      >
                        <i className="fas fa-link mr-1"></i> {url.title || 'Source'}
                      </a>
                    ))}
                  </div>
                )}
                <p className="text-[10px] text-gray-500 px-1">
                  {new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </p>
              </div>
            </div>
          ))
        )}
        {isTyping && messages[messages.length-1]?.role === 'user' && (
           <div className="flex justify-start">
             <div className="glass border-white/5 px-4 py-2 rounded-2xl rounded-tl-none flex gap-1">
                <div className="w-1.5 h-1.5 bg-gray-500 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></div>
                <div className="w-1.5 h-1.5 bg-gray-500 rounded-full animate-bounce" style={{ animationDelay: '200ms' }}></div>
                <div className="w-1.5 h-1.5 bg-gray-500 rounded-full animate-bounce" style={{ animationDelay: '400ms' }}></div>
             </div>
           </div>
        )}
      </div>

      {/* Input */}
      <div className="p-6">
        <div className="relative glass rounded-2xl border-white/10 p-1 focus-within:border-blue-500/50 transition-all duration-300 shadow-2xl">
          <textarea
            rows={1}
            value={inputValue}
            onChange={(e) => {
              setInputValue(e.target.value);
              e.target.style.height = 'auto';
              e.target.style.height = `${e.target.scrollHeight}px`;
            }}
            onKeyDown={(e) => {
              if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
              }
            }}
            placeholder="Ask anything... (Shift+Enter for newline)"
            className="w-full bg-transparent border-none focus:ring-0 text-white placeholder-gray-500 p-4 max-h-48 resize-none text-sm"
          />
          <div className="flex items-center justify-between p-2 border-t border-white/5">
            <div className="flex gap-2">
               <button className="p-2 text-gray-400 hover:text-white transition-colors rounded-lg hover:bg-white/5"><i className="fas fa-paperclip"></i></button>
               <button className="p-2 text-gray-400 hover:text-white transition-colors rounded-lg hover:bg-white/5"><i className="fas fa-image"></i></button>
            </div>
            <button
              onClick={handleSend}
              disabled={!inputValue.trim() || isTyping}
              className={`
                px-4 py-2 rounded-xl flex items-center gap-2 transition-all duration-300
                ${!inputValue.trim() || isTyping ? 'bg-gray-800 text-gray-500 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-500 shadow-lg shadow-blue-900/40'}
              `}
            >
              <span className="text-sm font-semibold">{isTyping ? 'Gemini is thinking...' : 'Send Message'}</span>
              <i className="fas fa-paper-plane text-xs"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

default ChatView;

// Component: StudioView

/* Removed conflicting declare global block to fix TS errors as AIStudio is already defined globally */

const StudioView: React.FC = () => {
  const [prompt, setPrompt] = useState('');
  const [mediaType, setMediaType] = useState<'image' | 'video'>('image');
  const [isGenerating, setIsGenerating] = useState(false);
  const [status, setStatus] = useState('');
  const [gallery, setGallery] = useState<GeneratedMedia[]>([]);
  const [hasSelectedKey, setHasSelectedKey] = useState<boolean | null>(null);

  // Check for API key on mount and when media type changes
  useEffect(() => {
    const checkKey = async () => {
      // Use casting to access pre-configured aistudio to avoid interface conflict
      const aistudio = (window as any).aistudio;
      if (aistudio) {
        const has = await aistudio.hasSelectedApiKey();
        setHasSelectedKey(has);
      }
    };
    checkKey();
  }, [mediaType]);

  const handleOpenKeySelector = async () => {
    const aistudio = (window as any).aistudio;
    if (aistudio) {
      await aistudio.openSelectKey();
      // Assume success after triggering per instructions to avoid race conditions
      setHasSelectedKey(true);
    }
  };

  const handleGenerate = async () => {
    if (!prompt.trim() || isGenerating) return;

    setIsGenerating(true);
    setStatus('Initializing AI engines...');

    try {
      if (mediaType === 'image') {
        // Create instance right before call to use latest API key from environment
        const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
        setStatus('Visualizing your imagination...');
        const response = await ai.models.generateContent({
          model: 'gemini-2.5-flash-image',
          contents: { parts: [{ text: prompt }] },
          config: { imageConfig: { aspectRatio: "16:9" } }
        });

        let imageUrl = '';
        for (const part of response.candidates?.[0]?.content?.parts || []) {
          if (part.inlineData) {
            imageUrl = `data:image/png;base64,${part.inlineData.data}`;
            break;
          }
        }

        if (imageUrl) {
          const newMedia: GeneratedMedia = {
            id: Date.now().toString(),
            type: 'image',
            url: imageUrl,
            prompt: prompt,
            timestamp: Date.now()
          };
          setGallery(prev => [newMedia, ...prev]);
        }
      } else {
        // Video generation logic (Veo)
        setStatus('Verifying Video Studio Access...');
        const aistudio = (window as any).aistudio;
        const hasKey = aistudio ? await aistudio.hasSelectedApiKey() : true;
        if (!hasKey) {
          await handleOpenKeySelector();
        }

        setStatus('Dreaming in 24 frames per second...');
        // Create instance right before call to use latest API key from dialog
        const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
        let operation = await ai.models.generateVideos({
          model: 'veo-3.1-fast-generate-preview',
          prompt: prompt,
          config: {
            numberOfVideos: 1,
            resolution: '720p',
            aspectRatio: '16:9'
          }
        });

        while (!operation.done) {
          setStatus('Processing cinematic frames (this may take 1-2 mins)...');
          await new Promise(resolve => setTimeout(resolve, 10000));
          operation = await ai.operations.getVideosOperation({ operation: operation });
        }

        const downloadLink = operation.response?.generatedVideos?.[0]?.video?.uri;
        if (downloadLink) {
           setStatus('Finalizing video file...');
           const res = await fetch(`${downloadLink}&key=${process.env.API_KEY}`);
           const blob = await res.blob();
           const videoUrl = URL.createObjectURL(blob);
           
           const newMedia: GeneratedMedia = {
             id: Date.now().toString(),
             type: 'video',
             url: videoUrl,
             prompt: prompt,
             timestamp: Date.now()
           };
           setGallery(prev => [newMedia, ...prev]);
        }
      }
    } catch (error: any) {
      console.error('Generation failed:', error);
      if (error.message?.includes('Requested entity was not found')) {
        setStatus('Error: Key reset required. Retrying...');
        setHasSelectedKey(false);
        await handleOpenKeySelector();
      } else {
        setStatus(`Error: ${error.message || 'Generation failed'}`);
      }
    } finally {
      setIsGenerating(false);
      setPrompt('');
    }
  };

  return (
    <div className="flex flex-col h-full overflow-hidden">
      {/* Creation Pane */}
      <div className="p-8 border-b border-white/5 glass bg-white/2">
        <div className="max-w-4xl mx-auto space-y-6">
          <div className="flex items-center justify-between">
            <h1 className="text-2xl font-bold gradient-text">Media Studio</h1>
            <div className="flex p-1 glass rounded-xl border-white/10">
              <button 
                onClick={() => setMediaType('image')}
                className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${mediaType === 'image' ? 'bg-blue-600 text-white shadow-lg' : 'text-gray-400 hover:text-white'}`}
              >
                <i className="fas fa-image mr-2"></i> Image
              </button>
              <button 
                onClick={() => setMediaType('video')}
                className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${mediaType === 'video' ? 'bg-purple-600 text-white shadow-lg' : 'text-gray-400 hover:text-white'}`}
              >
                <i className="fas fa-video mr-2"></i> Video (Veo)
              </button>
            </div>
          </div>

          {/* Mandatory API Key selection for Video as per guidelines */}
          {mediaType === 'video' && hasSelectedKey === false && (
            <div className="p-4 glass rounded-2xl border border-yellow-500/30 bg-yellow-500/5 flex items-center justify-between animate-in fade-in slide-in-from-top-4 duration-500">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-full bg-yellow-500/20 flex items-center justify-center text-yellow-500">
                  <i className="fas fa-key"></i>
                </div>
                <div>
                  <p className="text-sm font-bold text-yellow-200">Paid API Key Required</p>
                  <p className="text-xs text-yellow-500/80">Veo requires a billing-enabled project. Use the key selector to proceed.</p>
                </div>
              </div>
              <div className="flex items-center gap-4">
                <a 
                  href="https://ai.google.dev/gemini-api/docs/billing" 
                  target="_blank" 
                  rel="noopener noreferrer"
                  className="text-xs text-gray-400 hover:text-white underline transition-colors"
                >
                  Billing Docs
                </a>
                <button 
                  onClick={handleOpenKeySelector}
                  className="px-6 py-2 bg-yellow-600 hover:bg-yellow-500 text-white rounded-xl text-xs font-bold shadow-lg shadow-yellow-900/20 transition-all"
                >
                  Select API Key
                </button>
              </div>
            </div>
          )}

          <div className="relative">
            <textarea
              value={prompt}
              onChange={(e) => setPrompt(e.target.value)}
              placeholder={`Describe your vision for the ${mediaType}... e.g. "A cyberpunk city in the rain with neon lights, cinematic lighting, 8k resolution"`}
              className="w-full h-32 glass border-white/10 rounded-2xl p-4 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500/50 resize-none transition-all shadow-xl"
            />
            <button
              onClick={handleGenerate}
              disabled={!prompt.trim() || isGenerating || (mediaType === 'video' && hasSelectedKey === false)}
              className={`
                absolute bottom-4 right-4 px-6 py-3 rounded-xl flex items-center gap-3 font-bold transition-all
                ${!prompt.trim() || isGenerating || (mediaType === 'video' && hasSelectedKey === false)
                  ? 'bg-gray-800 text-gray-500 cursor-not-allowed' 
                  : mediaType === 'image' 
                    ? 'bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-900/40' 
                    : 'bg-purple-600 hover:bg-purple-500 text-white shadow-lg shadow-purple-900/40'}
              `}
            >
              {isGenerating ? (
                <>
                  <i className="fas fa-circle-notch fa-spin"></i>
                  <span>Creating...</span>
                </>
              ) : (
                <>
                  <i className="fas fa-magic"></i>
                  <span>Generate</span>
                </>
              )}
            </button>
          </div>
          
          {isGenerating && (
            <div className="flex items-center gap-3 text-sm text-gray-400 animate-pulse">
               <i className="fas fa-info-circle text-blue-400"></i>
               {status}
            </div>
          )}
        </div>
      </div>

      {/* Gallery */}
      <div className="flex-1 overflow-y-auto p-8 bg-black/40">
        <div className="max-w-6xl mx-auto space-y-8">
          <div className="flex items-center justify-between">
            <h3 className="text-xl font-semibold">Your Creations</h3>
            <span className="text-sm text-gray-500">{gallery.length} items</span>
          </div>

          {gallery.length === 0 ? (
            <div className="flex flex-col items-center justify-center py-24 text-center glass rounded-3xl border-dashed border-white/10 opacity-30">
               <div className="text-6xl mb-6">ðŸŽ¨</div>
               <h4 className="text-xl font-medium">No masterpieces yet</h4>
               <p className="mt-2">Use the prompt box above to generate your first AI artwork.</p>
            </div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {gallery.map((item) => (
                <div key={item.id} className="group relative glass rounded-2xl overflow-hidden border-white/5 shadow-xl hover:scale-[1.02] transition-transform duration-300">
                  <div className="aspect-video relative overflow-hidden bg-white/5">
                    {item.type === 'image' ? (
                      <img src={item.url} alt={item.prompt} className="w-full h-full object-cover" />
                    ) : (
                      <video src={item.url} controls className="w-full h-full object-cover" />
                    )}
                    <div className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-4">
                       <p className="text-xs text-white line-clamp-2 italic mb-2">"{item.prompt}"</p>
                       <div className="flex gap-2">
                          <button onClick={() => window.open(item.url, '_blank')} className="flex-1 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-xs font-semibold backdrop-blur-md">View Full</button>
                          <a href={item.url} download={`gemini-${item.id}.png`} className="p-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-xs"><i className="fas fa-download"></i></a>
                       </div>
                    </div>
                  </div>
                  <div className="p-3 flex items-center justify-between">
                     <span className={`text-[10px] px-2 py-0.5 rounded-full ${item.type === 'image' ? 'bg-blue-500/20 text-blue-400' : 'bg-purple-500/20 text-purple-400'}`}>
                        {item.type.toUpperCase()}
                     </span>
                     <span className="text-[10px] text-gray-500">{new Date(item.timestamp).toLocaleDateString()}</span>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

default StudioView;

// Component: LiveView

// Audio Helpers
function decode(base64: string) {
  const binaryString = atob(base64);
  const len = binaryString.length;
  const bytes = new Uint8Array(len);
  for (let i = 0; i < len; i++) {
    bytes[i] = binaryString.charCodeAt(i);
  }
  return bytes;
}

function encode(bytes: Uint8Array) {
  let binary = '';
  const len = bytes.byteLength;
  for (let i = 0; i < len; i++) {
    binary += String.fromCharCode(bytes[i]);
  }
  return btoa(binary);
}

async function decodeAudioData(
  data: Uint8Array,
  ctx: AudioContext,
  sampleRate: number,
  numChannels: number,
): Promise<AudioBuffer> {
  const dataInt16 = new Int16Array(data.buffer);
  const frameCount = dataInt16.length / numChannels;
  const buffer = ctx.createBuffer(numChannels, frameCount, sampleRate);

  for (let channel = 0; channel < numChannels; channel++) {
    const channelData = buffer.getChannelData(channel);
    for (let i = 0; i < frameCount; i++) {
      channelData[i] = dataInt16[i * numChannels + channel] / 32768.0;
    }
  }
  return buffer;
}

const LiveView: React.FC = () => {
  const [isActive, setIsActive] = useState(false);
  const [transcription, setTranscription] = useState<string[]>([]);
  const [currentPrompt, setCurrentPrompt] = useState('');
  const [isModelSpeaking, setIsModelSpeaking] = useState(false);
  
  const audioContextRef = useRef<AudioContext | null>(null);
  const outputAudioContextRef = useRef<AudioContext | null>(null);
  const sessionRef = useRef<any>(null);
  const sourcesRef = useRef<Set<AudioBufferSourceNode>>(new Set());
  const nextStartTimeRef = useRef<number>(0);
  const streamRef = useRef<MediaStream | null>(null);

  const startSession = async () => {
    try {
      const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
      
      streamRef.current = await navigator.mediaDevices.getUserMedia({ audio: true });
      audioContextRef.current = new (window.AudioContext || (window as any).webkitAudioContext)({ sampleRate: 16000 });
      outputAudioContextRef.current = new (window.AudioContext || (window as any).webkitAudioContext)({ sampleRate: 24000 });
      
      const sessionPromise = ai.live.connect({
        // Updated: Using the recommended model for real-time audio interaction
        model: 'gemini-2.5-flash-native-audio-preview-12-2025',
        callbacks: {
          onopen: () => {
            console.log('Session opened');
            setIsActive(true);
            
            // Setup microphone stream
            if (audioContextRef.current && streamRef.current) {
              const source = audioContextRef.current.createMediaStreamSource(streamRef.current);
              const scriptProcessor = audioContextRef.current.createScriptProcessor(4096, 1, 1);
              
              scriptProcessor.onaudioprocess = (e) => {
                const inputData = e.inputBuffer.getChannelData(0);
                const int16 = new Int16Array(inputData.length);
                for (let i = 0; i < inputData.length; i++) {
                  int16[i] = inputData[i] * 32768;
                }
                
                const pcmBlob = {
                  data: encode(new Uint8Array(int16.buffer)),
                  mimeType: 'audio/pcm;rate=16000',
                };
                
                sessionPromise.then(session => {
                  session.sendRealtimeInput({ media: pcmBlob });
                });
              };
              
              source.connect(scriptProcessor);
              scriptProcessor.connect(audioContextRef.current.destination);
            }
          },
          onmessage: async (message: LiveServerMessage) => {
            // Handle Transcription
            if (message.serverContent?.outputTranscription) {
              setTranscription(prev => [...prev, `Model: ${message.serverContent?.outputTranscription?.text}`]);
            } else if (message.serverContent?.inputTranscription) {
               setTranscription(prev => [...prev, `You: ${message.serverContent?.inputTranscription?.text}`]);
            }

            // Handle Audio
            const base64Audio = message.serverContent?.modelTurn?.parts[0]?.inlineData?.data;
            if (base64Audio && outputAudioContextRef.current) {
              setIsModelSpeaking(true);
              const ctx = outputAudioContextRef.current;
              nextStartTimeRef.current = Math.max(nextStartTimeRef.current, ctx.currentTime);
              
              const audioBuffer = await decodeAudioData(decode(base64Audio), ctx, 24000, 1);
              const source = ctx.createBufferSource();
              source.buffer = audioBuffer;
              source.connect(ctx.destination);
              source.addEventListener('ended', () => {
                sourcesRef.current.delete(source);
                if (sourcesRef.current.size === 0) setIsModelSpeaking(false);
              });
              
              source.start(nextStartTimeRef.current);
              nextStartTimeRef.current += audioBuffer.duration;
              sourcesRef.current.add(source);
            }

            if (message.serverContent?.interrupted) {
              sourcesRef.current.forEach(s => s.stop());
              sourcesRef.current.clear();
              nextStartTimeRef.current = 0;
              setIsModelSpeaking(false);
            }
          },
          onerror: (e) => console.error('Live session error:', e),
          onclose: () => {
            setIsActive(false);
            console.log('Session closed');
          }
        },
        config: {
          responseModalities: [Modality.AUDIO],
          speechConfig: {
            voiceConfig: { prebuiltVoiceConfig: { voiceName: 'Zephyr' } }
          },
          inputAudioTranscription: {},
          outputAudioTranscription: {},
          systemInstruction: 'You are an intelligent, real-time voice assistant. Keep responses conversational and concise.'
        }
      });
      
      sessionRef.current = await sessionPromise;

    } catch (err) {
      console.error('Failed to start session:', err);
      setIsActive(false);
    }
  };

  const stopSession = () => {
    if (sessionRef.current) {
      sessionRef.current.close();
      sessionRef.current = null;
    }
    if (streamRef.current) {
      streamRef.current.getTracks().forEach(track => track.stop());
    }
    setIsActive(false);
    setIsModelSpeaking(false);
    setTranscription([]);
  };

  useEffect(() => {
    return () => {
      stopSession();
    };
  }, []);

  return (
    <div className="h-full flex flex-col items-center justify-center bg-transparent p-8">
      <div className="max-w-3xl w-full flex flex-col items-center gap-12">
        
        {/* Visualizer Circle */}
        <div className="relative group">
           <div className={`
              absolute inset-0 bg-blue-500/20 rounded-full blur-3xl transition-all duration-1000
              ${isActive ? 'opacity-100 scale-125' : 'opacity-0 scale-75'}
              ${isModelSpeaking ? 'bg-purple-500/30 animate-pulse' : ''}
           `}></div>
           
           <div className={`
              w-64 h-64 rounded-full glass border-2 flex flex-col items-center justify-center relative z-10 transition-all duration-500
              ${isActive ? 'border-blue-500/50 scale-105 shadow-[0_0_50px_rgba(59,130,246,0.2)]' : 'border-white/10 grayscale'}
           `}>
              <div className="flex gap-1.5 mb-4">
                 {[...Array(8)].map((_, i) => (
                    <div 
                      key={i} 
                      className={`w-1.5 rounded-full transition-all duration-300 ${isActive ? 'bg-blue-400' : 'bg-gray-600'}`}
                      style={{ 
                        height: isActive ? `${15 + Math.random() * 40}px` : '10px',
                        animation: isActive ? `wave 1s ease-in-out infinite` : 'none',
                        animationDelay: `${i * 100}ms`
                      }}
                    ></div>
                 ))}
              </div>
              <p className={`text-sm font-bold tracking-widest uppercase transition-colors ${isActive ? 'text-blue-400' : 'text-gray-500'}`}>
                {isActive ? (isModelSpeaking ? 'Gemini Speaking' : 'Listening...') : 'Offline'}
              </p>
           </div>
           
           <style>{`
              @keyframes wave {
                0%, 100% { transform: scaleY(1); }
                50% { transform: scaleY(1.5); }
              }
           `}</style>
        </div>

        {/* Info & Transcript */}
        <div className="text-center space-y-4 w-full">
           <h2 className="text-3xl font-bold gradient-text">Real-time Voice Conversation</h2>
           <p className="text-gray-400 max-w-md mx-auto text-sm">Experience ultra-low latency audio interactions. No typing, just natural human-like dialogue powered by Gemini Flash.</p>
           
           <div className="h-32 w-full glass rounded-2xl p-4 overflow-y-auto border-white/5 text-left flex flex-col-reverse gap-2 text-xs">
              {transcription.slice().reverse().map((t, i) => (
                 <div key={i} className={`p-2 rounded-lg ${t.startsWith('You') ? 'bg-blue-600/10 text-blue-300 ml-4' : 'bg-purple-600/10 text-purple-300 mr-4'}`}>
                    {t}
                 </div>
              ))}
              {transcription.length === 0 && <span className="text-gray-600 italic text-center w-full">Transcript will appear here...</span>}
           </div>
        </div>

        {/* Controls */}
        <div className="flex gap-6">
           {!isActive ? (
             <button 
              onClick={startSession}
              className="px-10 py-5 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white rounded-full font-bold shadow-2xl shadow-blue-900/40 flex items-center gap-4 group transition-all"
             >
                <div className="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                   <i className="fas fa-play text-xs ml-1"></i>
                </div>
                <span>Initialize Voice Engine</span>
             </button>
           ) : (
             <button 
              onClick={stopSession}
              className="px-10 py-5 bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white border border-red-500/20 rounded-full font-bold shadow-2xl flex items-center gap-4 group transition-all"
             >
                <div className="w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                   <i className="fas fa-stop text-xs"></i>
                </div>
                <span>End Interaction</span>
             </button>
           )}
        </div>

        <div className="flex items-center gap-6 text-xs text-gray-500">
           <div className="flex items-center gap-2"><i className="fas fa-shield-alt text-green-500"></i> Encrypted Session</div>
           <div className="flex items-center gap-2"><i className="fas fa-bolt text-yellow-500"></i> &lt;200ms Latency</div>
           <div className="flex items-center gap-2"><i className="fas fa-volume-up text-blue-500"></i> Zephyr Voice</div>
        </div>
      </div>
    </div>
  );
};

default LiveView;

// Component: ChatInterface

interface ChatInterfaceProps {
  apiKey: string;
}

const ChatInterface: React.FC<ChatInterfaceProps> = ({ apiKey }) => {
  const [messages, setMessages] = useState<ChatMessage[]>([]);
  const [inputText, setInputText] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [selectedImage, setSelectedImage] = useState<string | null>(null);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [usageData, setUsageData] = useState<TokenUsageData[]>([]);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  const handleImageUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setSelectedImage(reader.result as string);
      };
      reader.readAsDataURL(file);
    }
  };

  const handleSendMessage = async () => {
    if ((!inputText.trim() && !selectedImage) || isLoading) return;

    const newUserMsg: ChatMessage = {
      id: Date.now().toString(),
      role: 'user',
      text: inputText,
      image: selectedImage || undefined,
      timestamp: Date.now(),
    };

    setMessages((prev) => [...prev, newUserMsg]);
    setInputText('');
    setSelectedImage(null);
    setIsLoading(true);

    try {
      const ai = new GoogleGenAI({ apiKey });
      
      const parts: any[] = [];
      
      if (newUserMsg.image) {
        // Strip data:image/jpeg;base64, prefix
        const base64Data = newUserMsg.image.split(',')[1];
        const mimeType = newUserMsg.image.substring(
            newUserMsg.image.indexOf(":") + 1, 
            newUserMsg.image.indexOf(";")
        );
        parts.push({
          inlineData: {
            data: base64Data,
            mimeType: mimeType
          }
        });
      }
      
      if (newUserMsg.text) {
        parts.push({ text: newUserMsg.text });
      }

      // Using standard generateContentStream for text/image
      const streamResult = await ai.models.generateContentStream({
        model: 'gemini-3-flash-preview',
        contents: {
            parts: parts
        },
      });

      let fullResponseText = '';
      const responseId = (Date.now() + 1).toString();
      
      setMessages((prev) => [
        ...prev,
        {
          id: responseId,
          role: 'model',
          text: '',
          timestamp: Date.now(),
        },
      ]);

      for await (const chunk of streamResult) {
          const chunkText = chunk.text || '';
          fullResponseText += chunkText;
          
          setMessages((prev) => 
            prev.map((msg) => 
                msg.id === responseId ? { ...msg, text: fullResponseText } : msg
            )
          );
      }

      // Update usage data (simulated count based on length for visualization purposes as actual usage isn't always in stream chunk immediately)
      const tokenCountEstimate = fullResponseText.length / 4; 
      setUsageData(prev => {
        const newData = [...prev, {
            timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
            tokens: Math.round(tokenCountEstimate)
        }];
        return newData.slice(-20); // Keep last 20
      });

    } catch (error) {
      console.error('Error generating content:', error);
      setMessages((prev) => [
        ...prev,
        {
          id: Date.now().toString(),
          role: 'model',
          text: "I'm sorry, I encountered an error processing your request.",
          timestamp: Date.now(),
        },
      ]);
    } finally {
      setIsLoading(false);
    }
  };

  const handleClearChat = () => {
    setMessages([]);
    setUsageData([]);
  };

  return (
    <div className="flex flex-col h-full bg-slate-900">
      {/* Header / Stats */}
      <div className="flex-none p-4 border-b border-slate-700 bg-slate-800/50 backdrop-blur-sm">
        <div className="flex justify-between items-center mb-4">
            <h2 className="text-lg font-semibold text-slate-100 flex items-center gap-2">
                <Bot className="w-5 h-5 text-indigo-400" />
                Gemini 3 Flash
            </h2>
             <button
                onClick={handleClearChat}
                className="p-2 text-slate-400 hover:text-red-400 hover:bg-slate-700/50 rounded-lg transition-colors"
                title="Clear Chat"
            >
                <Trash2 className="w-4 h-4" />
            </button>
        </div>
        
        {/* Token Usage Chart */}
        <div className="h-32 w-full">
            <ResponsiveContainer width="100%" height="100%">
                <AreaChart data={usageData}>
                    <defs>
                        <linearGradient id="colorTokens" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="5%" stopColor="#818cf8" stopOpacity={0.3}/>
                            <stop offset="95%" stopColor="#818cf8" stopOpacity={0}/>
                        </linearGradient>
                    </defs>
                    <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                    <XAxis dataKey="timestamp" hide />
                    <YAxis hide />
                    <Tooltip 
                        contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px' }}
                        itemStyle={{ color: '#e2e8f0' }}
                    />
                    <Area type="monotone" dataKey="tokens" stroke="#818cf8" fillOpacity={1} fill="url(#colorTokens)" />
                </AreaChart>
            </ResponsiveContainer>
            {usageData.length === 0 && (
                <div className="absolute inset-0 flex items-center justify-center text-xs text-slate-500 pointer-events-none h-32">
                    Usage activity will appear here
                </div>
            )}
        </div>
      </div>

      {/* Messages Area */}
      <div className="flex-1 overflow-y-auto p-4 space-y-4">
        {messages.length === 0 ? (
          <div className="flex flex-col items-center justify-center h-full text-slate-500 space-y-4">
            <Bot className="w-16 h-16 opacity-20" />
            <p className="text-center max-w-md">
              Start a conversation with Gemini. You can ask questions, brainstorm ideas, or upload images for analysis.
            </p>
          </div>
        ) : (
          messages.map((msg) => (
            <div
              key={msg.id}
              className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
            >
              <div
                className={`max-w-[80%] rounded-2xl p-4 ${
                  msg.role === 'user'
                    ? 'bg-indigo-600 text-white rounded-br-none'
                    : 'bg-slate-700 text-slate-200 rounded-bl-none'
                }`}
              >
                <div className="flex items-center gap-2 mb-2 opacity-70 text-xs">
                    {msg.role === 'user' ? <User className="w-3 h-3" /> : <Bot className="w-3 h-3" />}
                    <span>{msg.role === 'user' ? 'You' : 'Gemini'}</span>
                </div>
                {msg.image && (
                  <img
                    src={msg.image}
                    alt="Uploaded content"
                    className="max-w-full rounded-lg mb-2 max-h-60 object-cover"
                  />
                )}
                <div className="whitespace-pre-wrap leading-relaxed">
                  {msg.text}
                </div>
              </div>
            </div>
          ))
        )}
        <div ref={messagesEndRef} />
      </div>

      {/* Input Area */}
      <div className="flex-none p-4 bg-slate-800 border-t border-slate-700">
        {selectedImage && (
            <div className="mb-2 relative inline-block">
                <img src={selectedImage} alt="Preview" className="h-20 rounded-lg border border-slate-600" />
                <button 
                    onClick={() => setSelectedImage(null)}
                    className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-md hover:bg-red-600"
                >
                    <Trash2 className="w-3 h-3" />
                </button>
            </div>
        )}
        <div className="flex gap-2">
          <button
            onClick={() => fileInputRef.current?.click()}
            className="p-3 text-slate-400 hover:text-indigo-400 hover:bg-slate-700 rounded-xl transition-colors"
            title="Upload Image"
          >
            <ImageIcon className="w-6 h-6" />
          </button>
          <input
            type="file"
            ref={fileInputRef}
            onChange={handleImageUpload}
            accept="image/*"
            className="hidden"
          />
          <input
            type="text"
            value={inputText}
            onChange={(e) => setInputText(e.target.value)}
            onKeyDown={(e) => e.key === 'Enter' && handleSendMessage()}
            placeholder="Type a message..."
            className="flex-1 bg-slate-900 text-white placeholder-slate-500 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 border border-slate-700"
            disabled={isLoading}
          />
          <button
            onClick={handleSendMessage}
            disabled={isLoading || (!inputText.trim() && !selectedImage)}
            className={`p-3 rounded-xl transition-all ${
              isLoading || (!inputText.trim() && !selectedImage)
                ? 'bg-slate-700 text-slate-500 cursor-not-allowed'
                : 'bg-indigo-600 text-white hover:bg-indigo-500 shadow-lg shadow-indigo-500/20'
            }`}
          >
            {isLoading ? <Loader2 className="w-6 h-6 animate-spin" /> : <Send className="w-6 h-6" />}
          </button>
        </div>
      </div>
    </div>
  );
};

default ChatInterface;

// Component: LiveInterface

interface LiveInterfaceProps {
  apiKey: string;
}

const LiveInterface: React.FC<LiveInterfaceProps> = ({ apiKey }) => {
  const [connectionState, setConnectionState] = useState<LiveConnectionState>(LiveConnectionState.DISCONNECTED);
  const [errorMsg, setErrorMsg] = useState<string | null>(null);
  const [volume, setVolume] = useState(0);

  // Audio Context Refs
  const inputAudioContextRef = useRef<AudioContext | null>(null);
  const outputAudioContextRef = useRef<AudioContext | null>(null);
  const mediaStreamRef = useRef<MediaStream | null>(null);
  const workletNodeRef = useRef<ScriptProcessorNode | null>(null);
  
  // Connection Refs
  const sessionRef = useRef<any>(null); // To store the session object
  const nextStartTimeRef = useRef<number>(0);
  const sourcesRef = useRef<Set<AudioBufferSourceNode>>(new Set());

  // Visualizer Canvas
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const animationRef = useRef<number | null>(null);

  const drawVisualizer = useCallback(() => {
    if (!canvasRef.current) return;
    const ctx = canvasRef.current.getContext('2d');
    if (!ctx) return;

    const width = canvasRef.current.width;
    const height = canvasRef.current.height;

    // Clear with fade effect
    ctx.fillStyle = 'rgba(15, 23, 42, 0.2)'; // Slate 900 fade
    ctx.fillRect(0, 0, width, height);

    if (connectionState === LiveConnectionState.CONNECTED) {
        // Draw wave
        ctx.beginPath();
        const amplitude = Math.max(volume * height * 0.4, 2);
        const frequency = 0.1;
        const time = Date.now() / 100;
        
        ctx.moveTo(0, height / 2);
        
        for (let x = 0; x < width; x++) {
            const y = height / 2 + Math.sin(x * frequency + time) * amplitude * Math.sin(x / width * Math.PI);
            ctx.lineTo(x, y);
        }

        ctx.strokeStyle = '#818cf8'; // Indigo 400
        ctx.lineWidth = 3;
        ctx.stroke();

        // Mirrored wave
        ctx.beginPath();
        ctx.moveTo(0, height / 2);
         for (let x = 0; x < width; x++) {
            const y = height / 2 - Math.sin(x * frequency + time) * amplitude * Math.sin(x / width * Math.PI);
            ctx.lineTo(x, y);
        }
        ctx.strokeStyle = '#c084fc'; // Purple 400
        ctx.lineWidth = 2;
        ctx.stroke();
    } else {
        // Flat line
        ctx.beginPath();
        ctx.moveTo(0, height/2);
        ctx.lineTo(width, height/2);
        ctx.strokeStyle = '#334155';
        ctx.lineWidth = 2;
        ctx.stroke();
    }

    animationRef.current = requestAnimationFrame(drawVisualizer);
  }, [connectionState, volume]);

  useEffect(() => {
    drawVisualizer();
    return () => {
        if (animationRef.current) cancelAnimationFrame(animationRef.current);
    };
  }, [drawVisualizer]);

  const startSession = async () => {
    setErrorMsg(null);
    setConnectionState(LiveConnectionState.CONNECTING);

    try {
      // 1. Setup AudioContexts
      inputAudioContextRef.current = new (window.AudioContext || (window as any).webkitAudioContext)({ sampleRate: 16000 });
      outputAudioContextRef.current = new (window.AudioContext || (window as any).webkitAudioContext)({ sampleRate: 24000 });

      // 2. Get Microphone Stream
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaStreamRef.current = stream;

      // 3. Initialize Gemini Client
      const ai = new GoogleGenAI({ apiKey });
      
      // Connect to Gemini Live
      const sessionPromise = ai.live.connect({
        // Updated: Using the recommended model for real-time audio interaction
        model: 'gemini-2.5-flash-native-audio-preview-12-2025',
        config: {
          responseModalities: [Modality.AUDIO],
          speechConfig: {
            voiceConfig: { prebuiltVoiceConfig: { voiceName: 'Zephyr' } },
          },
          systemInstruction: "You are a helpful, witty, and concise AI assistant.",
        },
        callbacks: {
          onopen: () => {
            console.log("Live Session Opened");
            setConnectionState(LiveConnectionState.CONNECTED);
            
            // Start processing microphone input
            const source = inputAudioContextRef.current!.createMediaStreamSource(stream);
            const scriptProcessor = inputAudioContextRef.current!.createScriptProcessor(4096, 1, 1);
            workletNodeRef.current = scriptProcessor;

            scriptProcessor.onaudioprocess = (audioProcessingEvent) => {
              const inputData = audioProcessingEvent.inputBuffer.getChannelData(0);
              
              // Calculate volume for visualizer
              let sum = 0;
              for (let i = 0; i < inputData.length; i++) {
                sum += inputData[i] * inputData[i];
              }
              setVolume(Math.sqrt(sum / inputData.length));

              const pcmBlob = createPcmBlob(inputData);
              sessionPromise.then((session) => {
                 session.sendRealtimeInput({ media: pcmBlob });
              });
            };

            source.connect(scriptProcessor);
            scriptProcessor.connect(inputAudioContextRef.current!.destination);
          },
          onmessage: async (message: LiveServerMessage) => {
            // Handle Audio Output
            const base64Audio = message.serverContent?.modelTurn?.parts?.[0]?.inlineData?.data;
            if (base64Audio) {
              const ctx = outputAudioContextRef.current!;
              // Reset nextStartTime if it's behind current time (drift correction)
              nextStartTimeRef.current = Math.max(nextStartTimeRef.current, ctx.currentTime);
              
              const audioBuffer = await decodeAudioData(
                base64ToUint8Array(base64Audio),
                ctx,
                24000,
                1
              );
              
              const source = ctx.createBufferSource();
              source.buffer = audioBuffer;
              source.connect(ctx.destination);
              source.addEventListener('ended', () => {
                 sourcesRef.current.delete(source);
              });
              
              source.start(nextStartTimeRef.current);
              nextStartTimeRef.current += audioBuffer.duration;
              sourcesRef.current.add(source);
            }

            // Handle Interruption
            if (message.serverContent?.interrupted) {
                console.log("Interrupted");
                sourcesRef.current.forEach(src => src.stop());
                sourcesRef.current.clear();
                nextStartTimeRef.current = 0;
            }
          },
          onclose: () => {
            console.log("Session Closed");
            setConnectionState(LiveConnectionState.DISCONNECTED);
            setVolume(0);
          },
          onerror: (err) => {
            console.error("Session Error", err);
            setConnectionState(LiveConnectionState.ERROR);
            setErrorMsg("Connection error occurred.");
            setVolume(0);
          }
        }
      });
      
      // Await the session to ensure we store it for closing later (though the API is promise based)
      sessionRef.current = await sessionPromise;

    } catch (e: any) {
      console.error(e);
      setConnectionState(LiveConnectionState.ERROR);
      setErrorMsg(e.message || "Failed to initialize audio session.");
    }
  };

  const stopSession = async () => {
    // 1. Stop Microphone
    if (mediaStreamRef.current) {
        mediaStreamRef.current.getTracks().forEach(track => track.stop());
        mediaStreamRef.current = null;
    }

    // 2. Disconnect Script Processor
    if (workletNodeRef.current && inputAudioContextRef.current) {
        workletNodeRef.current.disconnect();
        workletNodeRef.current = null;
    }

    // 3. Close Audio Contexts
    if (inputAudioContextRef.current) {
        await inputAudioContextRef.current.close();
        inputAudioContextRef.current = null;
    }
    if (outputAudioContextRef.current) {
        await outputAudioContextRef.current.close();
        outputAudioContextRef.current = null;
    }

    // 4. Close Gemini Session
    // Since sessionRef is the object returned by connect, assume it has a close method if specified in SDK
    // The prompt says: "When the conversation is finished, use `session.close()`"
    if (sessionRef.current) {
        sessionRef.current.close();
        sessionRef.current = null;
    }

    setConnectionState(LiveConnectionState.DISCONNECTED);
    setVolume(0);
    sourcesRef.current.clear();
  };

  return (
    <div className="flex flex-col items-center justify-center h-full bg-slate-900 p-8 relative overflow-hidden">
      
      {/* Background Pulse Effect */}
      {connectionState === LiveConnectionState.CONNECTED && (
        <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
            <div className="w-96 h-96 bg-indigo-500/10 rounded-full blur-3xl animate-pulse"></div>
        </div>
      )}

      {/* Visualizer */}
      <div className="relative z-10 w-full max-w-2xl h-64 bg-slate-800/50 backdrop-blur-md rounded-3xl border border-slate-700 shadow-2xl overflow-hidden mb-8">
        <canvas ref={canvasRef} width={800} height={300} className="w-full h-full" />
        <div className="absolute top-4 left-4 flex items-center gap-2">
            <div className={`w-3 h-3 rounded-full ${
                connectionState === LiveConnectionState.CONNECTED ? 'bg-green-500 animate-pulse' : 
                connectionState === LiveConnectionState.CONNECTING ? 'bg-yellow-500 animate-bounce' : 
                connectionState === LiveConnectionState.ERROR ? 'bg-red-500' : 'bg-slate-500'
            }`}></div>
            <span className="text-xs font-mono text-slate-400 uppercase tracking-wider">{connectionState}</span>
        </div>
      </div>

      {/* Controls */}
      <div className="relative z-10 flex flex-col items-center gap-6">
        <div className="text-slate-300 text-center space-y-2">
            <h2 className="text-2xl font-bold">Gemini Live</h2>
            <p className="text-slate-400 max-w-md">
                Experience real-time, low-latency voice conversations with Gemini 2.5 Flash.
            </p>
        </div>

        {errorMsg && (
            <div className="flex items-center gap-2 text-red-400 bg-red-900/20 px-4 py-2 rounded-lg border border-red-900/50">
                <AlertCircle className="w-4 h-4" />
                <span className="text-sm">{errorMsg}</span>
            </div>
        )}

        <button
            onClick={connectionState === LiveConnectionState.CONNECTED ? stopSession : startSession}
            disabled={connectionState === LiveConnectionState.CONNECTING}
            className={`group relative flex items-center justify-center w-20 h-20 rounded-full transition-all duration-300 ${
                connectionState === LiveConnectionState.CONNECTED
                    ? 'bg-red-500 hover:bg-red-600 shadow-[0_0_40px_-10px_rgba(239,68,68,0.5)]'
                    : 'bg-indigo-600 hover:bg-indigo-500 shadow-[0_0_40px_-10px_rgba(99,102,241,0.5)]'
            } ${connectionState === LiveConnectionState.CONNECTING ? 'opacity-70 scale-95 cursor-wait' : 'scale-100'}`}
        >
            {connectionState === LiveConnectionState.CONNECTED ? (
                <MicOff className="w-8 h-8 text-white" />
            ) : (
                <Mic className="w-8 h-8 text-white group-hover:scale-110 transition-transform" />
            )}
            
            {/* Ripple rings */}
            {connectionState === LiveConnectionState.CONNECTED && (
                 <>
                    <span className="absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-20 animate-ping"></span>
                    <span className="absolute inline-flex h-[120%] w-[120%] rounded-full bg-red-400 opacity-10 animate-ping animation-delay-200"></span>
                 </>
            )}
        </button>

        <div className="flex items-center gap-2 text-slate-500 text-sm">
            {connectionState === LiveConnectionState.CONNECTED ? (
                <div className="flex items-center gap-2">
                    <Activity className="w-4 h-4 animate-pulse text-green-400" />
                    <span>Listening...</span>
                </div>
            ) : (
                <div className="flex items-center gap-2">
                    <Volume2 className="w-4 h-4" />
                    <span>Ready to connect</span>
                </div>
            )}
        </div>
      </div>
    </div>
  );
};

default LiveInterface;

// Component: CardVisual

interface CardVisualProps {
  rankId: RankID;
  size?: 'sm' | 'md' | 'lg';
  className?: string;
}

const CardVisual: React.FC<CardVisualProps> = ({ rankId, size = 'md', className = '' }) => {
  const sizeClasses = {
    sm: 'w-10 h-14 text-[10px] rounded', // Reduced text size for sm
    md: 'w-28 h-40 text-xl rounded-xl',
    lg: 'w-56 h-80 text-5xl rounded-2xl',
  };

  const suit = 'â™ '; 
  const value = rankId.replace('â™ ', '');
  const isFaceCard = ['J', 'Q', 'K', 'A'].includes(value);
  const isAce = value === 'A';

  return (
    <div className={`
      relative bg-[#080808] shadow-2xl 
      flex flex-col items-center justify-center font-display font-bold select-none
      border border-white/10 overflow-hidden text-neutral-200
      transition-all duration-500 group-hover:border-white/20
      ${sizeClasses[size]} ${className}
      ${isFaceCard ? 'shadow-[0_0_30px_rgba(226,177,91,0.1)] border-brand-gold/20' : ''}
      ${isAce ? 'shadow-[0_0_50px_rgba(217,35,35,0.25)] border-brand-red/40' : ''}
    `}>
        {/* Metallic Texture */}
        <div className="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/brushed-alum.png')] mix-blend-overlay"></div>
        
        {/* Holographic Sheen on Hover */}
        <div className="absolute inset-0 bg-gradient-to-tr from-transparent via-white/5 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-1000 ease-in-out pointer-events-none z-20"></div>

        {/* Inner Border/Frame */}
        <div className="absolute inset-0.5 border border-white/5 rounded-[inherit] pointer-events-none"></div>

        {/* Corner Top Left */}
        <div className="absolute top-1 left-1.5 leading-none flex flex-col items-center">
            <span className={`${isAce ? 'text-brand-red' : isFaceCard ? 'text-brand-gold' : 'text-neutral-300'} font-display tracking-tight`}>{value}</span>
            <span className="text-[0.5em] text-neutral-600">{suit}</span>
        </div>

        {/* Center Symbol */}
        <div className={`relative z-10 transform group-hover:scale-110 transition-transform duration-500 flex items-center justify-center h-full
            ${isAce ? 'text-brand-red drop-shadow-[0_0_15px_rgba(217,35,35,0.6)] text-2xl md:text-6xl' : 
              isFaceCard ? 'text-brand-gold drop-shadow-[0_0_10px_rgba(226,177,91,0.4)]' : 'text-neutral-800'}
        `}>
           <span className={size === 'sm' && isAce ? 'text-xl' : ''}>{suit}</span> 
        </div>

        {/* Large Watermark */}
        {size === 'lg' && (
            <div className={`absolute inset-0 flex items-center justify-center opacity-5 font-black text-9xl pointer-events-none 
                ${isAce ? 'text-brand-red' : 'text-white'}`}>
                {value}
            </div>
        )}

        {/* Corner Bottom Right */}
        <div className="absolute bottom-1 right-1.5 leading-none flex flex-col items-center rotate-180">
            <span className={`${isAce ? 'text-brand-red' : isFaceCard ? 'text-brand-gold' : 'text-neutral-300'} font-display tracking-tight`}>{value}</span>
            <span className="text-[0.5em] text-neutral-600">{suit}</span>
        </div>

        {/* Ace Active Glow Animation */}
        {isAce && (
             <>
                <div className="absolute inset-0 bg-gradient-to-t from-brand-red/10 to-transparent opacity-50"></div>
                <div className="absolute bottom-0 left-0 right-0 h-2/3 bg-gradient-to-t from-brand-red/20 to-transparent blur-xl opacity-30 animate-pulse-slow"></div>
             </>
        )}
        
        {/* Face Card Gold Glow */}
        {!isAce && isFaceCard && (
             <div className="absolute inset-0 bg-gradient-to-tr from-brand-gold/5 via-transparent to-brand-gold/5 pointer-events-none"></div>
        )}
    </div>
  );
};

default CardVisual;

// Component: Nav

interface NavProps {
  user: User;
  activeTab: string;
  onTabChange: (tab: string) => void;
  onLogout: () => void;
}

const Nav: React.FC<NavProps> = ({ user, activeTab, onTabChange, onLogout }) => {
  const tabs = [
    { id: 'dashboard', label: 'Dashboard', icon: 'M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z' },
    { id: 'guide', label: '#SYSTEM GUIDE', icon: 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253' },
    { id: 'focus', label: 'Focus Realm', icon: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z' },
    { id: 'feed', label: 'Global Network', icon: 'M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z' },
    { id: 'gallery', label: 'The Vault', icon: 'M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 v12a2 2 0 002 2z' },
    { id: 'council', label: 'Council Chamber', icon: 'M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4' },
    { id: 'leaderboard', label: 'Elite Rankings', icon: 'M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z' },
    { id: 'settings', label: 'Settings', icon: 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z' },
  ];

  if (user.isAdmin) {
      tabs.push({ id: 'admin', label: 'Ace Controls', icon: 'M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z' });
  }

  return (
    <>
      <aside className="hidden md:flex flex-col w-72 h-screen fixed left-0 top-0 glass-panel border-r border-white/5 z-50">
        <div className="p-8 border-b border-white/5 relative overflow-hidden group">
          <div className="absolute top-0 left-0 w-1 h-full bg-brand-red shadow-[0_0_10px_#dc2626]"></div>
          <div className="absolute inset-0 bg-brand-red/5 opacity-0 group-hover:opacity-100 transition-opacity duration-1000"></div>
          <h1 className="text-3xl font-display font-black text-white tracking-widest leading-none">SPADES</h1>
          <p className="text-[10px] text-brand-red mt-2 uppercase tracking-[0.3em] font-bold">Protocol Hub</p>
        </div>

        <div className="flex-1 overflow-y-auto py-8 space-y-2 px-4">
          {tabs.map(tab => (
            <button
              key={tab.id}
              onClick={() => onTabChange(tab.id)}
              className={`group w-full flex items-center gap-4 px-4 py-4 rounded-xl transition-all duration-300 relative overflow-hidden ${
                activeTab === tab.id 
                  ? 'bg-gradient-to-r from-brand-red/20 to-transparent text-white border border-brand-red/10 shadow-[0_0_15px_rgba(220,38,38,0.1)]' 
                  : 'text-neutral-500 hover:bg-white/5 hover:text-white border border-transparent'
              }`}
            >
              <div className={`absolute left-0 top-0 bottom-0 w-0.5 transition-all duration-300 ${activeTab === tab.id ? 'bg-brand-red opacity-100' : 'bg-brand-red opacity-0 group-hover:opacity-50'}`}></div>
              <svg className={`w-5 h-5 transition-transform duration-300 ${activeTab === tab.id ? 'scale-110 text-brand-red' : 'group-hover:scale-110'} ${tab.id === 'guide' ? 'text-brand-gold' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
                 <path strokeLinecap="round" strokeLinejoin="round" d={tab.icon} />
              </svg>
              <span className={`font-display font-medium tracking-wide text-sm ${tab.id === 'guide' ? 'text-brand-gold font-bold' : ''}`}>{tab.label}</span>
            </button>
          ))}
        </div>

        <div className="p-4 mx-4 mb-4 rounded-xl bg-black/40 border border-white/10 relative overflow-hidden group hover:border-brand-gold/30 transition-colors duration-500">
          <div className="absolute inset-0 bg-gradient-to-t from-brand-gold/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none"></div>
          
          <div className="flex gap-4 items-center mb-3">
             <div className="shrink-0 transform group-hover:scale-105 transition-transform duration-500">
                <CardVisual rankId={user.currentCard} size="sm" />
             </div>
             <div className="min-w-0 flex-1">
                 <p className="text-sm font-bold text-white truncate font-display tracking-wide">{user.username}</p>
                 <div className="flex items-center gap-2 mt-1">
                     <div className="h-1.5 w-1.5 rounded-full bg-brand-red animate-pulse"></div>
                     <p className="text-[10px] text-neutral-400 font-mono truncate">{(user.totalPoints ?? 0).toLocaleString()} PTS</p>
                 </div>
             </div>
          </div>
          
          <button 
            type="button"
            onClick={(e) => {
                e.preventDefault();
                e.stopPropagation();
                onLogout();
            }}
            className="w-full py-2.5 rounded-lg bg-neutral-900 border border-white/5 hover:bg-red-950/20 hover:text-red-400 hover:border-red-900/30 text-[10px] text-neutral-500 font-bold uppercase tracking-widest transition-all relative z-10"
          >
            Terminate Session
          </button>
        </div>
      </aside>

      <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-black/95 backdrop-blur-xl border-t border-white/10 z-50 pb-safe">
        <div className="flex justify-around items-center h-20 px-2 overflow-x-auto">
          {tabs.map(tab => (
             <button
                key={tab.id}
                onClick={() => onTabChange(tab.id)}
                className={`flex flex-col items-center justify-center min-w-[60px] h-full space-y-1.5 transition-all duration-300 ${activeTab === tab.id ? 'text-brand-red' : 'text-neutral-600'}`}
             >
                <div className={`p-1.5 rounded-full ${activeTab === tab.id ? 'bg-brand-red/10' : ''}`}>
                    <svg className={`w-5 h-5 ${tab.id === 'guide' ? 'text-brand-gold' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" d={tab.icon} />
                    </svg>
                </div>
                <span className="text-[9px] uppercase font-bold tracking-wider">{tab.id === 'guide' ? 'GUIDE' : tab.label.split(' ')[0]}</span>
             </button>
          ))}
        </div>
      </nav>
    </>
  );
};

default Nav;

// Component: Feed

interface FeedProps {
  currentUser: User;
  refreshTrigger: number;
  onActivity: () => void;
}

const Feed: React.FC<FeedProps> = ({ currentUser, refreshTrigger, onActivity }) => {
  const [posts, setPosts] = useState<Post[]>([]);
  const [settings, setSettings] = useState<SystemSettings | null>(null);
  const [allUsers, setAllUsers] = useState<Record<string, User>>({});
  const [newPostContent, setNewPostContent] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isPollMode, setIsPollMode] = useState(false);
  const [pollOptions, setPollOptions] = useState<string[]>(['', '']);
  
  const [feedMode, setFeedMode] = useState<'public' | 'council'>('public');
  const [expandedTickets, setExpandedTickets] = useState<string[]>([]);
  const [ticketReply, setTicketReply] = useState<Record<string, string>>({});

  useEffect(() => {
    loadData();
  }, [refreshTrigger, feedMode]);

  const loadData = async () => {
    const [allPosts, s, usersList] = await Promise.all([
        storage.getPosts(), 
        storage.getSettings(),
        storage.getAllUsers()
    ]);
    
    // Create user map for live resolution of name/rank
    const userMap: Record<string, User> = {};
    usersList.forEach(u => userMap[u.studentId] = u);
    setAllUsers(userMap);

    let filteredPosts: Post[] = [];

    if (feedMode === 'public') {
        filteredPosts = allPosts.filter(p => (p.category === 'general' || p.category === 'poll' || p.category === 'announcement'));
    } else {
        if (isCouncilMember(currentUser)) {
            filteredPosts = allPosts.filter(p => p.category === 'ticket');
        } else {
            filteredPosts = allPosts.filter(p => p.category === 'ticket' && p.authorId === currentUser.studentId);
        }
    }
    setPosts(filteredPosts);
    setSettings(s);
  };

  const rankOrder: RankID[] = ['2â™ ', '3â™ ', '4â™ ', '5â™ ', '6â™ ', '7â™ ', '8â™ ', '9â™ ', '10â™ ', 'Jâ™ ', 'Qâ™ ', 'Kâ™ ', 'Aâ™ '];
  const userRankIdx = rankOrder.indexOf(currentUser.currentCard);
  const minRankIdx = settings ? rankOrder.indexOf(settings.minRankToPost) : 0;
  
  const isCouncilMember = (u: User) => {
      const idx = rankOrder.indexOf(u.currentCard);
      return idx >= 9 || u.isAdmin; 
  };

  const canPost = (userRankIdx >= minRankIdx || currentUser.isAdmin) && feedMode === 'public';
  const canSendTicket = feedMode === 'council'; 

  const handleCreatePost = async () => {
    if (!newPostContent.trim()) return;
    setIsSubmitting(true);
    
    // First sanitize (hashtags) then check extreme safety
    const sanitizedText = await sanitizeContent(newPostContent);
    const safetyCheck = await checkContentSafety(sanitizedText);
    const category = feedMode === 'council' ? 'ticket' : (isPollMode ? 'poll' : 'general');
    
    const newPost: Post = {
      id: `post-${Date.now()}`,
      authorId: currentUser.studentId,
      authorName: currentUser.username,
      authorRank: currentUser.currentCard,
      content: sanitizedText,
      category: category as any,
      status: safetyCheck.safe ? 'approved' : 'flagged',
      upvotes: [],
      downvotes: [],
      comments: [],
      pollOptions: isPollMode ? pollOptions.map(text => ({ text, votes: [] })) : undefined,
      createdAt: new Date().toISOString(),
    };

    await storage.savePost(newPost);
    await storage.saveUser({ ...currentUser, totalPoints: currentUser.totalPoints + POINT_VALUES.POST });
    
    setNewPostContent('');
    setIsSubmitting(false);
    loadData();
    onActivity();
  };

  const handleReplyToTicket = async (postId: string) => {
      const content = ticketReply[postId];
      if (!content?.trim()) return;

      const post = posts.find(p => p.id === postId);
      if (!post) return;

      const sanitizedComment = await sanitizeContent(content);

      const newComment: Comment = {
          id: `c-${Date.now()}`,
          authorId: currentUser.studentId,
          authorName: currentUser.username,
          content: sanitizedComment,
          createdAt: new Date().toISOString()
      };

      const updatedPost = {
          ...post,
          comments: [...(post.comments || []), newComment]
      };
      await storage.savePost(updatedPost);
      setTicketReply({...ticketReply, [postId]: ''});
      loadData();
  };

  const handlePurgePost = async (e: React.MouseEvent, postId: string) => {
      e.stopPropagation();
      e.preventDefault();
      setPosts(prev => prev.filter(p => p.id !== postId));
      await storage.deletePost(postId);
      onActivity();
  };

  const handleDeleteComment = async (e: React.MouseEvent, postId: string, commentId: string) => {
      e.stopPropagation();
      e.preventDefault();
      setPosts(prevPosts => prevPosts.map(p => {
          if (p.id === postId) {
              return { ...p, comments: p.comments.filter(c => c.id !== commentId) };
          }
          return p;
      }));
      await storage.deleteComment(postId, commentId);
  };

  const toggleTicket = (id: string) => {
      if (expandedTickets.includes(id)) setExpandedTickets(prev => prev.filter(i => i !== id));
      else setExpandedTickets(prev => [...prev, id]);
  };

  return (
    <div className="max-w-3xl mx-auto space-y-8 pb-32 animate-in fade-in duration-500">
      
      <div className="flex bg-black border border-white/10 rounded-xl p-1 relative z-10">
          <button 
            onClick={() => setFeedMode('public')}
            className={`flex-1 py-3 text-xs font-bold uppercase tracking-widest rounded-lg transition-all ${feedMode === 'public' ? 'bg-white text-black shadow-lg' : 'text-neutral-500 hover:text-white'}`}
          >
              Public Broadcast
          </button>
          <button 
            onClick={() => setFeedMode('council')}
            className={`flex-1 py-3 text-xs font-bold uppercase tracking-widest rounded-lg transition-all flex items-center justify-center gap-2 ${feedMode === 'council' ? 'bg-emerald-900/50 text-emerald-400 border border-emerald-500/50 shadow-[0_0_20px_rgba(16,185,129,0.2)]' : 'text-neutral-500 hover:text-emerald-500'}`}
          >
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
              Council Uplink
          </button>
      </div>

      <div className="flex justify-between items-center px-2">
         <h2 className={`text-xl font-display font-bold ${feedMode === 'council' ? 'text-emerald-500' : 'text-white'}`}>
            {feedMode === 'public' ? 'Global Network' : 'Secure Channel'}
         </h2>
         <div className="text-[10px] font-mono text-neutral-500 uppercase tracking-widest">
             Frequency: {feedMode === 'public' ? 'Open' : 'Encrypted'}
         </div>
      </div>

      {(canPost || canSendTicket) && (
          <div className={`glass-panel rounded-2xl border p-6 shadow-2xl relative overflow-hidden ${feedMode === 'council' ? 'border-emerald-500/20' : 'border-white/5'}`}>
            <div className={`absolute top-0 left-0 w-1 h-full bg-gradient-to-b ${feedMode === 'council' ? 'from-emerald-500 to-transparent' : 'from-brand-red to-transparent'}`}></div>
            <div className="flex gap-6">
                <div className="flex-1">
                    <textarea 
                        value={newPostContent} 
                        onChange={(e) => setNewPostContent(e.target.value)} 
                        placeholder={feedMode === 'council' ? "Send secure message to the High Table..." : "Share intelligence..."}
                        className="w-full bg-black/30 border border-white/10 rounded-xl p-4 text-sm text-white outline-none h-24 resize-none focus:border-white/20" 
                    />
                    <div className="flex justify-between items-center mt-4">
                        {feedMode === 'public' ? (
                             <button onClick={() => setIsPollMode(!isPollMode)} className="text-[10px] text-neutral-500 font-bold uppercase tracking-widest hover:text-white">
                                {isPollMode ? 'Poll Mode Active' : 'Toggle Poll'}
                             </button>
                        ) : (
                             <div className="text-[10px] text-emerald-600 font-mono flex items-center gap-2">
                                 <span className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                                 ENCRYPTED
                             </div>
                        )}
                        <button 
                            onClick={handleCreatePost} 
                            disabled={isSubmitting} 
                            className={`px-6 py-2 text-white text-xs font-bold uppercase rounded-lg shadow-lg ${
                                feedMode === 'council' 
                                ? 'bg-emerald-700 hover:bg-emerald-600' 
                                : 'bg-brand-red hover:bg-brand-red/80'
                            }`}
                        >
                            {isSubmitting ? '...' : (feedMode === 'council' ? 'Transmit' : 'Post')}
                        </button>
                    </div>
                </div>
            </div>
          </div>
      )}

      <div className="space-y-6">
        {posts.map(post => {
            const isAuthor = post.authorId === currentUser.studentId;
            const canDeletePost = currentUser.isAdmin || isAuthor;
            
            // Resolve current display name and rank from allUsers map
            const authorData = allUsers[post.authorId];
            const currentName = authorData?.username || post.authorName;
            const currentRank = authorData?.currentCard || post.authorRank;

            return (
            <div 
                key={post.id} 
                className={`glass-panel border rounded-2xl p-6 relative group ${
                    post.category === 'ticket' ? 'border-emerald-500/20 bg-emerald-950/10' : 'border-white/5'
                }`}
            >
                {canDeletePost && (
                    <button 
                        onClick={(e) => handlePurgePost(e, post.id)} 
                        className="absolute top-4 right-4 z-50 p-2 bg-black hover:bg-red-500 text-neutral-500 hover:text-white rounded-lg transition-all border border-white/10 hover:border-red-500 shadow-xl cursor-pointer"
                        title="Purge Post"
                    >
                        <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                )}
                
                <div className="flex items-center gap-4 mb-4">
                    <CardVisual rankId={currentRank} size="sm" />
                    <div>
                        <div className={`font-bold text-sm ${post.category === 'ticket' ? 'text-emerald-400' : 'text-white'}`}>
                            {currentName}
                            {post.category === 'ticket' && <span className="ml-2 text-[10px] bg-emerald-500/20 px-1.5 py-0.5 rounded border border-emerald-500/30">TICKET</span>}
                        </div>
                        <div className="text-[10px] text-neutral-600 font-mono">{new Date(post.createdAt).toLocaleDateString()}</div>
                    </div>
                </div>
                
                <p className="text-neutral-300 text-sm font-light leading-relaxed whitespace-pre-wrap">{post.content}</p>

                {post.category === 'ticket' && (
                    <div className="mt-6 border-t border-emerald-500/20 pt-4">
                        <button 
                            onClick={() => toggleTicket(post.id)}
                            className="text-[10px] font-bold uppercase tracking-widest text-emerald-600 hover:text-emerald-400 flex items-center gap-2"
                        >
                            {expandedTickets.includes(post.id) ? 'Hide Responses' : `View Responses (${post.comments?.length || 0})`}
                        </button>

                        {expandedTickets.includes(post.id) && (
                            <div className="mt-4 space-y-4 animate-in fade-in slide-in-from-top-2">
                                <div className="space-y-3 max-h-40 overflow-y-auto custom-scrollbar">
                                    {post.comments?.map(c => {
                                        const canDeleteComment = currentUser.isAdmin || c.authorId === currentUser.studentId;
                                        const commentAuthorData = allUsers[c.authorId];
                                        const currentCommenterName = commentAuthorData?.username || c.authorName;

                                        return (
                                            <div key={c.id} className="bg-emerald-900/20 border border-emerald-500/10 p-3 rounded-lg relative group/comment hover:bg-emerald-900/30 transition-colors">
                                                {canDeleteComment && (
                                                    <button 
                                                        onClick={(e) => handleDeleteComment(e, post.id, c.id)}
                                                        className="absolute top-2 right-2 bg-black text-neutral-500 hover:text-red-500 p-1.5 rounded transition-colors z-50 cursor-pointer border border-white/5"
                                                        title="Delete Comment"
                                                    >
                                                        <svg className="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                                                    </button>
                                                )}
                                                
                                                <div className="flex justify-between items-baseline mb-1 mr-8">
                                                    <span className="text-emerald-400 text-xs font-bold">{currentCommenterName}</span>
                                                    <span className="text-[9px] text-emerald-700/70">{new Date(c.createdAt).toLocaleTimeString()}</span>
                                                </div>
                                                <p className="text-neutral-300 text-xs pr-2">{c.content}</p>
                                            </div>
                                        );
                                    })}
                                    {(!post.comments || post.comments.length === 0) && <div className="text-neutral-600 text-xs italic">Awaiting Council Response...</div>}
                                </div>
                                
                                <div className="flex gap-2">
                                    <input 
                                        type="text" 
                                        value={ticketReply[post.id] || ''}
                                        onChange={e => setTicketReply({...ticketReply, [post.id]: e.target.value})}
                                        placeholder="Add response..."
                                        className="flex-1 bg-black/40 border border-emerald-500/30 rounded px-3 py-2 text-xs text-white outline-none focus:border-emerald-500"
                                    />
                                    <button 
                                        onClick={() => handleReplyToTicket(post.id)}
                                        className="px-4 py-2 bg-emerald-800 text-emerald-100 text-[10px] font-bold uppercase rounded hover:bg-emerald-700"
                                    >
                                        Reply
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                )}
            </div>
            );
        })}
        
        {posts.length === 0 && (
            <div className="text-center py-20 text-neutral-600 font-mono text-sm border-2 border-dashed border-white/5 rounded-2xl">
                {feedMode === 'public' ? 'No signals detected on the network.' : 'Secure Channel Clear. No tickets.'}
            </div>
        )}
      </div>
    </div>
  );
};

default Feed;

// Component: Dashboard

interface DashboardProps {
  user: User;
}

// Deterministic data generation correlated to real app state
const generateCorrelatedHistory = (currentVal: number, seed: string, points: number) => {
  const data = [];
  const now = new Date();
  
  // Use a simple hash of the seed to keep the path consistent for this specific state
  const hash = seed.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
  const safeVal = currentVal || 0;
  
  for (let i = points; i >= 0; i--) {
    const time = new Date(now.getTime() - i * 3600000);
    // Pseudo-randomness that is stable for the same seed/state
    const variance = Math.sin(hash + i) * 0.05 * safeVal;
    const price = Math.max(0.00001, safeVal + variance);
    
    data.push({
      time: time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
      price: parseFloat(price.toFixed(6)),
      timestamp: time.getTime()
    });
  }
  // Ensure the final point is EXACTLY the current calculated value
  if (data.length > 0) {
    data[data.length - 1].price = safeVal;
  }
  return data;
};

const MarketGraph: React.FC<{ 
  title: string; 
  data: any[]; 
  color: string; 
  currencySymbol: string;
  unitLabel: string;
}> = ({ title, data, color, currencySymbol, unitLabel }) => {
  const latestPrice = data && data.length > 0 ? (data[data.length - 1].price ?? 0) : 0;
  const previousPrice = data && data.length > 1 ? (data[data.length - 2].price ?? latestPrice) : latestPrice;
  const priceChange = latestPrice - previousPrice;
  const percentChange = previousPrice !== 0 ? (priceChange / previousPrice) * 100 : 0;

  return (
    <div className="glass-panel p-6 rounded-3xl border border-white/5 flex flex-col h-[380px] group hover:border-white/10 transition-all duration-500">
      <div className="flex justify-between items-start mb-6">
        <div>
          <h4 className="text-[10px] font-mono text-neutral-500 uppercase tracking-[0.3em] font-black mb-1">{title}</h4>
          <div className="flex items-baseline gap-2">
            <span className="text-2xl font-display font-black text-white">{currencySymbol}{latestPrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 })}</span>
            <span className="text-[10px] text-neutral-500 font-mono">/ {unitLabel}</span>
          </div>
        </div>
        <div className={`flex items-center gap-1 px-2 py-1 rounded-lg text-[10px] font-mono font-bold ${priceChange >= 0 ? 'text-emerald-500 bg-emerald-500/10' : 'text-red-500 bg-red-500/10'}`}>
          {priceChange >= 0 ? <ArrowUpRight size={12} /> : <ArrowDownRight size={12} />}
          {Math.abs(percentChange).toFixed(2)}%
        </div>
      </div>

      <div className="flex-1 w-full min-h-0">
        <ResponsiveContainer width="100%" height="100%">
          <AreaChart data={data}>
            <defs>
              <linearGradient id={`color-${title}`} x1="0" y1="0" x2="0" y2="1">
                <stop offset="5%" stopColor={color} stopOpacity={0.3}/>
                <stop offset="95%" stopColor={color} stopOpacity={0}/>
              </linearGradient>
            </defs>
            <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.03)" vertical={false} />
            <XAxis dataKey="time" hide />
            <YAxis hide domain={['auto', 'auto']} />
            <Tooltip 
              contentStyle={{ backgroundColor: '#0a0a0a', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '12px', fontSize: '10px' }}
              itemStyle={{ color: '#fff' }}
              labelStyle={{ color: '#666', marginBottom: '4px' }}
            />
            <Area 
              type="monotone" 
              dataKey="price" 
              stroke={color} 
              strokeWidth={2}
              fillOpacity={1} 
              fill={`url(#color-${title})`} 
              animationDuration={2000}
            />
          </AreaChart>
        </ResponsiveContainer>
      </div>
      
      <div className="mt-4 pt-4 border-t border-white/5 flex justify-between items-center text-[9px] font-mono text-neutral-600 uppercase tracking-widest">
        <span>Volatility: Mainframe Correlated</span>
        <div className="flex items-center gap-1.5">
          <Activity size={10} className="text-neutral-500 animate-pulse" />
          <span>Real-time System Logic</span>
        </div>
      </div>
    </div>
  );
};

const Dashboard: React.FC<DashboardProps> = ({ user }) => {
  const [convAmount, setConvAmount] = useState(1);
  const [econData, setEconData] = useState({
    totalPoints: 0,
    totalSpades: 0,
    vaultValue: 0,
    activeOperatives: 0
  });

  useEffect(() => {
    const fetchEcon = async () => {
      const [users, art] = await Promise.all([storage.getAllUsers(), storage.getArtPieces()]);
      const totals = users.reduce((acc, u) => ({
        points: acc.points + (u.totalPoints ?? 0),
        spades: acc.spades + (u.spadesBalance ?? 0),
        ops: acc.ops + (u.isGuest ? 0 : 1)
      }), { points: 0, spades: 0, ops: 0 });
      
      const vaultPoints = art.reduce((acc, a) => acc + (a.ownerId ? 0 : (a.price ?? 0)), 0);
      
      setEconData({
        totalPoints: totals.points,
        totalSpades: totals.spades,
        vaultValue: vaultPoints,
        activeOperatives: totals.ops
      });
    };
    fetchEcon();
  }, [user.totalPoints, user.spadesBalance]);

  const currentRank = RANKS[user.currentCard as RankID];
  const isMaxRank = user.currentCard === 'Aâ™ ';
  const rankSequence: RankID[] = ['2â™ ', '3â™ ', '4â™ ', '5â™ ', '6â™ ', '7â™ ', '8â™ ', '9â™ ', '10â™ ', 'Jâ™ ', 'Qâ™ ', 'Kâ™ ', 'Aâ™ '];
  const currentIndex = rankSequence.indexOf(user.currentCard as RankID);
  const nextRankId = isMaxRank ? 'Aâ™ ' : rankSequence[currentIndex + 1] || 'Aâ™ ';
  const nextRank = RANKS[nextRankId];
  
  const progress = isMaxRank 
    ? 100 
    : Math.min(99.9, Math.max(0, 
        (((user.totalPoints ?? 0) - currentRank.minPoints) / (nextRank.minPoints - currentRank.minPoints)) * 100
      ));

  // Economic Logic for Valuation
  // Spade Index: $1.00 base + (Total System Points / 10M for inflation resistance)
  const currentSpadeValue = useMemo(() => {
    const base = 1.00;
    const points = econData.totalPoints ?? 0;
    const vault = econData.vaultValue ?? 0;
    const inflationFactor = points / 10000000;
    const liquidityBonus = vault / 500000;
    return base + inflationFactor + liquidityBonus;
  }, [econData]);

  // Point Index: Pegged to Spade conversion rate with supply-demand multiplier
  const currentPointValue = useMemo(() => {
    const spadeVal = currentSpadeValue || 1.0;
    const points = econData.totalPoints ?? 0;
    const ops = econData.activeOperatives ?? 0;
    const standardRate = spadeVal / ECONOMY.POINT_TO_SPADE_CONVERSION;
    const scarcityMultiplier = points > 0 ? (ops / 100) : 1;
    return standardRate * (1 + (scarcityMultiplier * 0.01));
  }, [currentSpadeValue, econData]);

  const spadeMarketData = useMemo(() => 
    generateCorrelatedHistory(currentSpadeValue, `spade-${econData.totalSpades}-${econData.totalPoints}`, 24),
    [currentSpadeValue, econData.totalSpades, econData.totalPoints]
  );
  
  const pointsMarketData = useMemo(() => 
    generateCorrelatedHistory(currentPointValue, `point-${econData.totalPoints}-${econData.vaultValue}`, 24),
    [currentPointValue, econData.totalPoints, econData.vaultValue]
  );

  const handlePurchaseFreeze = async () => {
    const res = await storage.purchaseStreakFreeze(user.studentId);
    alert(res.message);
  };

  const handleConvert = async (dir: 'p2s' | 's2p') => {
    const res = await storage.convertCurrency(user.studentId, convAmount, dir);
    alert(res.message);
  };

  return (
    <div className="space-y-12 pb-32 animate-in fade-in duration-700 slide-in-from-bottom-4">
      
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 border-b border-white/5 pb-8">
          <div className="flex-1">
            <div className="flex items-center gap-3 mb-2">
                <h3 className="text-brand-red font-mono text-[10px] uppercase tracking-[0.4em] font-bold">Operational</h3>
                <div className="h-1.5 w-1.5 rounded-full bg-green-500 animate-pulse"></div>
            </div>
            <h1 className="text-4xl md:text-5xl font-display font-black text-white tracking-tighter uppercase italic">
                {user.username}
            </h1>
          </div>
          
          <div className="flex flex-wrap gap-4 items-center">
             <div className="glass-panel px-6 py-3 rounded-2xl border border-orange-500/20 bg-orange-500/5 flex items-center gap-3">
                <Flame className={`w-6 h-6 ${user.streak > 0 ? 'text-orange-500 fill-orange-500 animate-pulse' : 'text-neutral-700'}`} />
                <div>
                    <p className="text-[9px] text-neutral-500 font-bold uppercase tracking-widest">Streak</p>
                    <p className="text-xl font-display font-black text-white">{user.streak || 0}</p>
                </div>
             </div>

             <div className="glass-panel px-6 py-3 rounded-2xl border border-white/10 flex items-center gap-3">
                <Coins size={18} className="text-neutral-400" />
                <div>
                    <p className="text-[9px] text-neutral-500 font-bold uppercase tracking-widest">Points</p>
                    <p className="text-xl font-mono font-bold text-white">{(user.totalPoints ?? 0).toLocaleString()}</p>
                </div>
             </div>

             <div className="glass-panel px-6 py-3 rounded-2xl border border-brand-gold/30 bg-brand-gold/5 flex items-center gap-3 group hover:border-brand-gold transition-all">
                <span className="font-display font-black text-xl text-brand-gold">â™ </span>
                <div>
                    <p className="text-[9px] text-brand-gold font-bold uppercase tracking-widest">Spades</p>
                    <p className="text-xl font-display font-black text-white">{(user.spadesBalance ?? 0).toLocaleString()}</p>
                </div>
             </div>
          </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <div className="lg:col-span-7 glass-panel rounded-3xl p-10 relative overflow-hidden group">
            <div className="absolute inset-0 bg-gradient-to-br from-neutral-800/30 to-black/30 z-0"></div>
            <div className="absolute top-0 right-0 p-8 opacity-5 text-9xl font-display font-bold text-white select-none group-hover:scale-105 transition-transform duration-1000 z-0">
                {user.currentCard.replace('â™ ', '')}
            </div>
            
            <div className="relative z-10 flex flex-col sm:flex-row items-center sm:items-start gap-10">
                <div className="transform hover:scale-105 transition-transform duration-500 hover:rotate-2 shadow-2xl shadow-black/50">
                    <CardVisual rankId={user.currentCard as RankID} size="lg" />
                </div>
                <div className="flex-1 w-full text-center sm:text-left">
                    <div className="inline-block px-4 py-1.5 bg-brand-red/10 border border-brand-red/20 rounded-full text-brand-red text-[11px] font-black uppercase tracking-[0.2em] mb-4">
                        {currentRank.tier} Clearance
                    </div>
                    <h2 className="text-4xl font-display font-black text-white mb-3 tracking-tight">{currentRank.name}</h2>
                    <p className="text-neutral-400 text-base leading-relaxed mb-10 max-w-sm italic">
                        {isMaxRank 
                          ? "Ultimate authority attained. The Spades Protocol recognize your absolute sovereignty."
                          : `Tier: ${currentRank.tier}. High-value engagement detected.`
                        }
                    </p>

                    <div className="space-y-3">
                        <div className="flex justify-between text-[11px] font-mono font-bold text-neutral-500 uppercase tracking-widest">
                            <span className="text-brand-gold">Point Progression</span>
                            <span>{isMaxRank ? 'MAX' : `${Math.round(progress)}%`}</span>
                        </div>
                        <div className="h-2 bg-neutral-900 rounded-full overflow-hidden border border-white/5 p-0.5">
                            <div 
                                className="h-full bg-gradient-to-r from-brand-red via-brand-crimson to-brand-gold rounded-full shadow-[0_0_15px_rgba(220,38,38,0.5)]"
                                style={{ width: `${progress}%`, transition: 'width 1.5s cubic-bezier(0.4, 0, 0.2, 1)' }}
                            />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div className="lg:col-span-5 space-y-6">
            <div className="glass-panel p-8 rounded-3xl border border-blue-500/20 bg-blue-500/5">
                <div className="flex justify-between items-center mb-6">
                    <h3 className="text-sm font-black text-white uppercase tracking-widest flex items-center gap-2">
                        <ShieldCheck className="text-blue-400 w-5 h-5" />
                        Streak Freezes
                    </h3>
                    <span className="text-[10px] font-mono text-neutral-500 uppercase">{user.streakFreezes ?? 0} / {ECONOMY.MAX_STREAK_FREEZES || 2}</span>
                </div>
                
                <div className="flex gap-4 mb-6">
                    {[...Array(2)].map((_, i) => (
                        <div key={i} className={`flex-1 h-12 rounded-2xl border-2 flex items-center justify-center transition-all ${(user.streakFreezes ?? 0) > i ? 'border-blue-500/40 bg-blue-500/20 text-blue-400 shadow-glow' : 'border-dashed border-neutral-800'}`}>
                            {(user.streakFreezes ?? 0) > i ? <Flame size={24} /> : <div className="w-1 h-1 rounded-full bg-neutral-800" />}
                        </div>
                    ))}
                </div>

                <button 
                    onClick={handlePurchaseFreeze}
                    disabled={(user.streakFreezes ?? 0) >= 2 || (user.totalPoints ?? 0) < ECONOMY.STREAK_FREEZE_POINT_COST}
                    className="w-full py-4 rounded-xl bg-white text-black font-black uppercase text-[11px] tracking-widest hover:bg-blue-400 transition-all disabled:opacity-30 shadow-xl"
                >
                    Buy Freeze ({(ECONOMY.STREAK_FREEZE_POINT_COST ?? 0).toLocaleString()} PTS)
                </button>
            </div>

            <div className="glass-panel p-8 rounded-3xl border border-white/5 space-y-6">
                <h3 className="text-sm font-black text-white uppercase tracking-widest flex items-center gap-2">
                    <RefreshCw className="text-brand-gold w-5 h-5" />
                    Currency Exchange
                </h3>
                <div className="flex items-center gap-4 bg-black/40 p-1 rounded-2xl border border-white/10">
                    <input 
                        type="number" 
                        value={convAmount} 
                        onChange={e => setConvAmount(Math.max(1, parseInt(e.target.value)))}
                        className="bg-transparent text-white font-mono font-bold w-full pl-4 outline-none text-xl"
                    />
                    <div className="px-4 py-2 text-brand-gold font-mono font-black text-sm uppercase">Spades</div>
                </div>
                <div className="grid grid-cols-2 gap-4">
                    <button onClick={() => handleConvert('p2s')} className="py-3 bg-white/5 border border-white/10 rounded-xl text-[10px] font-black uppercase text-neutral-400 hover:text-white hover:bg-white/10 transition-all leading-tight">
                        Convert P to S <br/> (-{(ECONOMY.POINT_TO_SPADE_CONVERSION * convAmount).toLocaleString()} P)
                    </button>
                    <button onClick={() => handleConvert('s2p')} className="py-3 bg-brand-gold/10 border border-brand-gold/30 rounded-xl text-[10px] font-black uppercase text-brand-gold hover:bg-brand-gold hover:text-black transition-all leading-tight">
                        Convert S to P <br/> (+{(ECONOMY.SPADE_TO_POINT_CONVERSION * convAmount).toLocaleString()} P)
                    </button>
                </div>
            </div>
        </div>
      </div>

      <section className="space-y-10 pt-10 border-t border-white/5">
          <div className="flex items-center gap-4">
              <h3 className="text-neutral-500 font-mono text-[10px] uppercase tracking-[0.4em] font-black">System Mechanics Manual</h3>
              <div className="h-px flex-1 bg-gradient-to-r from-neutral-800 to-transparent"></div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
              <div className="glass-panel p-8 rounded-3xl border border-white/5 space-y-4">
                  <div className="flex items-center gap-3 text-orange-500">
                    <Flame size={20} />
                    <h4 className="text-lg font-display font-black text-white uppercase italic">Daily Streaks</h4>
                  </div>
                  <ul className="text-sm text-neutral-400 space-y-2 list-disc list-inside">
                      <li>Log in every 24 hours to keep your streak active.</li>
                      <li>Missing a day resets your streak to 0.</li>
                      <li>Active <span className="text-blue-400">Streak Freezes</span> protect you once per missed day.</li>
                  </ul>
              </div>

              <div className="glass-panel p-8 rounded-3xl border border-white/5 space-y-4">
                  <div className="flex items-center gap-3 text-neutral-400">
                    <Coins size={20} />
                    <h4 className="text-lg font-display font-black text-white uppercase italic">Power Points</h4>
                  </div>
                  <ul className="text-sm text-neutral-400 space-y-2 list-disc list-inside">
                      <li>Earned via focus sessions, voting, and network activity.</li>
                      <li>Used for rank tiers, shop items, and streak protection.</li>
                      <li>Convertible to premium Spades at a {(ECONOMY.POINT_TO_SPADE_CONVERSION ?? 0).toLocaleString()}:1 ratio.</li>
                  </ul>
              </div>

              <div className="glass-panel p-8 rounded-3xl border border-white/5 space-y-4 flex flex-col">
                  <div className="flex items-center gap-3 text-brand-gold mb-4">
                    <span className="font-display font-black text-xl">â™ </span>
                    <h4 className="text-lg font-display font-black text-white uppercase italic">Spades Currency</h4>
                  </div>
                  <ul className="text-sm text-neutral-400 space-y-2 list-disc list-inside mb-6 flex-1">
                      <li>Dynamic currency: Value fluctuates based on protocol liquidity and network activity.</li>
                      <li>Amazon gift cards accepted via <strong>@hydraulic-bolt</strong> on Discord for manual balance updates.</li>
                      <li>Spades convert to Points at a 1:{(ECONOMY.SPADE_TO_POINT_CONVERSION ?? 0).toLocaleString()} ratio.</li>
                  </ul>
                  
                  {/* Live Exchange Rate Box */}
                  <div className="bg-brand-gold/5 border border-brand-gold/20 rounded-2xl p-4 flex flex-col items-center justify-center animate-in zoom-in duration-1000">
                      <p className="text-[10px] font-mono font-black text-brand-gold uppercase tracking-widest mb-1">Live Valuation</p>
                      <div className="text-2xl font-display font-black text-white">1 â™  â‰ˆ ${currentSpadeValue.toFixed(2)}</div>
                      <p className="text-[8px] text-neutral-600 uppercase font-bold mt-1 tracking-tighter">Verified by Mainframe</p>
                  </div>
              </div>
          </div>
      </section>

      {/* Deterministic Market Section */}
      <section className="space-y-10 pt-16 border-t border-white/5 pb-20">
          <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                  <h3 className="text-brand-gold font-mono text-[10px] uppercase tracking-[0.4em] font-black">Protocol Market Index</h3>
                  <div className="h-px w-32 bg-gradient-to-r from-brand-gold to-transparent"></div>
              </div>
              <div className="flex items-center gap-2 text-[9px] font-mono text-neutral-500 uppercase tracking-widest">
                  <TrendingUp size={14} className="text-brand-gold" />
                  Mainframe Correlated Valuation
              </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
              <MarketGraph 
                title="Spades (â™ ) Valuation" 
                data={spadeMarketData} 
                color="#e2b15b" 
                currencySymbol="$" 
                unitLabel="Spade"
              />
              <MarketGraph 
                title="Power Points (P) Market Index" 
                data={pointsMarketData} 
                color="#d92323" 
                currencySymbol="$" 
                unitLabel="Point"
              />
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div className="glass-panel p-8 rounded-3xl border border-white/5 bg-black/40">
                  <div className="flex items-center gap-3 mb-6 text-brand-gold">
                      <Database size={18} />
                      <h4 className="text-xs font-black uppercase tracking-widest">Circulating Data Terminal</h4>
                  </div>
                  <div className="grid grid-cols-2 gap-6">
                      <div className="space-y-1">
                          <p className="text-[9px] text-neutral-500 uppercase font-mono tracking-widest">Total Spades (â™ )</p>
                          <p className="text-lg font-display font-bold text-white tracking-tight">{(econData.totalSpades ?? 0).toLocaleString()}</p>
                      </div>
                      <div className="space-y-1">
                          <p className="text-[9px] text-neutral-500 uppercase font-mono tracking-widest">Total Points (P)</p>
                          <p className="text-lg font-display font-bold text-white tracking-tight">{(econData.totalPoints ?? 0).toLocaleString()}</p>
                      </div>
                      <div className="space-y-1">
                          <p className="text-[9px] text-neutral-500 uppercase font-mono tracking-widest">Vault Liquidity (P)</p>
                          <p className="text-lg font-display font-bold text-white tracking-tight">{(econData.vaultValue ?? 0).toLocaleString()}</p>
                      </div>
                      <div className="space-y-1">
                          <p className="text-[9px] text-neutral-500 uppercase font-mono tracking-widest">Active Nodes</p>
                          <p className="text-lg font-display font-bold text-white tracking-tight">{(econData.activeOperatives ?? 0).toLocaleString()}</p>
                      </div>
                  </div>
              </div>

              <div className="glass-panel p-8 rounded-3xl border border-white/5 bg-black/40">
                  <div className="flex items-center gap-3 mb-4 text-brand-gold">
                      <Info size={18} />
                      <h4 className="text-xs font-black uppercase tracking-widest">Index Analysis</h4>
                  </div>
                  <ul className="space-y-3 text-[11px] text-neutral-400 font-light leading-relaxed">
                      <li className="flex gap-2">
                          <span className="text-brand-gold font-bold">1.</span>
                          <span><strong>Real-Time Correlation:</strong> These graphs are directly tied to the total points, spades, and vault assets currently held by all members.</span>
                      </li>
                      <li className="flex gap-2">
                          <span className="text-brand-gold font-bold">2.</span>
                          <span><strong>Economic Stability:</strong> Fluctuations represent calculated variance based on the ratio of active nodes to total system wealth.</span>
                      </li>
                      <li className="flex gap-2">
                          <span className="text-brand-gold font-bold">3.</span>
                          <span><strong>Scarcity Metrics:</strong> As the Vault empties and Points circulate, the base valuation of both currencies rises relative to the USD peg.</span>
                      </li>
                  </ul>
              </div>
          </div>

          <div className="glass-panel p-8 rounded-3xl border border-white/5 bg-black/40 flex items-center justify-center italic text-center">
              <p className="text-[11px] text-neutral-500 leading-relaxed font-light">
                * Market values are derived from actual system state. Fluctuations reflect real-time engagement cycles across the Discord ecosystem.
                Values are deterministic and recalculated upon every mainframe heartbeat.
              </p>
          </div>
      </section>
    </div>
  );
};

default Dashboard;

// Component: Leaderboard

const Leaderboard: React.FC = () => {
  const [users, setUsers] = useState<User[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchUsers = async () => {
      const allUsers = await storage.getAllUsers();
      // Filter out guests and sort by points desc
      const sorted = allUsers
        .filter(u => !u.isGuest)
        .sort((a, b) => (b.totalPoints ?? 0) - (a.totalPoints ?? 0));
      setUsers(sorted);
      setLoading(false);
    };
    fetchUsers();
  }, []);

  if (loading) return (
      <div className="flex flex-col items-center justify-center h-64 space-y-4">
          <div className="w-12 h-1 bg-neutral-800 rounded-full overflow-hidden">
              <div className="w-full h-full bg-brand-red animate-shine" style={{backgroundSize: '200% auto'}}></div>
          </div>
          <p className="text-xs font-mono text-neutral-500 uppercase tracking-widest">Accessing Mainframe...</p>
      </div>
  );

  return (
    <div className="pb-32 animate-in fade-in duration-700">
      <div className="flex items-center justify-between mb-12">
        <div>
            <h2 className="text-3xl font-display font-bold text-white tracking-wide">Elite Rankings</h2>
            <p className="text-neutral-500 text-xs mt-1 font-mono uppercase tracking-widest">Global Competition â€¢ Season 1</p>
        </div>
        <div className="flex items-center gap-2">
            <span className="w-2 h-2 bg-brand-red rounded-full animate-pulse"></span>
            <span className="text-[10px] font-mono text-brand-red font-bold">LIVE</span>
        </div>
      </div>

      {/* Top 3 Podium */}
      <div className="flex items-end justify-center gap-4 md:gap-8 mb-16 px-4">
        {users[1] && (
            <div className="flex flex-col items-center group relative w-1/3 max-w-[140px]">
                <div className="absolute inset-0 bg-white/5 blur-2xl rounded-full opacity-0 group-hover:opacity-20 transition-opacity"></div>
                <CardVisual rankId={users[1].currentCard} size="md" className="mb-4 transform group-hover:-translate-y-4 transition-transform duration-500 relative z-10" />
                <div className="w-full bg-gradient-to-b from-neutral-400 to-neutral-600 h-32 flex flex-col items-center justify-start pt-4 rounded-t-xl relative overflow-hidden border-t border-white/20">
                     <div className="absolute top-0 inset-x-0 h-px bg-white/50"></div>
                     <span className="text-4xl font-display font-black text-white/20 mb-1">2</span>
                     <span className="text-xs font-bold text-white truncate w-24 text-center px-2">{users[1].username}</span>
                     <span className="text-[10px] text-neutral-300 font-mono mt-1">{(users[1].totalPoints ?? 0).toLocaleString()}</span>
                </div>
            </div>
        )}
        {users[0] && (
            <div className="flex flex-col items-center group relative w-1/3 max-w-[160px] z-10 -mx-2">
                 <div className="absolute inset-0 bg-brand-gold/10 blur-3xl rounded-full opacity-50 animate-pulse-slow"></div>
                 <div className="relative">
                    <div className="absolute -top-10 left-1/2 -translate-x-1/2 text-brand-gold text-2xl animate-float filter drop-shadow-[0_0_10px_rgba(251,191,36,0.5)]">ðŸ‘‘</div>
                    <CardVisual rankId={users[0].currentCard} size="lg" className="mb-6 transform group-hover:-translate-y-4 transition-transform duration-500 shadow-[0_0_40px_rgba(251,191,36,0.2)]" />
                </div>
                <div className="w-full bg-gradient-to-b from-brand-gold to-yellow-700 h-44 flex flex-col items-center justify-start pt-6 rounded-t-xl relative overflow-hidden border-t border-white/30 shadow-2xl">
                    <div className="absolute top-0 inset-x-0 h-px bg-white/60"></div>
                    <span className="text-5xl font-display font-black text-white/20 mb-2">1</span>
                    <span className="text-sm font-bold text-white truncate w-32 text-center px-2">{users[0].username}</span>
                    <span className="text-[10px] text-yellow-100 font-mono font-bold mt-1 bg-black/20 px-2 py-0.5 rounded">{(users[0].totalPoints ?? 0).toLocaleString()} PTS</span>
                </div>
            </div>
        )}
        {users[2] && (
            <div className="flex flex-col items-center group relative w-1/3 max-w-[140px]">
                <div className="absolute inset-0 bg-brand-red/5 blur-2xl rounded-full opacity-0 group-hover:opacity-20 transition-opacity"></div>
                <CardVisual rankId={users[2].currentCard} size="md" className="mb-4 transform group-hover:-translate-y-4 transition-transform duration-500 relative z-10" />
                <div className="w-full bg-gradient-to-b from-brand-darkRed to-neutral-900 h-24 flex flex-col items-center justify-start pt-4 rounded-t-xl relative overflow-hidden border-t border-white/20">
                    <div className="absolute top-0 inset-x-0 h-px bg-white/40"></div>
                    <span className="text-4xl font-display font-black text-white/20 mb-1">3</span>
                    <span className="text-xs font-bold text-neutral-300 truncate w-24 text-center px-2">{users[2].username}</span>
                    <span className="text-[10px] text-neutral-500 font-mono mt-1">{(users[2].totalPoints ?? 0).toLocaleString()}</span>
                </div>
            </div>
        )}
      </div>

      {/* List */}
      <div className="glass-panel border border-white/5 rounded-2xl overflow-hidden backdrop-blur-md">
        <div className="grid grid-cols-12 gap-4 px-6 py-3 border-b border-white/5 text-[10px] font-mono text-neutral-500 uppercase tracking-widest">
             <div className="col-span-1 text-center">Rank</div>
             <div className="col-span-7">Agent</div>
             <div className="col-span-4 text-right">Score</div>
        </div>
        
        {users.slice(3).map((user, index) => (
            <div key={user.studentId} className="grid grid-cols-12 gap-4 items-center px-6 py-4 border-b border-white/5 hover:bg-white/5 transition-colors group">
                <div className="col-span-1 text-center font-mono font-bold text-neutral-600 group-hover:text-white transition-colors">
                    {index + 4}
                </div>
                <div className="col-span-7 flex items-center gap-4">
                     <div className="w-8 h-10 rounded bg-neutral-900 border border-white/5 flex items-center justify-center text-xs font-bold text-neutral-400 group-hover:border-brand-red/30 transition-colors">
                         {user.currentCard.replace('â™ ', '')}
                     </div>
                     <div className="min-w-0">
                        <div className="font-bold text-sm text-neutral-300 group-hover:text-white truncate transition-colors">{user.username}</div>
                        <div className="text-[10px] text-neutral-600 group-hover:text-neutral-500">{user.house}</div>
                     </div>
                </div>
                <div className="col-span-4 text-right">
                    <div className="font-mono text-brand-gold font-bold">{(user.totalPoints ?? 0).toLocaleString()}</div>
                </div>
            </div>
        ))}
      </div>
    </div>
  );
};

default Leaderboard;

// Component: CouncilChamber

interface CouncilChamberProps {
  currentUser: User;
  refreshTrigger: number;
  onActivity: () => void;
}

const CouncilChamber: React.FC<CouncilChamberProps> = ({ currentUser, refreshTrigger, onActivity }) => {
  const [posts, setPosts] = useState<Post[]>([]);
  const [newProposal, setNewProposal] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [allUsers, setAllUsers] = useState<Record<string, User>>({});
  
  const [commentInputs, setCommentInputs] = useState<Record<string, string>>({});
  const [expandedComments, setExpandedComments] = useState<string[]>([]);

  const rankOrder: RankID[] = ['2â™ ', '3â™ ', '4â™ ', '5â™ ', '6â™ ', '7â™ ', '8â™ ', '9â™ ', '10â™ ', 'Jâ™ ', 'Qâ™ ', 'Kâ™ ', 'Aâ™ '];
  const userRankIndex = rankOrder.indexOf(currentUser.currentCard);
  const canPropose = userRankIndex > 9; 
  const canModerate = currentUser.isAdmin || userRankIndex >= 11; 

  useEffect(() => {
    loadProposals();
  }, [refreshTrigger]);

  const loadProposals = async () => {
    const [allPosts, usersList] = await Promise.all([storage.getPosts(), storage.getAllUsers()]);
    const userMap: Record<string, User> = {};
    usersList.forEach(u => userMap[u.studentId] = u);
    setAllUsers(userMap);
    const proposals = allPosts.filter(p => p.category === 'proposal');
    setPosts(proposals);
  };

  const calculateScore = (post: Post) => {
      let score = 0;
      post.upvotes.forEach(uid => {
          const voter = allUsers[uid];
          const weight = voter ? RANKS[voter.currentCard].voteWeight : 1;
          score += weight;
      });
      post.downvotes?.forEach(uid => {
          const voter = allUsers[uid];
          const weight = voter ? RANKS[voter.currentCard].voteWeight : 1;
          score -= weight;
      });
      return score;
  };

  const handleCreateProposal = async () => {
    if (!newProposal.trim() || !canPropose) return;
    setIsSubmitting(true);

    const sanitizedProposal = await sanitizeContent(newProposal);
    const safetyCheck = await checkContentSafety(sanitizedProposal);
    
    let status: Post['status'] = 'approved';
    if (!safetyCheck.safe) status = 'flagged';
    
    const post: Post = {
      id: `proposal-${Date.now()}`,
      authorId: currentUser.studentId,
      authorName: currentUser.username,
      authorRank: currentUser.currentCard,
      content: sanitizedProposal,
      category: 'proposal',
      status: status,
      upvotes: [],
      downvotes: [],
      comments: [],
      createdAt: new Date().toISOString(),
    };

    await storage.savePost(post);
    setNewProposal('');
    setIsSubmitting(false);
    loadProposals();
    onActivity();
  };

  const handleVote = async (post: Post, type: 'up' | 'down') => {
    if (post.status === 'passed' || post.status === 'failed') return;
    if (post.upvotes.includes(currentUser.studentId) || (post.downvotes && post.downvotes.includes(currentUser.studentId))) {
        return; 
    }

    const isUp = type === 'up';
    let newUpvotes = [...post.upvotes];
    let newDownvotes = [...(post.downvotes || [])];

    if (isUp) {
        newUpvotes.push(currentUser.studentId);
    } else {
        newDownvotes.push(currentUser.studentId);
    }

    const updatedPost = {
        ...post,
        upvotes: newUpvotes,
        downvotes: newDownvotes
    };
    await storage.savePost(updatedPost);

    const freshUser = await storage.getUser(currentUser.studentId);
    if (freshUser) {
        const updatedUser = { 
            ...freshUser, 
            totalPoints: freshUser.totalPoints + POINT_VALUES.VOTE_ACTION,
            stats: {
                ...freshUser.stats,
                votesGiven: freshUser.stats.votesGiven + 1
            }
        };
        await storage.saveUser(updatedUser);
        onActivity(); 
    }

    loadProposals();
  };

  const handleProposalDecision = async (post: Post, decision: 'pass' | 'fail') => {
      const newStatus: Post['status'] = decision === 'pass' ? 'passed' : 'failed';
      const updatedPost = { ...post, status: newStatus };
      await storage.savePost(updatedPost);
      loadProposals();
  };

  const handleDeleteProposal = async (e: React.MouseEvent, postId: string) => {
      e.stopPropagation();
      e.preventDefault();
      setPosts(prev => prev.filter(p => p.id !== postId));
      await storage.deletePost(postId);
      onActivity(); 
  };

  const handleAddComment = async (postId: string) => {
    const content = commentInputs[postId];
    if (!content?.trim()) return;

    const post = posts.find(p => p.id === postId);
    if (!post) return;

    const sanitizedComment = await sanitizeContent(content);

    const newComment: Comment = {
        id: `c-${Date.now()}`,
        authorId: currentUser.studentId,
        authorName: currentUser.username,
        content: sanitizedComment.trim(),
        createdAt: new Date().toISOString()
    };

    const updatedPost = {
        ...post,
        comments: [...(post.comments || []), newComment]
    };
    await storage.savePost(updatedPost);
    setCommentInputs({ ...commentInputs, [postId]: '' });
    loadProposals();
  };

  const handleDeleteComment = async (e: React.MouseEvent, postId: string, commentId: string) => {
      e.stopPropagation();
      e.preventDefault();
      setPosts(prevPosts => prevPosts.map(p => {
          if (p.id === postId && p.comments) {
              return { ...p, comments: p.comments.filter(c => c.id !== commentId) };
          }
          return p;
      }));
      await storage.deleteComment(postId, commentId);
  };

  const toggleComments = (postId: string) => {
    if (expandedComments.includes(postId)) {
        setExpandedComments(expandedComments.filter(id => id !== postId));
    } else {
        setExpandedComments([...expandedComments, postId]);
    }
  };

  return (
    <div className="max-w-4xl mx-auto space-y-12 pb-32 animate-in fade-in duration-700">
      <div className="text-center py-8 relative">
           <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-brand-gold/5 blur-[80px] rounded-full pointer-events-none"></div>
           <h1 className="text-4xl md:text-5xl font-display font-black text-white tracking-tight relative z-10 mb-2">THE COUNCIL CHAMBER</h1>
           <p className="text-brand-gold font-mono text-xs uppercase tracking-[0.4em] relative z-10">High Table Policy Proposals</p>
      </div>

      {canPropose ? (
          <div className="glass-panel rounded-2xl border border-brand-gold/20 p-8 shadow-[0_0_50px_rgba(0,0,0,0.5)] relative overflow-hidden group">
            <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-brand-gold to-transparent"></div>
            <div className="flex gap-8">
                <div className="hidden sm:block">
                    <CardVisual rankId={currentUser.currentCard} size="md" className="shadow-[0_0_20px_rgba(251,191,36,0.1)]" />
                </div>
                <div className="flex-1">
                    <div className="mb-4 flex justify-between items-center">
                        <span className="text-brand-gold font-display font-bold uppercase tracking-widest text-sm">Submit New Directive</span>
                        <div className="px-2 py-1 rounded bg-brand-gold/10 border border-brand-gold/20 text-[10px] text-brand-gold font-mono uppercase">
                            Clearance Verified
                        </div>
                    </div>
                    <textarea
                        value={newProposal}
                        onChange={(e) => setNewProposal(e.target.value)}
                        placeholder="Outline your policy for the future of the community..."
                        className="w-full bg-black/50 border border-brand-gold/20 rounded-xl p-6 text-base text-white placeholder-neutral-600 focus:border-brand-gold focus:ring-1 focus:ring-brand-gold/50 focus:outline-none resize-none h-40 transition-all font-serif italic leading-relaxed"
                    />
                    <div className="flex justify-end mt-6">
                        <button
                            onClick={handleCreateProposal}
                            disabled={isSubmitting || !newProposal.trim()}
                            className={`px-8 py-3 rounded-lg font-bold text-xs uppercase tracking-[0.2em] transition-all duration-300 ${
                                isSubmitting || !newProposal.trim()
                                ? 'bg-neutral-900 text-neutral-600 cursor-not-allowed border border-neutral-800'
                                : 'bg-brand-gold hover:bg-yellow-400 text-black shadow-[0_0_20px_rgba(251,191,36,0.4)] hover:shadow-[0_0_30px_rgba(251,191,36,0.6)]'
                            }`}
                        >
                            {isSubmitting ? 'Submitting...' : 'Table Proposal'}
                        </button>
                    </div>
                </div>
            </div>
          </div>
      ) : (
          <div className="glass-panel p-6 rounded-xl border border-white/5 text-center flex flex-col items-center gap-4">
              <svg className="w-8 h-8 text-neutral-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
              <p className="text-neutral-500 font-mono text-xs uppercase tracking-widest">Proposal Submission Restricted to Jack+ Clearance</p>
          </div>
      )}

      <div className="space-y-8">
        {posts.map(post => {
            const score = calculateScore(post);
            const isPassed = post.status === 'passed';
            const isFailed = post.status === 'failed';
            const isActive = !isPassed && !isFailed;
            const userVoted = post.upvotes.includes(currentUser.studentId) || (post.downvotes && post.downvotes.includes(currentUser.studentId));
            const isAuthor = post.authorId === currentUser.studentId;
            
            // Resolve live identity for author
            const authorData = allUsers[post.authorId];
            const currentName = authorData?.username || post.authorName;
            const currentRank = authorData?.currentCard || post.authorRank;

            return (
                <div key={post.id} className={`glass-panel border rounded-2xl p-8 transition-all duration-500 group relative overflow-visible ${
                    isPassed ? 'border-emerald-500/30 bg-emerald-950/10' :
                    isFailed ? 'border-red-500/30 bg-red-950/10' :
                    'border-brand-gold/10 hover:border-brand-gold/30'
                }`}>
                    {(currentUser.isAdmin || isAuthor) && (
                        <button 
                            onClick={(e) => handleDeleteProposal(e, post.id)}
                            className="absolute top-4 right-4 z-50 p-2 bg-black hover:bg-red-500 text-neutral-500 hover:text-white rounded-lg transition-all border border-white/10 hover:border-red-500 shadow-xl cursor-pointer"
                            title="Delete Proposal"
                        >
                            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    )}

                    {isPassed && <div className="absolute top-0 right-0 p-4 opacity-10 rotate-12 text-6xl text-emerald-500 font-black border-4 border-emerald-500 rounded-lg pointer-events-none">PASSED</div>}
                    {isFailed && <div className="absolute top-0 right-0 p-4 opacity-10 -rotate-12 text-6xl text-red-500 font-black border-4 border-red-500 rounded-lg pointer-events-none">REJECTED</div>}
                    
                    <div className="flex flex-col md:flex-row gap-8 relative z-10">
                        <div className="flex md:flex-col items-center gap-4 md:gap-2 justify-center md:justify-start min-w-[60px]">
                            <button 
                                onClick={() => handleVote(post, 'up')}
                                disabled={!isActive || userVoted}
                                className={`p-2 rounded-full transition-all duration-200 ${
                                    (!isActive || userVoted) ? 'opacity-30 cursor-not-allowed' : 'hover:scale-110'
                                } ${post.upvotes.includes(currentUser.studentId) ? 'text-green-500 bg-green-500/10' : 'text-neutral-500 hover:text-green-400 hover:bg-white/5'}`}
                                title={userVoted ? "Vote Cast Locked" : "Vote Yes"}
                            >
                                <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M5 15l7-7 7 7" /></svg>
                            </button>
                            
                            <span className={`text-2xl font-display font-bold ${score > 0 ? 'text-brand-gold' : score < 0 ? 'text-brand-red' : 'text-white'}`}>
                                {score > 0 ? '+' : ''}{score}
                            </span>
                            
                            <button 
                                onClick={() => handleVote(post, 'down')}
                                disabled={!isActive || userVoted}
                                className={`p-2 rounded-full transition-all duration-200 ${
                                    (!isActive || userVoted) ? 'opacity-30 cursor-not-allowed' : 'hover:scale-110'
                                } ${post.downvotes?.includes(currentUser.studentId) ? 'text-red-500 bg-red-500/10' : 'text-neutral-500 hover:text-red-400 hover:bg-white/5'}`}
                                title={userVoted ? "Vote Cast Locked" : "Vote No"}
                            >
                                <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M19 9l-7 7-7-7" /></svg>
                            </button>
                        </div>

                        <div className="flex-1">
                            <div className="flex justify-between items-start mb-6">
                                <div className="flex items-center gap-4">
                                    <CardVisual rankId={currentRank} size="sm" className="w-12 h-16 shadow-lg border border-brand-gold/20" />
                                    <div>
                                        <h3 className="font-display font-bold text-xl text-white tracking-wide">{currentName}</h3>
                                        <div className="flex items-center gap-3 mt-1">
                                            <span className={`text-[10px] px-2 py-0.5 rounded border font-bold uppercase tracking-wider ${
                                                isPassed ? 'text-emerald-500 bg-emerald-500/10 border-emerald-500/20' :
                                                isFailed ? 'text-red-500 bg-red-500/10 border-red-500/20' :
                                                'text-brand-gold bg-brand-gold/10 border-brand-gold/20'
                                            }`}>
                                                {isPassed ? 'Enacted' : isFailed ? 'Failed' : 'Proposal'}
                                            </span>
                                            <span className="text-white bg-black/50 border border-white/10 px-2 py-0.5 rounded text-[10px] font-mono">
                                                Influence: {calculateScore(post) > 0 ? 'Positive' : 'Negative'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <p className="text-neutral-200 text-lg leading-relaxed font-light whitespace-pre-wrap border-l-2 border-brand-gold/20 pl-6 mb-8">
                                {post.content}
                            </p>

                            {canModerate && isActive && (
                                <div className="flex justify-end gap-4 border-t border-white/5 pt-6 mb-6">
                                    <button 
                                        onClick={() => handleProposalDecision(post, 'fail')}
                                        className="px-4 py-2 border border-red-500/30 text-red-500 hover:bg-red-500 hover:text-white rounded text-xs font-bold uppercase tracking-widest transition-all"
                                    >
                                        Reject Motion
                                    </button>
                                    <button 
                                        onClick={() => handleProposalDecision(post, 'pass')}
                                        className="px-4 py-2 border border-emerald-500/30 text-emerald-500 hover:bg-emerald-500 hover:text-white rounded text-xs font-bold uppercase tracking-widest transition-all"
                                    >
                                        Pass Motion
                                    </button>
                                </div>
                            )}

                             <div className="border-t border-white/5 pt-4">
                                <button 
                                    onClick={() => toggleComments(post.id)}
                                    className="text-xs text-neutral-500 font-bold uppercase tracking-widest hover:text-white flex items-center gap-2 mb-4"
                                >
                                    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" /></svg>
                                    {expandedComments.includes(post.id) ? 'Hide Deliberation' : `View Deliberation (${post.comments?.length || 0})`}
                                </button>
                                
                                {expandedComments.includes(post.id) && (
                                    <div className="space-y-4 animate-in fade-in slide-in-from-top-2">
                                        <div className="space-y-3 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                                            {post.comments?.map(comment => {
                                                const canDeleteComment = currentUser.isAdmin || comment.authorId === currentUser.studentId;
                                                const commentAuthorData = allUsers[comment.authorId];
                                                const currentCommenterName = commentAuthorData?.username || comment.authorName;

                                                return (
                                                    <div key={comment.id} className="bg-white/5 p-3 rounded-lg group/comment relative hover:bg-white/10 transition-colors">
                                                        {canDeleteComment && (
                                                            <button 
                                                                onClick={(e) => handleDeleteComment(e, post.id, comment.id)}
                                                                className="absolute top-2 right-2 bg-black text-neutral-600 hover:text-red-500 p-1.5 rounded transition-colors z-50 cursor-pointer border border-white/5"
                                                                title="Delete Comment"
                                                            >
                                                                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                                                            </button>
                                                        )}

                                                        <div className="flex justify-between items-baseline mb-1 mr-8">
                                                            <span className="text-brand-gold text-xs font-bold">{currentCommenterName}</span>
                                                            <span className="text-[10px] text-neutral-600 font-mono">{new Date(comment.createdAt).toLocaleDateString()}</span>
                                                        </div>
                                                        <p className="text-sm text-neutral-300 pr-6">{comment.content}</p>
                                                    </div>
                                                );
                                            })}
                                            {(!post.comments || post.comments.length === 0) && (
                                                <div className="text-center text-neutral-600 text-xs italic py-4">No remarks recorded.</div>
                                            )}
                                        </div>
                                        
                                        <div className="flex gap-2">
                                            <input 
                                                type="text" 
                                                value={commentInputs[post.id] || ''} 
                                                onChange={e => setCommentInputs({...commentInputs, [post.id]: e.target.value})}
                                                placeholder="Add your remark..."
                                                className="flex-1 bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:border-brand-gold outline-none"
                                                onKeyDown={(e) => e.key === 'Enter' && handleAddComment(post.id)}
                                            />
                                            <button 
                                                onClick={() => handleAddComment(post.id)}
                                                className="px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg text-xs font-bold uppercase"
                                            >
                                                Send
                                            </button>
                                        </div>
                                    </div>
                                )}
                             </div>
                        </div>
                    </div>
                </div>
            );
        })}

        {posts.length === 0 && (
            <div className="text-center py-24 glass-panel rounded-2xl border-dashed border-2 border-white/10">
                <p className="text-neutral-500 font-display font-bold text-2xl mb-2">Chamber Empty</p>
                <p className="text-neutral-600 font-mono text-xs uppercase tracking-widest">No policies currently tabled</p>
            </div>
        )}
      </div>
    </div>
  );
};

default CouncilChamber;

// Component: AceControls

interface AceControlsProps {
    currentUser: User;
    onActivity: () => void;
}

const AceControls: React.FC<AceControlsProps> = ({ currentUser, onActivity }) => {
    const [activeSection, setActiveSection] = useState<'operatives' | 'deliveries' | 'protocol'>('operatives');
    const [users, setUsers] = useState<User[]>([]);
    const [logs, setLogs] = useState<PurchaseLog[]>([]);
    const [settings, setSettings] = useState<SystemSettings | null>(null);
    const [loading, setLoading] = useState(true);
    const [searchTerm, setSearchTerm] = useState('');
    const [editingUser, setEditingUser] = useState<string | null>(null);
    const [editForm, setEditForm] = useState<{ points: number, spades: number, rank: RankID, username: string, password?: string }>({ points: 0, spades: 0, rank: '2â™ ', username: '' });

    useEffect(() => { refreshData(); }, [activeSection]);

    const refreshData = async () => {
        setLoading(true);
        const [u, l, s] = await Promise.all([storage.getAllUsers(), storage.getPurchaseLogs(), storage.getSettings()]);
        setUsers(u);
        setLogs(l);
        setSettings(s);
        setLoading(false);
    };

    const handleUpdateProtocol = async (field: keyof SystemSettings, value: any) => {
        await storage.updateSettings({ [field]: value });
        refreshData();
    };

    const handleMarkDelivered = async (logId: string) => {
        await storage.markDelivered(logId);
        refreshData();
    };

    const handleToggleLock = async (user: User) => {
        if (user.studentId === 'ace of spades') {
            alert("PROTOCOL OVERRIDE: Cannot restrict the System Ace.");
            return;
        }
        const newState = !user.isBanned;
        if (confirm(`${newState ? 'Lock' : 'Unlock'} account for member ${user.studentId}?`)) {
            await storage.updateUserStatus(user.studentId, { isBanned: newState });
            await refreshData();
            onActivity();
        }
    };

    const startEdit = (user: User) => {
        setEditingUser(user.studentId);
        setEditForm({ 
            points: user.totalPoints, 
            spades: user.spadesBalance || 0,
            rank: user.currentCard, 
            username: user.username,
            password: '' 
        });
    };

    const saveEdit = async (studentId: string) => {
        await storage.updateUserStatus(studentId, {
            totalPoints: editForm.points,
            spadesBalance: editForm.spades,
            currentCard: editForm.rank,
            currentRank: RANKS[editForm.rank].name,
            username: editForm.username
        });

        if (editForm.password && editForm.password.length >= 8) {
            await storage.updatePassword(studentId, editForm.password);
        }

        setEditingUser(null);
        await refreshData();
        onActivity();
    };

    const rankOrder: RankID[] = ['2â™ ', '3â™ ', '4â™ ', '5â™ ', '6â™ ', '7â™ ', '8â™ ', '9â™ ', '10â™ ', 'Jâ™ ', 'Qâ™ ', 'Kâ™ ', 'Aâ™ '];
    const filteredUsers = users.filter(u => u.studentId.toLowerCase().includes(searchTerm.toLowerCase()) || u.username.toLowerCase().includes(searchTerm.toLowerCase()));
    const pendingDeliveries = logs.filter(l => !l.delivered).length;

    const getLatestUsername = (id: string, fallback: string) => {
        const found = users.find(u => u.studentId === id);
        return found ? found.username : fallback;
    };

    return (
        <div className="space-y-8 animate-in fade-in duration-700 pb-32">
            <div className="flex flex-col md:flex-row justify-between items-center bg-brand-obsidian p-8 border border-white/5 rounded-3xl shadow-2xl gap-6 relative overflow-hidden">
                <div className="absolute top-0 right-0 p-8 opacity-5">
                    <svg className="w-32 h-32" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L1 21h22L12 2zm0 3.45l8.15 14.1H3.85L12 5.45zM11 16h2v2h-2v-2zm0-7h2v5h-2V9z"/></svg>
                </div>
                <div className="relative z-10">
                    <h1 className="text-4xl font-display font-black text-white uppercase italic">Ace Command</h1>
                    <p className="text-[10px] text-brand-red font-mono uppercase tracking-[0.4em] font-bold">System Overlord Terminal</p>
                </div>
                <div className="flex gap-2 bg-black/40 p-1.5 rounded-xl border border-white/5 relative z-10">
                    {['operatives', 'deliveries', 'protocol'].map(s => (
                        <button 
                            key={s} 
                            onClick={() => setActiveSection(s as any)} 
                            className={`px-6 py-2.5 text-[10px] font-bold uppercase rounded-lg transition-all flex items-center gap-2 ${activeSection === s ? 'bg-brand-red text-white shadow-lg' : 'text-neutral-500 hover:text-white hover:bg-white/5'}`}
                        >
                            {s}
                            {s === 'deliveries' && pendingDeliveries > 0 && (
                                <span className="w-4 h-4 bg-white text-brand-red rounded-full flex items-center justify-center text-[8px] animate-pulse">{pendingDeliveries}</span>
                            )}
                        </button>
                    ))}
                </div>
            </div>

            {activeSection === 'deliveries' && (
                <div className="space-y-6 max-w-5xl">
                    <h3 className="text-brand-gold font-bold uppercase tracking-[0.3em] text-xs mb-8 ml-2 flex items-center gap-3">
                        <div className="w-2 h-2 rounded-full bg-brand-gold animate-pulse"></div>
                        Vault Requisition Logs
                    </h3>
                    <div className="space-y-4">
                        {logs.length === 0 && (
                             <div className="p-20 text-center glass-panel rounded-3xl border-dashed border-2 border-white/5 opacity-20">
                                 <p className="text-sm font-mono uppercase tracking-widest">No active requisitions recorded.</p>
                             </div>
                        )}
                        {logs.map(log => (
                            <div key={log.id} className={`p-8 rounded-3xl border transition-all duration-500 flex flex-col md:flex-row items-center justify-between gap-6 relative overflow-hidden ${log.delivered ? 'bg-black/40 border-white/5 opacity-50 grayscale' : 'bg-brand-obsidian border-brand-red/20 shadow-[0_0_30px_rgba(217,35,35,0.05)]'}`}>
                                <div className="flex-1 space-y-4 text-center md:text-left">
                                    <div className="flex items-center gap-3 justify-center md:justify-start">
                                        <div className={`w-2 h-2 rounded-full ${log.delivered ? 'bg-neutral-700' : 'bg-brand-red animate-pulse'}`}></div>
                                        <span className="text-[10px] font-mono text-neutral-500 uppercase tracking-widest">LOG_REF: {log.id}</span>
                                    </div>
                                    <p className="text-lg font-display text-white leading-relaxed font-light">
                                        Member <span className="text-brand-gold font-bold">{getLatestUsername(log.buyerId, log.buyerName)}</span> requisitioned <span className="text-white bg-white/10 px-2 py-0.5 rounded font-bold">"{log.artTitle}"</span> for <span className="text-brand-gold font-bold">{log.price} {log.currencyUsed.toUpperCase()}</span>.
                                    </p>
                                    <p className="text-[9px] text-neutral-600 font-mono uppercase tracking-[0.2em]">Identity: {log.buyerId}</p>
                                </div>
                                
                                <div className="shrink-0">
                                    {!log.delivered ? (
                                        <button 
                                            onClick={() => handleMarkDelivered(log.id)} 
                                            className="px-8 py-4 bg-emerald-600 hover:bg-emerald-500 text-white text-[10px] font-black uppercase tracking-[0.2em] rounded-xl shadow-2xl shadow-emerald-900/20 transition-all active:scale-95"
                                        >
                                            Confirm Delivery
                                        </button>
                                    ) : (
                                        <div className="px-8 py-4 bg-white/5 border border-white/10 rounded-xl flex items-center gap-3 text-emerald-500 text-[10px] font-black uppercase tracking-[0.2em]">
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>
                                            Requisition Filled
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )}

            {activeSection === 'operatives' && (
                <div className="space-y-6">
                    <div className="flex gap-4">
                        <input 
                            type="text" 
                            placeholder="Search by Identity or Username..." 
                            value={searchTerm}
                            onChange={e => setSearchTerm(e.target.value)}
                            className="flex-1 bg-black/50 border border-white/10 rounded-2xl p-5 text-white font-mono placeholder-neutral-700 focus:border-brand-red outline-none transition-all shadow-inner"
                        />
                    </div>
                    
                    <div className="grid grid-cols-1 gap-4">
                        {filteredUsers.map(user => (
                            <div key={user.studentId} className={`glass-panel p-6 rounded-2xl border ${user.isBanned ? 'border-red-500/30 bg-red-950/5' : 'border-white/5'} transition-all hover:bg-white/2`}>
                                {editingUser === user.studentId ? (
                                    <div className="space-y-4 p-4 animate-in slide-in-from-left-2">
                                        <h3 className="text-xs font-bold text-brand-red uppercase tracking-widest mb-4 italic">Override Member Identity</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                            <div className="space-y-2">
                                                <label className="text-[10px] uppercase font-bold text-neutral-500 ml-1">Username</label>
                                                <input type="text" value={editForm.username} onChange={e => setEditForm({...editForm, username: e.target.value})} className="w-full bg-black p-3 border border-white/10 rounded-xl text-sm text-white focus:border-brand-red outline-none" />
                                            </div>
                                            <div className="space-y-2">
                                                <label className="text-[10px] uppercase font-bold text-neutral-500 ml-1">Points</label>
                                                <input type="number" value={editForm.points} onChange={e => setEditForm({...editForm, points: parseInt(e.target.value)})} className="w-full bg-black p-3 border border-white/10 rounded-xl text-sm text-white font-mono focus:border-brand-red outline-none" />
                                            </div>
                                            <div className="space-y-2">
                                                <label className="text-[10px] uppercase font-bold text-neutral-500 ml-1">Spades</label>
                                                <input type="number" value={editForm.spades} onChange={e => setEditForm({...editForm, spades: parseInt(e.target.value)})} className="w-full bg-black p-3 border border-white/10 rounded-xl text-sm text-white font-mono focus:border-brand-red outline-none" />
                                            </div>
                                            <div className="space-y-2">
                                                <label className="text-[10px] uppercase font-bold text-neutral-500 ml-1">Rank Card</label>
                                                <select value={editForm.rank} onChange={e => setEditForm({...editForm, rank: e.target.value as RankID})} className="w-full bg-black p-3 border border-white/10 rounded-xl text-sm text-white focus:border-brand-red outline-none">
                                                    {rankOrder.map(r => <option key={r} value={r}>{r}</option>)}
                                                </select>
                                            </div>
                                        </div>
                                        <div className="flex gap-4 justify-end pt-4">
                                            <button onClick={() => setEditingUser(null)} className="px-6 py-2 text-[10px] font-black text-neutral-500 uppercase tracking-widest">Abort</button>
                                            <button onClick={() => saveEdit(user.studentId)} className="px-10 py-3 bg-emerald-600 text-white rounded-xl font-black text-[10px] uppercase tracking-widest shadow-xl hover:bg-emerald-500 transition-all">Execute Identity Update</button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-6">
                                            <div className="transform group-hover:scale-110 transition-transform">
                                                <CardVisual rankId={user.currentCard} size="sm" />
                                            </div>
                                            <div>
                                                <h4 className="font-display font-black text-white text-xl tracking-tight leading-none italic">{user.username}</h4>
                                                <p className="text-[10px] text-neutral-500 font-mono uppercase tracking-[0.2em] mt-2">
                                                  {user.currentRank} â€¢ {user.totalPoints.toLocaleString()} P â€¢ {user.spadesBalance || 0} S
                                                </p>
                                                {user.isBanned && (
                                                    <div className="flex items-center gap-1.5 mt-3">
                                                        <div className="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></div>
                                                        <span className="text-[8px] font-black text-red-500 uppercase tracking-[0.3em] border border-red-500/30 px-2 py-0.5 rounded-full bg-red-500/5">Account Locked</span>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                        <div className="flex gap-3">
                                            <button 
                                                onClick={() => startEdit(user)} 
                                                className="p-3 bg-white/5 hover:bg-white/10 rounded-xl text-neutral-400 hover:text-white transition-all shadow-xl border border-white/5" 
                                                title="Edit Data"
                                            >
                                                <Edit3 className="w-5 h-5" />
                                            </button>
                                            <button 
                                                onClick={() => handleToggleLock(user)} 
                                                className={`p-3 rounded-xl border transition-all shadow-xl flex items-center justify-center ${
                                                    user.isBanned 
                                                    ? 'bg-red-600 text-white border-red-500 hover:bg-red-700' 
                                                    : 'bg-emerald-600 text-white border-emerald-500 hover:bg-emerald-700'
                                                }`}
                                                title={user.isBanned ? "Unlock Account" : "Lock Account"}
                                            >
                                                {user.isBanned ? (
                                                    <Lock className="w-5 h-5" />
                                                ) : (
                                                    <Unlock className="w-5 h-5" />
                                                )}
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            )}

            {activeSection === 'protocol' && settings && (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div className="glass-panel p-10 rounded-[32px] border border-white/5 space-y-8 shadow-2xl">
                        <h3 className="text-xl font-display font-black text-white uppercase tracking-[0.2em] border-b border-white/5 pb-6 flex items-center gap-3 italic">
                             <div className="w-2 h-8 bg-brand-red"></div>
                             Network Infrastructure
                        </h3>
                        <div className="flex items-center justify-between p-4 bg-black/20 rounded-2xl border border-white/5">
                            <div>
                                <span className="text-sm font-bold text-white uppercase tracking-widest">Emergency Lockdown</span>
                                <p className="text-[10px] text-neutral-500 font-mono mt-1">Freezes all system activity immediately.</p>
                            </div>
                            <button 
                                onClick={() => handleUpdateProtocol('emergencyLockdown', !settings.emergencyLockdown)}
                                className={`w-14 h-7 rounded-full transition-all relative ${settings.emergencyLockdown ? 'bg-red-600' : 'bg-neutral-800'}`}
                            >
                                <div className={`absolute top-1 w-5 h-5 rounded-full bg-white shadow-lg transition-all ${settings.emergencyLockdown ? 'left-8' : 'left-1'}`}></div>
                            </button>
                        </div>
                        <div className="flex items-center justify-between p-4 bg-black/20 rounded-2xl border border-white/5">
                            <div>
                                <span className="text-sm font-bold text-white uppercase tracking-widest">Guest Access</span>
                                <p className="text-[10px] text-neutral-500 font-mono mt-1">Allows read-only access for unregistered nodes.</p>
                            </div>
                            <button 
                                onClick={() => handleUpdateProtocol('allowGuestAccess', !settings.allowGuestAccess)}
                                className={`w-14 h-7 rounded-full transition-all relative ${settings.allowGuestAccess ? 'bg-emerald-600' : 'bg-neutral-800'}`}
                            >
                                <div className={`absolute top-1 w-5 h-5 rounded-full bg-white shadow-lg transition-all ${settings.allowGuestAccess ? 'left-8' : 'left-1'}`}></div>
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

default AceControls;

// Component: ArtGallery

const TimerDisplay = ({ expiresAt, onExpire }: { expiresAt: string; onExpire: () => void }) => {
    const [timeLeft, setTimeLeft] = useState<string>('');

    useEffect(() => {
        const calculateTime = () => {
            const now = new Date().getTime();
            const distance = new Date(expiresAt).getTime() - now;

            if (distance < 0) {
                onExpire();
                return 'EXPIRED';
            }

            const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((distance % (1000 * 60)) / 1000);

            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        };

        const timer = setInterval(() => {
            setTimeLeft(calculateTime());
        }, 1000);

        setTimeLeft(calculateTime());
        return () => clearInterval(timer);
    }, [expiresAt, onExpire]);

    return (
        <div className="text-[10px] font-mono font-bold text-brand-red bg-black/80 px-2 py-1 rounded border border-brand-red/50 backdrop-blur-md shadow-lg">
            EXPIRES IN: {timeLeft}
        </div>
    );
};

default function ArtGallery({ currentUser, onPurchase }: { currentUser: User; onPurchase: () => void }) {
    const [artPieces, setArtPieces] = useState<ArtPiece[]>([]);
    const [loading, setLoading] = useState(true);
    const [showUpload, setShowUpload] = useState(false);
    const [newArt, setNewArt] = useState({ 
        title: '', 
        imageUrl: '', 
        artistId: '', 
        description: '', 
        price: 1000,
        spadesPrice: 1,
        allowPoints: true,
        allowSpades: false,
        itemType: 'asset' as ArtPiece['itemType'],
        durationHours: 168 
    });

    useEffect(() => { loadArt(); }, []);

    const loadArt = async () => {
        setLoading(true);
        const art = await storage.getArtPieces();
        const now = new Date().getTime();
        const activeArt = art.filter(a => new Date(a.expiresAt).getTime() > now);
        setArtPieces(activeArt);
        setLoading(false);
    };

    const handleUpload = async (e: React.FormEvent) => {
        e.preventDefault();
        
        if (!newArt.allowPoints && !newArt.allowSpades) {
            alert("Protocol Error: You must enable at least one currency for listing.");
            return;
        }

        const expirationDate = new Date();
        expirationDate.setHours(expirationDate.getHours() + newArt.durationHours);
        
        const art: ArtPiece = {
            id: `art-${Date.now()}`,
            title: newArt.title,
            imageUrl: newArt.imageUrl || 'https://images.unsplash.com/photo-1614850523296-d8c1af93d400?q=80&w=800&auto=format&fit=crop',
            studentArtistId: newArt.artistId || currentUser.username,
            description: newArt.description,
            price: newArt.allowPoints ? newArt.price : 0,
            spadesPrice: newArt.allowSpades ? newArt.spadesPrice : 0,
            allowPoints: newArt.allowPoints,
            allowSpades: newArt.allowSpades,
            itemType: newArt.itemType,
            ownerId: null,
            ownerName: null,
            createdAt: new Date().toISOString(),
            expiresAt: expirationDate.toISOString()
        };
        await storage.uploadArt(art);
        setShowUpload(false);
        setNewArt({ 
            title: '', 
            imageUrl: '', 
            artistId: '', 
            description: '', 
            price: 1000, 
            spadesPrice: 1, 
            allowPoints: true, 
            allowSpades: false, 
            itemType: 'asset', 
            durationHours: 168 
        });
        loadArt();
    };

    const handlePurchase = async (artId: string, currency: 'points' | 'spades') => {
        const res = await storage.purchaseArt(currentUser.studentId, artId, currency);
        alert(res.message);
        if (res.success) {
            onPurchase();
            loadArt();
        }
    };

    const handleDelete = async (e: React.MouseEvent, artId: string) => {
        e.preventDefault();
        e.stopPropagation();
        if (confirm("Confirm permanent removal?")) {
            await storage.deleteArt(artId);
            loadArt();
        }
    };

    return (
        <div className="pb-32 space-y-12 animate-in fade-in duration-1000 relative">
            <div className="flex flex-col md:flex-row justify-between items-center bg-brand-obsidian p-10 rounded-[40px] border border-white/5 relative overflow-hidden shadow-2xl">
                <div className="absolute top-0 right-0 p-8 opacity-5">
                    <Tag className="w-48 h-48" />
                </div>
                <div className="relative z-10 text-center md:text-left">
                    <h1 className="text-5xl md:text-7xl font-display font-black text-white tracking-tighter uppercase italic">The Vault</h1>
                    <p className="text-brand-gold font-mono text-[11px] uppercase tracking-[0.6em] mt-3 font-black">Digital Asset Requisition Hub</p>
                    <div className="mt-8 flex flex-wrap gap-4 justify-center md:justify-start">
                        <div className="flex items-center gap-3 bg-black/40 px-4 py-2 rounded-xl border border-white/10">
                            <span className="text-brand-gold font-display font-black text-xl">â™ </span>
                            <span className="font-mono text-white text-lg font-bold">{currentUser.spadesBalance || 0} Spades</span>
                        </div>
                        <div className="flex items-center gap-3 bg-black/40 px-4 py-2 rounded-xl border border-white/10">
                            <Coins size={20} className="text-neutral-400" />
                            <span className="font-mono text-white text-lg font-bold">{currentUser.totalPoints.toLocaleString()} P</span>
                        </div>
                    </div>
                </div>
                {currentUser.isAdmin && (
                    <button 
                        onClick={() => setShowUpload(!showUpload)} 
                        className="mt-10 md:mt-0 px-10 py-4 bg-white text-black font-black text-xs uppercase tracking-widest rounded-2xl hover:bg-brand-gold transition-all shadow-xl relative z-[100] flex items-center gap-2"
                    >
                        <PlusCircle size={18} />
                        {showUpload ? 'Cancel' : 'New Listing'}
                    </button>
                )}
            </div>

            {showUpload && (
                <form onSubmit={handleUpload} className="glass-panel p-10 rounded-[32px] border border-brand-gold/30 space-y-8 animate-in slide-in-from-top-4 duration-500 relative z-[200]">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <div className="space-y-2">
                             <label className="text-[10px] text-neutral-500 uppercase font-black ml-1">Asset Title</label>
                             <input type="text" placeholder="e.g. Master Hacker Role" value={newArt.title} onChange={e => setNewArt({...newArt, title: e.target.value})} className="w-full bg-black/50 p-4 rounded-2xl border border-white/10 text-white outline-none focus:border-brand-gold" required />
                        </div>
                        <div className="space-y-2">
                             <label className="text-[10px] text-neutral-500 uppercase font-black ml-1">Category</label>
                             <select value={newArt.itemType} onChange={e => setNewArt({...newArt, itemType: e.target.value as any})} className="w-full bg-black/50 p-4 rounded-2xl border border-white/10 text-white outline-none focus:border-brand-gold">
                                 <option value="role">Discord Role</option>
                                 <option value="asset">Profile Asset</option>
                                 <option value="perk">Community Perk</option>
                                 <option value="other">Other</option>
                             </select>
                        </div>
                        <div className="space-y-2">
                             <label className="text-[10px] text-neutral-500 uppercase font-black ml-1">Expires (Hours)</label>
                             <input type="number" value={newArt.durationHours} onChange={e => setNewArt({...newArt, durationHours: parseInt(e.target.value)})} className="w-full bg-black/50 p-4 rounded-2xl border border-white/10 text-white font-mono" required />
                        </div>
                        
                        <div className="col-span-full border-y border-white/5 py-6">
                            <h4 className="text-[10px] text-brand-gold uppercase font-black mb-6 tracking-[0.2em]">Currency Availability Configuration</h4>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div className="space-y-4">
                                    <button 
                                        type="button"
                                        onClick={() => setNewArt({...newArt, allowPoints: !newArt.allowPoints})}
                                        className="flex items-center gap-3 text-white group"
                                    >
                                        {newArt.allowPoints ? <CheckSquare className="text-brand-red" /> : <Square className="text-neutral-600 group-hover:text-white" />}
                                        <span className="text-xs font-bold uppercase tracking-widest">Allow Point Purchase</span>
                                    </button>
                                    {newArt.allowPoints && (
                                        <div className="animate-in slide-in-from-left-2 duration-300">
                                            <label className="text-[9px] text-neutral-500 uppercase font-black ml-1 mb-1 block">Point Cost</label>
                                            <input type="number" value={newArt.price} onChange={e => setNewArt({...newArt, price: parseInt(e.target.value)})} className="w-full bg-black/50 p-4 rounded-2xl border border-brand-red/20 text-white font-mono focus:border-brand-red" required />
                                        </div>
                                    )}
                                </div>

                                <div className="space-y-4">
                                    <button 
                                        type="button"
                                        onClick={() => setNewArt({...newArt, allowSpades: !newArt.allowSpades})}
                                        className="flex items-center gap-3 text-white group"
                                    >
                                        {newArt.allowSpades ? <CheckSquare className="text-brand-gold" /> : <Square className="text-neutral-600 group-hover:text-white" />}
                                        <span className="text-xs font-bold uppercase tracking-widest">Allow Spade Purchase</span>
                                    </button>
                                    {newArt.allowSpades && (
                                        <div className="animate-in slide-in-from-left-2 duration-300">
                                            <label className="text-[9px] text-neutral-500 uppercase font-black ml-1 mb-1 block">Spade Cost</label>
                                            <input type="number" value={newArt.spadesPrice} onChange={e => setNewArt({...newArt, spadesPrice: parseInt(e.target.value)})} className="w-full bg-black/50 p-4 rounded-2xl border border-brand-gold/20 text-white font-mono focus:border-brand-gold" required />
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="col-span-full space-y-2">
                             <label className="text-[10px] text-neutral-500 uppercase font-black ml-1">Asset Image URL (Optional)</label>
                             <input type="text" placeholder="https://..." value={newArt.imageUrl} onChange={e => setNewArt({...newArt, imageUrl: e.target.value})} className="w-full bg-black/50 p-4 rounded-2xl border border-white/10 text-white" />
                        </div>
                    </div>
                    <div className="space-y-2">
                        <label className="text-[10px] text-neutral-500 uppercase font-black ml-1">Description</label>
                        <textarea placeholder="Asset metadata and details..." value={newArt.description} onChange={e => setNewArt({...newArt, description: e.target.value})} className="w-full bg-black/50 p-4 rounded-2xl border border-white/10 h-32 text-white resize-none focus:border-brand-gold" />
                    </div>
                    <button type="submit" className="w-full bg-brand-gold py-6 text-black font-black uppercase text-sm tracking-[0.4em] rounded-2xl shadow-2xl hover:scale-[1.01] transition-all">Publish Requisition Entry</button>
                </form>
            )}

            {artPieces.length === 0 && !loading ? (
                <div className="text-center py-40 glass-panel rounded-[40px] border-dashed border-2 border-white/5 opacity-30">
                    <p className="text-4xl font-display font-black text-white uppercase italic">Vault Clear</p>
                </div>
            ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">
                    {artPieces.map(art => (
                        <div key={art.id} className="group relative flex flex-col h-full glass-panel rounded-[32px] border border-white/5 overflow-hidden transition-all duration-500 hover:border-brand-gold/30">
                            <div className="relative aspect-[4/3] overflow-hidden bg-neutral-950">
                                <img 
                                    src={art.imageUrl} 
                                    alt={art.title} 
                                    className="w-full h-full object-cover transform transition-transform duration-[2000ms] group-hover:scale-110 opacity-60 group-hover:opacity-100"
                                />
                                <div className="absolute top-4 left-4 z-20">
                                    <TimerDisplay expiresAt={art.expiresAt} onExpire={loadArt} />
                                </div>
                                <div className="absolute top-4 right-4 z-20">
                                    <span className="px-3 py-1 bg-black/60 backdrop-blur-md rounded-full text-[9px] font-black text-white uppercase border border-white/10">{art.itemType}</span>
                                </div>
                                
                                {currentUser.isAdmin && (
                                    <button 
                                        onClick={(e) => handleDelete(e, art.id)}
                                        className="absolute bottom-4 right-4 p-3 bg-red-600/20 text-red-500 hover:bg-red-600 hover:text-white rounded-xl transition-all border border-red-500/20 backdrop-blur-md"
                                    >
                                        <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    </button>
                                )}
                            </div>

                            <div className="p-8 flex-1 flex flex-col">
                                <h3 className="text-2xl font-display font-black text-white uppercase tracking-tight mb-2 truncate group-hover:text-brand-gold transition-colors">{art.title}</h3>
                                <p className="text-xs text-neutral-500 font-light leading-relaxed mb-8 line-clamp-2 italic">
                                    {art.description}
                                </p>
                                
                                <div className="mt-auto space-y-4">
                                    <div className="flex gap-4">
                                        {art.allowPoints && (
                                            <button 
                                                onClick={() => handlePurchase(art.id, 'points')}
                                                disabled={!!art.ownerId || currentUser.totalPoints < art.price}
                                                className={`flex-1 py-4 px-3 bg-white/5 border border-white/10 rounded-2xl text-center transition-all disabled:opacity-30 disabled:cursor-not-allowed hover:bg-white hover:text-black`}
                                            >
                                                <p className="text-[9px] font-bold uppercase tracking-widest text-neutral-500">Points</p>
                                                <p className="text-base font-mono font-black">{art.price.toLocaleString()}</p>
                                            </button>
                                        )}
                                        {art.allowSpades && (
                                            <button 
                                                onClick={() => handlePurchase(art.id, 'spades')}
                                                disabled={!!art.ownerId || currentUser.spadesBalance < art.spadesPrice}
                                                className={`flex-1 py-4 px-3 bg-brand-gold/10 border border-brand-gold/30 rounded-2xl text-center transition-all disabled:opacity-30 disabled:cursor-not-allowed hover:bg-brand-gold hover:text-black shadow-[0_0_15px_rgba(226,177,91,0.1)]`}
                                            >
                                                <p className="text-[9px] font-bold uppercase tracking-widest text-brand-gold">Spades</p>
                                                <p className="text-base font-display font-black">{art.spadesPrice}</p>
                                            </button>
                                        )}
                                    </div>
                                    
                                    {art.ownerId ? (
                                        <div className="w-full py-3 bg-emerald-500/10 border border-emerald-500/20 rounded-xl text-center">
                                            <p className="text-[10px] font-black text-emerald-500 uppercase tracking-widest truncate px-2">Held by {art.ownerName}</p>
                                        </div>
                                    ) : (
                                        <div className="w-full py-2 bg-white/5 rounded-xl text-[8px] font-black text-neutral-600 uppercase tracking-[0.2em] text-center">
                                            Available for Requisition
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}

// Component: FocusRealm

interface FocusRealmProps {
    currentUser: User;
    onActivity: () => void;
}

const FocusRealm: React.FC<FocusRealmProps> = ({ currentUser, onActivity }) => {
    const [mode, setMode] = useState<'timer' | 'stopwatch'>('timer');
    const [isActive, setIsActive] = useState(false);
    const [seconds, setSeconds] = useState(0);
    const [initialTime, setInitialTime] = useState(25 * 60); // Default 25 min Pomodoro
    const [sessionPoints, setSessionPoints] = useState(0);
    const [leaderboard, setLeaderboard] = useState<User[]>([]);

    const intervalRef = useRef<number | null>(null);

    // Initialize Timer
    useEffect(() => {
        if (mode === 'timer') setSeconds(initialTime);
        else setSeconds(0);
        setIsActive(false);
    }, [mode, initialTime]);

    // Load Leaderboard
    useEffect(() => {
        const loadLeaderboard = async () => {
            const users = await storage.getAllUsers();
            setLeaderboard(users.filter(u => !u.isGuest).sort((a,b) => (b.stats.minutesStudied || 0) - (a.stats.minutesStudied || 0)).slice(0, 5));
        };
        loadLeaderboard();
    }, [isActive]);

    // Timer Logic
    useEffect(() => {
        if (isActive) {
            intervalRef.current = window.setInterval(() => {
                if (mode === 'stopwatch') {
                    setSeconds(s => s + 1);
                } else {
                    setSeconds(s => {
                        if (s <= 1) {
                            completeSession(initialTime);
                            return 0;
                        }
                        return s - 1;
                    });
                }
            }, 1000);
        } else if (intervalRef.current) {
            clearInterval(intervalRef.current);
            intervalRef.current = null;
        }
        return () => {
            if (intervalRef.current) {
                clearInterval(intervalRef.current);
                intervalRef.current = null;
            }
        };
    }, [isActive, mode, initialTime]);

    // Calculate pending points
    useEffect(() => {
        let minutes = 0;
        if (mode === 'stopwatch') {
            minutes = Math.floor(seconds / 60);
        } else {
            minutes = Math.floor((initialTime - seconds) / 60);
        }
        setSessionPoints(minutes * POINT_VALUES.FOCUS_MINUTE);
    }, [seconds, mode, initialTime]);

    const toggleTimer = () => {
        if (currentUser.isGuest) {
            alert("ACCESS DENIED: Guest accounts cannot utilize the Focus Realm. Initialize Identity to begin earning power.");
            return;
        }
        setIsActive(!isActive);
    };

    const stopSession = () => {
        if (mode === 'stopwatch') {
            completeSession(seconds);
        } else {
            const elapsed = initialTime - seconds;
            completeSession(elapsed);
        }
    };

    const completeSession = async (durationSecs: number) => {
        setIsActive(false);
        if (intervalRef.current) {
            clearInterval(intervalRef.current);
            intervalRef.current = null;
        }

        const minutes = Math.floor(durationSecs / 60);
        if (minutes < 1) {
            setSeconds(mode === 'timer' ? initialTime : 0);
            return;
        }

        const pointsEarned = minutes * POINT_VALUES.FOCUS_MINUTE;
        
        if (pointsEarned > 0) {
            const freshUser = await storage.getUser(currentUser.studentId);
            if (freshUser) {
                const updatedUser = {
                    ...freshUser,
                    totalPoints: freshUser.totalPoints + pointsEarned,
                    stats: {
                        ...freshUser.stats,
                        minutesStudied: (freshUser.stats.minutesStudied || 0) + minutes
                    }
                };
                await storage.saveUser(updatedUser);
                onActivity();
                alert(`PRODUCTIVITY REWARD: +${pointsEarned} POINTS BANKED`);
            }
        }
        
        setSeconds(mode === 'timer' ? initialTime : 0);
    };

    const formatTime = (totalSeconds: number) => {
        const m = Math.floor(totalSeconds / 60);
        const s = totalSeconds % 60;
        return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    };

    return (
        <div className="pb-32 grid grid-cols-1 lg:grid-cols-3 gap-8 animate-in fade-in duration-700">
            
            {/* Main Timer Area */}
            <div className="lg:col-span-2 space-y-8">
                <div className="glass-panel p-10 rounded-3xl text-center relative overflow-hidden border border-white/10">
                    <div className="absolute inset-0 bg-gradient-to-br from-brand-deepRed/20 via-transparent to-transparent pointer-events-none"></div>
                    
                    {/* Visual Core */}
                    <div className="relative w-64 h-64 mx-auto mb-10 flex items-center justify-center">
                        <div className={`absolute inset-0 rounded-full border-2 border-brand-red/20 ${isActive ? 'animate-ping opacity-20' : ''}`}></div>
                        <div className={`absolute inset-4 rounded-full border border-brand-red/40 ${isActive ? 'animate-spin opacity-40' : ''}`} style={{animationDuration: '10s'}}></div>
                        <div className={`w-48 h-48 rounded-full bg-gradient-to-br from-neutral-900 to-black border-4 border-brand-red shadow-[0_0_50px_rgba(217,35,35,0.2)] flex items-center justify-center z-10 transition-all duration-1000 ${isActive ? 'shadow-[0_0_80px_rgba(217,35,35,0.6)] scale-105' : ''}`}>
                             <span className="text-6xl font-mono font-bold text-white tracking-wider">{formatTime(seconds)}</span>
                        </div>
                    </div>

                    <div className="flex flex-col items-center gap-4 mb-8">
                        <h2 className="text-white font-display font-bold text-xl uppercase tracking-widest">Focus Realm</h2>
                        <p className="text-neutral-500 text-xs italic">Log your coding, studying, or project sessions.</p>
                    </div>

                    <div className="flex justify-center gap-4 mb-8">
                        <button 
                            onClick={() => { setIsActive(false); setMode('timer'); }}
                            className={`px-6 py-2 rounded-full text-xs font-bold uppercase tracking-widest transition-all ${mode === 'timer' ? 'bg-white text-black' : 'text-neutral-500 hover:text-white'}`}
                        >
                            Timer
                        </button>
                        <button 
                            onClick={() => { setIsActive(false); setMode('stopwatch'); }}
                            className={`px-6 py-2 rounded-full text-xs font-bold uppercase tracking-widest transition-all ${mode === 'stopwatch' ? 'bg-white text-black' : 'text-neutral-500 hover:text-white'}`}
                        >
                            Stopwatch
                        </button>
                    </div>

                    {mode === 'timer' && !isActive && (
                        <div className="flex justify-center gap-2 mb-8">
                             {[15, 25, 45, 60, 90, 120].map(m => (
                                 <button 
                                    key={m}
                                    onClick={() => { setInitialTime(m*60); setSeconds(m*60); }}
                                    className={`w-12 h-12 rounded-full border border-white/10 text-xs font-mono hover:border-brand-red hover:text-brand-red transition-all ${initialTime === m*60 ? 'border-brand-red text-brand-red bg-brand-red/10' : 'text-neutral-500'}`}
                                 >
                                     {m}
                                 </button>
                             ))}
                        </div>
                    )}

                    <div className="flex justify-center gap-6">
                        {currentUser.isGuest ? (
                             <button 
                                disabled
                                className="px-12 py-4 rounded-xl font-bold uppercase tracking-[0.2em] bg-neutral-900 text-neutral-600 border border-neutral-800 cursor-not-allowed"
                             >
                                Identity Required
                             </button>
                        ) : (
                            <>
                                <button 
                                    onClick={toggleTimer}
                                    className={`px-12 py-4 rounded-xl font-bold uppercase tracking-[0.2em] transition-all shadow-xl ${
                                        isActive 
                                        ? 'bg-neutral-800 text-neutral-400 border border-neutral-700 hover:text-white' 
                                        : 'bg-brand-red text-white hover:bg-white hover:text-black shadow-brand-red/30'
                                    }`}
                                >
                                    {isActive ? 'Pause Session' : 'Start Focus'}
                                </button>
                                {isActive && (
                                    <button 
                                        onClick={stopSession}
                                        className="px-8 py-4 rounded-xl font-bold uppercase tracking-[0.2em] border border-red-500 text-red-500 hover:bg-red-500 hover:text-white transition-all"
                                    >
                                        Finish
                                    </button>
                                )}
                            </>
                        )}
                    </div>
                    
                    {isActive && (
                        <div className="mt-8 text-brand-gold font-mono text-xs uppercase tracking-widest animate-pulse">
                            Generating Impact: +{sessionPoints} PTS
                        </div>
                    )}
                </div>
                
                <div className="grid grid-cols-2 gap-4">
                    <div className="glass-panel p-6 rounded-2xl border border-white/5">
                        <p className="text-neutral-500 text-[10px] uppercase tracking-widest mb-2">My Total Discipline</p>
                        <p className="text-3xl font-display font-bold text-white">
                            {Math.floor((currentUser.stats.minutesStudied || 0) / 60)}<span className="text-sm text-neutral-500 ml-1">h</span> {(currentUser.stats.minutesStudied || 0) % 60}<span className="text-sm text-neutral-500 ml-1">m</span>
                        </p>
                    </div>
                    <div className="glass-panel p-6 rounded-2xl border border-white/5">
                        <p className="text-neutral-500 text-[10px] uppercase tracking-widest mb-2">Pending Gain</p>
                        <p className="text-3xl font-display font-bold text-brand-gold">
                            +{sessionPoints}
                        </p>
                    </div>
                </div>
            </div>

            {/* Leaderboard Panel */}
            <div className="lg:col-span-1 glass-panel rounded-2xl p-6 border border-white/5 h-fit">
                <div className="flex items-center gap-3 mb-6 pb-4 border-b border-white/5">
                    <div className="w-8 h-8 rounded bg-brand-gold/10 flex items-center justify-center text-brand-gold">âš¡</div>
                    <h3 className="font-bold text-white uppercase tracking-widest text-sm">Discipline Elite</h3>
                </div>

                <div className="space-y-4">
                    {leaderboard.map((u, i) => (
                        <div key={u.studentId} className="flex items-center gap-4 group">
                             <div className={`w-6 h-6 rounded flex items-center justify-center font-mono text-xs font-bold ${i===0 ? 'bg-brand-gold text-black' : 'bg-neutral-800 text-neutral-500'}`}>
                                 {i + 1}
                             </div>
                             <div className="flex-1">
                                 <div className="text-sm font-bold text-neutral-300 group-hover:text-white">{u.username}</div>
                                 <div className="text-[10px] text-neutral-600 font-mono">{Math.floor((u.stats.minutesStudied || 0)/60)}h {(u.stats.minutesStudied||0)%60}m logged</div>
                             </div>
                             {i === 0 && <span className="text-lg">ðŸ‘‘</span>}
                        </div>
                    ))}
                    {leaderboard.length === 0 && <div className="text-neutral-600 text-xs italic">No node activity recorded.</div>}
                </div>
            </div>
        </div>
    );
};

default FocusRealm;

// Component: Portfolio

const CommunityScanner = () => {
  const canvasRef = useRef<HTMLCanvasElement>(null);
  
  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    let animationFrameId: number;
    let startTime = Date.now();
    const cols = 60;
    const rows = 50; 
    
    const resize = () => {
        const parent = canvas.parentElement;
        if(parent) {
            canvas.width = parent.clientWidth;
            canvas.height = parent.clientWidth * 0.7;
        }
    };
    resize();
    window.addEventListener('resize', resize);

    const render = () => {
        const now = Date.now();
        const cycle = 8000;
        const t = (now - startTime) % cycle;
        
        const w = canvas.width;
        const h = canvas.height;
        const paddingX = w * 0.05;
        const paddingY = h * 0.05;
        const availableW = w - paddingX * 2;
        const availableH = h - paddingY * 2;
        
        const dotW = availableW / cols;
        const dotH = availableH / rows;
        const radius = Math.min(dotW, dotH) * 0.35;

        ctx.fillStyle = '#050505';
        ctx.fillRect(0, 0, w, h);

        const centerX = Math.floor(cols / 2);
        const centerY = Math.floor(rows / 2);

        let scanProgress = 0;
        if (t > 3500 && t < 5500) {
            scanProgress = (t - 3500) / 2000;
        } else if (t >= 5500) {
            scanProgress = 1;
        }

        for (let i = 0; i < cols; i++) {
            for (let j = 0; j < rows; j++) {
                const x = paddingX + i * dotW + dotW/2;
                const y = paddingY + j * dotH + dotH/2;
                
                const isTarget = i === centerX && j === centerY;
                
                ctx.beginPath();
                ctx.arc(x, y, radius, 0, Math.PI * 2);

                if (t < 3500) {
                    if (isTarget) {
                        const pulse = Math.sin(now / 200) * 0.5 + 0.5;
                        ctx.fillStyle = `rgba(217, 35, 35, ${0.5 + pulse * 0.5})`;
                        ctx.shadowBlur = 10 * pulse;
                        ctx.shadowColor = '#d92323';
                    } else {
                        ctx.fillStyle = '#1a1a1a';
                        ctx.shadowBlur = 0;
                    }
                } else {
                    const scanY = paddingY + scanProgress * availableH;
                    
                    if (y < scanY) {
                        if (t >= 5500) {
                             const dist = Math.sqrt(Math.pow(i - centerX, 2) + Math.pow(j - centerY, 2));
                             const wave = Math.sin(dist * 0.2 - (now / 200)) * 0.3 + 0.7;
                             ctx.fillStyle = `rgba(226, 177, 91, ${wave})`;
                        } else {
                             ctx.fillStyle = '#e2b15b';
                        }
                        ctx.shadowBlur = 0;
                    } else if (y >= scanY && y < scanY + dotH * 2) {
                        ctx.fillStyle = '#ffffff';
                        ctx.shadowBlur = 10;
                        ctx.shadowColor = '#ffffff';
                    } else {
                         if (isTarget) {
                            ctx.fillStyle = '#d92323';
                         } else {
                            ctx.fillStyle = '#1a1a1a';
                         }
                    }
                }
                ctx.fill();
            }
        }
        
        ctx.font = `bold ${Math.max(12, w/40)}px "JetBrains Mono"`;
        ctx.textAlign = 'right';
        ctx.textBaseline = 'bottom';
        
        if (t < 3500) {
             ctx.fillStyle = '#d92323';
             ctx.fillText('STATUS: OFFLINE', w - 20, h - 20);
        } else if (t < 5500) {
             ctx.fillStyle = '#ffffff';
             ctx.fillText('INITIALIZING NODE...', w - 20, h - 20);
        } else {
             ctx.fillStyle = '#e2b15b';
             ctx.fillText('PROTOCOL: ACTIVE', w - 20, h - 20);
        }
        
        ctx.textAlign = 'left';
        ctx.fillStyle = '#333';
        ctx.fillText('SPADES CORE', 20, h - 20);

        animationFrameId = requestAnimationFrame(render);
    };

    render();

    return () => {
        window.removeEventListener('resize', resize);
        cancelAnimationFrame(animationFrameId);
    };
  }, []);

  return <canvas ref={canvasRef} className="w-full h-auto rounded-2xl border border-white/10 bg-black shadow-2xl" />;
}

default function Portfolio({ onEnterSystem }: { onEnterSystem: () => void }) {
  return (
    <div className="min-h-screen bg-black text-white selection:bg-brand-red selection:text-white font-sans">
      {/* Hero Section */}
      <section className="relative min-h-[100dvh] flex flex-col items-center justify-center overflow-hidden px-6 py-20">
        <div className="absolute inset-0 z-0 bg-black">
          <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')] opacity-40"></div>
          <div className="absolute inset-0 bg-gradient-to-b from-black/20 via-black/40 to-black z-10"></div>
        </div>

        <div className="relative z-20 text-center max-w-6xl animate-in fade-in slide-in-from-bottom-12 duration-1000 mt-auto mb-auto">
          <div className="mb-6 flex items-center justify-center gap-4">
             <div className="h-px w-8 md:w-16 bg-brand-red"></div>
             <h2 className="text-brand-red font-mono text-xs md:text-sm uppercase tracking-[0.3em] font-bold drop-shadow-[0_0_10px_rgba(217,35,35,0.8)]">
                The Spades Community
             </h2>
             <div className="h-px w-8 md:w-16 bg-brand-red"></div>
          </div>
          
          <h1 className="text-6xl sm:text-7xl md:text-9xl font-display font-black tracking-tighter mb-8 leading-[0.9] drop-shadow-xl relative break-words uppercase">
            <span className="text-white/30 backdrop-blur-[2px]">ELEVATE YOUR</span> <br/><span className="text-brand-red">PRODUCTIVITY</span>
          </h1>
          
          <p className="max-w-xl mx-auto text-neutral-200 text-lg md:text-xl font-light mb-12 leading-relaxed drop-shadow-md mix-blend-screen px-4">
            A gamified Discord ecosystem designed for focus, governance, and collective growth. <br/>
            Turn your grind into influence.
          </p>

          <div className="flex flex-col sm:flex-row items-center justify-center gap-4 sm:gap-6 w-full px-4">
            <button 
              onClick={() => document.getElementById('manifesto')?.scrollIntoView({ behavior: 'smooth' })}
              className="w-full sm:w-auto px-8 py-4 border border-white/20 rounded-full hover:bg-white hover:text-black transition-all font-bold uppercase tracking-widest text-xs min-w-[200px] backdrop-blur-sm bg-black/20"
            >
              The Pillars
            </button>
            <button 
              onClick={onEnterSystem}
              className="w-full sm:w-auto group px-8 py-4 bg-brand-red rounded-full hover:scale-105 transition-all font-bold uppercase tracking-widest text-xs shadow-[0_0_30px_rgba(217,35,35,0.4)] min-w-[200px] flex items-center justify-center gap-2"
            >
              <span>Access System</span>
              <svg className="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
            </button>
          </div>
        </div>
      </section>

      {/* Pillars Section */}
      <section id="manifesto" className="bg-[#050505] py-32 border-y border-white/5 relative overflow-hidden">
        <div className="absolute top-0 inset-x-0 h-px bg-gradient-to-r from-transparent via-brand-red/50 to-transparent"></div>
        
        <div className="max-w-7xl mx-auto px-6 relative z-10">
            <div className="text-center mb-20">
              <h3 className="font-mono text-brand-gold text-xs uppercase tracking-[0.5em] mb-4">Core Directives</h3>
              <h2 className="text-4xl md:text-5xl font-display font-black text-white">WHAT IS SPADES?</h2>
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                {[
                  { 
                    id: "01",
                    title: "Collaborative Governance", 
                    subtitle: "Shared Decisions",
                    desc: "This isn't a top-down server. Propose bot features, server rules, or event themes. Your rank determines the weight of your vote in the community.",
                    icon: "M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                  },
                  { 
                    id: "02",
                    title: "Focus Incentivized", 
                    subtitle: "Productivity Rewards",
                    desc: "Log your hours in the Focus Realm (coding, studying, deep work). Earn points for every minute of discipline. Rise through the ranks to gain prestige.",
                    icon: "M13 10V3L4 14h7v7l9-11h-7z"
                  },
                  { 
                    id: "03",
                    title: "Asset Distribution", 
                    subtitle: "The Vault",
                    desc: "Redeem your hard-earned points for exclusive Discord roles, profile assets, and community-curated digital rewards. A true merit-based economy.",
                    icon: "M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  }
                ].map((pillar, i) => (
                  <div key={i} className="group relative p-10 bg-[#0a0a0a] border border-white/5 rounded-3xl hover:border-brand-red/30 transition-all duration-500 hover:-translate-y-2">
                    <div className="absolute inset-0 bg-gradient-to-b from-brand-red/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500 rounded-3xl"></div>
                    
                    <div className="relative z-10 flex flex-col items-center text-center">
                        <div className="w-16 h-16 rounded-2xl bg-black border border-white/10 flex items-center justify-center mb-8 group-hover:border-brand-red/50 group-hover:shadow-[0_0_30px_rgba(217,35,35,0.2)] transition-all">
                            <svg className="w-8 h-8 text-neutral-400 group-hover:text-brand-red transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d={pillar.icon} />
                            </svg>
                        </div>
                        
                        <div className="text-brand-red/50 font-mono text-6xl font-black absolute top-4 right-6 opacity-20 select-none">{pillar.id}</div>
                        
                        <h4 className="text-2xl font-bold mb-2 text-white">{pillar.title}</h4>
                        <p className="text-brand-gold font-mono text-xs uppercase tracking-widest mb-6">{pillar.subtitle}</p>
                        <p className="text-neutral-500 text-sm leading-relaxed">{pillar.desc}</p>
                    </div>
                  </div>
                ))}
            </div>
        </div>
      </section>

      {/* System Scanner Visual */}
      <section className="py-24 bg-[#030303] border-y border-white/5 relative overflow-hidden">
         <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-5"></div>
         
         <div className="max-w-7xl mx-auto px-6 grid grid-cols-1 md:grid-cols-2 gap-16 items-center">
            <div className="relative z-10 space-y-10 order-2 md:order-1">
                <div className="border-l-4 border-brand-red pl-8 py-2">
                    <h2 className="text-4xl md:text-5xl font-display font-black text-white leading-[1.1] mb-2 uppercase">
                        RADICAL <br/>
                        <span className="text-neutral-600">ACCOUNTABILITY.</span>
                    </h2>
                </div>
                
                <div className="space-y-6">
                    <p className="text-2xl text-neutral-300 font-light leading-relaxed">
                        The community monitors the system. <br/>
                        <span className="text-white font-bold">No fakes. No shortcuts.</span>
                    </p>
                </div>

                <div className="pt-6 border-t border-white/10">
                    <p className="text-neutral-400 text-sm leading-relaxed max-w-lg mb-6">
                         Through societal pressure and transparent logs, the Spades Protocol ensures that those at the top actually put in the work. Every member can challenge evidence on Discord.
                    </p>
                    <div className="inline-flex items-center gap-3 text-brand-gold font-bold uppercase tracking-widest text-xs bg-brand-gold/10 px-4 py-2 rounded border border-brand-gold/20">
                        <span className="w-2 h-2 bg-brand-gold rounded-full animate-pulse"></span>
                        Node Synchronization Active
                    </div>
                </div>
            </div>

            <div className="relative z-10 order-1 md:order-2">
                 <div className="relative group cursor-crosshair">
                     <div className="absolute -inset-1 bg-gradient-to-r from-brand-red to-brand-gold opacity-20 blur-xl group-hover:opacity-40 transition-opacity duration-1000"></div>
                     <CommunityScanner />
                     <div className="absolute bottom-4 right-4 text-[10px] text-neutral-500 font-mono pointer-events-none uppercase">
                        Community Matrix Monitoring
                     </div>
                 </div>
            </div>
         </div>
      </section>

      {/* Call to Action */}
      <section className="py-40 text-center px-6 relative overflow-hidden">
         <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')] opacity-20"></div>
         <div className="absolute inset-0 bg-gradient-to-t from-black via-transparent to-black"></div>
         
         <div className="relative z-10 max-w-4xl mx-auto">
             <h2 className="text-6xl md:text-9xl font-display font-black mb-12 text-white tracking-tighter">
                JOIN THE <br/> <span className="text-brand-red">PROTOCOL</span>
             </h2>
             <p className="text-neutral-400 text-lg mb-12 max-w-2xl mx-auto">
                 Ready to turn your productivity into digital power? <br/>
                 Register with your Discord username to begin.
             </p>
             <button 
               onClick={onEnterSystem}
               className="group relative px-16 py-6 bg-white text-black font-black uppercase tracking-[0.3em] text-sm hover:bg-brand-red hover:text-white transition-all transform hover:scale-105 overflow-hidden rounded-lg"
             >
               <span className="relative z-10">Initialize Identity</span>
               <div className="absolute inset-0 bg-brand-red transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left duration-300 -z-0"></div>
             </button>
         </div>
      </section>

      <footer className="py-12 border-t border-white/5 bg-black">
        <div className="max-w-7xl mx-auto px-6 flex flex-col md:flex-row justify-between items-center gap-6 text-neutral-600 font-mono text-[10px] uppercase tracking-widest">
            <div>&copy; 2025 Spades Community. All Rights Reserved.</div>
            <div>Built for the Grind.</div>
        </div>
      </footer>
    </div>
  );
}

// Component: Guide

const Guide: React.FC = () => {
    return (
        <div className="max-w-4xl mx-auto space-y-12 pb-32 animate-in fade-in duration-700">
             <div className="text-center py-12 relative">
                <div className="absolute inset-0 bg-gradient-to-b from-brand-red/5 to-transparent blur-3xl rounded-full opacity-20 pointer-events-none"></div>
                <h1 className="text-5xl md:text-7xl font-display font-black text-white tracking-tighter mb-4 drop-shadow-[0_0_30px_rgba(255,255,255,0.1)]">SYSTEM GUIDE</h1>
                <p className="text-brand-gold font-mono text-xs uppercase tracking-[0.5em] font-bold bg-black/50 inline-block px-4 py-2 rounded-full border border-brand-gold/20">Protocol Manual v2.5</p>
            </div>

            {/* Introduction */}
            <div className="glass-panel p-10 rounded-3xl border border-white/10 bg-gradient-to-br from-neutral-900/80 to-black relative overflow-hidden group hover:border-brand-red/30 transition-colors duration-500">
                <div className="absolute top-0 right-0 w-32 h-32 bg-brand-red/10 blur-[80px] rounded-full group-hover:bg-brand-red/20 transition-all"></div>
                <h3 className="text-2xl font-bold text-white mb-6 uppercase tracking-widest text-center">The Spades Philosophy</h3>
                <p className="text-neutral-300 text-lg font-light leading-relaxed text-center max-w-3xl mx-auto">
                    Spades is a meritocratic ecosystem for the Discord era. We reward <span className="text-white font-medium">consistent effort</span> over mere presence. 
                    Whether you are coding, studying, or building projects, your discipline translates to protocol power.
                </p>
            </div>

            {/* Three Pillars */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="glass-panel p-8 rounded-3xl border border-white/10 bg-gradient-to-b from-brand-red/5 to-transparent text-center hover:transform hover:-translate-y-2 transition-all duration-300">
                    <div className="w-12 h-12 bg-brand-red/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-brand-red/20">
                         <span className="text-2xl">ðŸ—³ï¸</span>
                    </div>
                    <h3 className="text-brand-red font-bold uppercase tracking-widest text-xs mb-3">Pillar I</h3>
                    <h4 className="text-white font-bold text-xl mb-3">Governance</h4>
                    <p className="text-sm text-neutral-400 font-light leading-relaxed">Shape the community. High-rank members hold more weight in server decisions.</p>
                </div>
                <div className="glass-panel p-8 rounded-3xl border border-white/10 bg-gradient-to-b from-brand-gold/5 to-transparent text-center hover:transform hover:-translate-y-2 transition-all duration-300">
                    <div className="w-12 h-12 bg-brand-gold/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-brand-gold/20">
                         <span className="text-2xl">âš¡</span>
                    </div>
                    <h3 className="text-brand-gold font-bold uppercase tracking-widest text-xs mb-3">Pillar II</h3>
                    <h4 className="text-white font-bold text-xl mb-3">Focus Economy</h4>
                    <p className="text-sm text-neutral-400 font-light leading-relaxed">Earn points for every minute of deep productivity. Discipline is the only currency.</p>
                </div>
                <div className="glass-panel p-8 rounded-3xl border border-white/10 bg-gradient-to-b from-blue-500/5 to-transparent text-center hover:transform hover:-translate-y-2 transition-all duration-300">
                    <div className="w-12 h-12 bg-blue-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-blue-500/20">
                         <span className="text-2xl">âš”ï¸</span>
                    </div>
                    <h3 className="text-blue-400 font-bold uppercase tracking-widest text-xs mb-3">Pillar III</h3>
                    <h4 className="text-white font-bold text-xl mb-3">Hierarchy</h4>
                    <p className="text-sm text-neutral-400 font-light leading-relaxed">Climb from Prospect to System Ace. Unlock exclusive roles and Vault items.</p>
                </div>
            </div>

            {/* Economy & Points */}
            <div className="glass-panel p-10 rounded-3xl border border-white/10">
                <h3 className="text-2xl font-bold text-white mb-8 uppercase tracking-widest flex items-center gap-3">
                    <span className="w-2 h-2 bg-brand-gold rounded-full animate-pulse"></span>
                    Influence Dynamics
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-12">
                    <div>
                        <p className="text-neutral-400 text-sm mb-8 leading-relaxed">
                            Points are gained through <strong>Deep Focus</strong> and <strong>Civic Action</strong>. 
                            Chatting alone earns nothing; contribution and work do.
                        </p>
                        <ul className="space-y-4">
                            <li className="flex justify-between items-center p-4 bg-white/5 rounded-xl border border-brand-gold/20 hover:bg-white/10 transition-colors">
                                <span className="text-white font-bold text-sm">Focus Realm (Work/Study/Code)</span>
                                <span className="text-brand-gold font-mono font-bold text-sm">2 PTS / MIN</span>
                            </li>
                            <li className="flex justify-between items-center p-4 bg-white/5 rounded-xl border border-brand-gold/20 hover:bg-white/10 transition-colors">
                                <span className="text-white font-bold text-sm">Casting a Vote (Council)</span>
                                <span className="text-brand-gold font-mono font-bold text-sm">10 PTS</span>
                            </li>
                            <li className="flex justify-between items-center p-4 bg-white/5 rounded-xl border border-white/5 opacity-50">
                                <span className="text-neutral-500 text-sm">Idle Presence</span>
                                <span className="text-neutral-600 font-mono text-sm">0 PTS</span>
                            </li>
                        </ul>
                    </div>
                    <div className="flex flex-col justify-center text-center p-8 bg-black/40 rounded-2xl border border-white/10 relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-brand-gold/20 via-brand-gold to-brand-gold/20"></div>
                        <div className="text-5xl mb-6">âš–ï¸</div>
                        <h4 className="text-white font-bold text-xl mb-2">Weighted Impact</h4>
                        <p className="text-xs text-neutral-400 mb-6 px-4">
                            Rank determines your power within the Spades ecosystem.
                        </p>
                         <ul className="text-xs text-neutral-500 font-mono space-y-2">
                            <li className="flex justify-between px-4"><span>Prospect / Member</span> <span className="text-white">1x Influence</span></li>
                            <li className="flex justify-between px-4"><span>Contributor</span> <span className="text-white">2x Influence</span></li>
                            <li className="flex justify-between px-4"><span>Scholar / Architect</span> <span className="text-white">5x Influence</span></li>
                            <li className="flex justify-between px-4 border-t border-white/10 pt-2 mt-2"><span className="text-brand-gold font-bold">COUNCIL</span> <span className="text-brand-gold font-bold">50x Influence</span></li>
                        </ul>
                    </div>
                </div>
            </div>

            {/* The Vault & Community Integrity */}
            <div className="glass-panel p-10 rounded-3xl border border-emerald-500/20 bg-gradient-to-br from-emerald-950/30 to-black">
                <div className="flex items-start gap-6">
                    <div className="p-4 bg-emerald-500/10 rounded-2xl border border-emerald-500/20 hidden md:block">
                        <svg className="w-8 h-8 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                    <div>
                        <h3 className="text-2xl font-bold text-white mb-4 uppercase tracking-widest">Vault & Community Integrity</h3>
                        <p className="text-neutral-300 text-sm leading-relaxed mb-6">
                            The Vault is a showcase of community-sourced assets. Points represent real productivity sessions.
                            <br/><br/>
                            <strong className="text-emerald-400">RADICAL ACCOUNTABILITY:</strong> The Spades community holds itself responsible. Every member's focus time is visible on the leaderboard.
                        </p>
                        <div className="p-4 bg-black/40 border border-white/10 rounded-xl text-xs text-neutral-400 font-mono leading-relaxed">
                            <span className="text-red-400 font-bold mr-2">SOCIETAL CHALLENGE PROTOCOL:</span>
                            If a member is suspected of inflating their hours (leaving timers running while idle), the community can request evidence in the #council Discord channel. Failure to provide proof leads to a community-voted point purge and potential ban. Integrity is enforced by the many, not the few.
                        </div>
                    </div>
                </div>
            </div>

            {/* Hierarchy */}
            <div className="glass-panel p-10 rounded-3xl border border-white/10">
                <div className="text-center mb-10">
                    <h3 className="text-2xl font-bold text-white uppercase tracking-widest mb-2">Rank Structure</h3>
                    <p className="text-brand-red text-xs font-mono uppercase tracking-[0.2em] font-bold">The Spades High Council: Jack â€¢ Queen â€¢ King â€¢ Ace</p>
                </div>
                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    {Object.values(RANKS).map((rank) => (
                        <div key={rank.id} className={`p-5 rounded-2xl border flex flex-col items-center text-center hover:bg-white/5 transition-all duration-300 hover:scale-105 ${
                            ['Jâ™ ', 'Qâ™ ', 'Kâ™ ', 'Aâ™ '].includes(rank.id) 
                            ? 'bg-brand-red/5 border-brand-red/30 shadow-[0_0_20px_rgba(217,35,35,0.1)]' 
                            : 'bg-black/40 border-white/5'
                        }`}>
                            <div className="text-3xl font-display font-bold text-white mb-3">{rank.id.replace('â™ ','')}</div>
                            <div className="text-[10px] text-brand-red uppercase font-bold mb-1 tracking-wider">{rank.tier}</div>
                            <div className="text-[9px] text-neutral-500 font-mono mb-2">{rank.minPoints} PTS</div>
                             <div className="text-[9px] text-brand-gold font-mono bg-brand-gold/10 px-2 py-0.5 rounded border border-brand-gold/20">Power: {rank.voteWeight}x</div>
                        </div>
                    ))}
                </div>
            </div>

            {/* Focus Strategy */}
            <div className="glass-panel p-10 rounded-3xl border border-brand-red/20 bg-gradient-to-r from-brand-red/10 to-transparent text-center">
                <h3 className="text-xl font-bold text-white mb-4">Focus = Power</h3>
                <p className="text-neutral-300 text-sm leading-relaxed mb-6 mx-auto max-w-2xl">
                    Utilizing the Focus Realm for coding, studying, or building is the fastest path to influence. 
                    A focused operative is a powerful operative.
                </p>
            </div>
        </div>
    );
};

default Guide;

// Component: Settings

interface SettingsProps {
    currentUser: User;
    onUpdate: () => void;
}

const Settings: React.FC<SettingsProps> = ({ currentUser, onUpdate }) => {
    const [passwords, setPasswords] = useState({ current: '', new: '', confirm: '' });
    const [msg, setMsg] = useState({ text: '', type: '' });

    const handlePasswordChange = async (e: React.FormEvent) => {
        e.preventDefault();
        setMsg({ text: '', type: '' });

        if (passwords.new !== passwords.confirm) {
            setMsg({ text: 'New passwords do not match.', type: 'error' });
            return;
        }
        if (passwords.new.length < 8) {
            setMsg({ text: 'Password must be at least 8 characters.', type: 'error' });
            return;
        }
        
        if (currentUser.passwordHash !== passwords.current) {
            setMsg({ text: 'Current password incorrect.', type: 'error' });
            return;
        }

        await storage.updatePassword(currentUser.studentId, passwords.new);
        setMsg({ text: 'Security key updated successfully.', type: 'success' });
        setPasswords({ current: '', new: '', confirm: '' });
        onUpdate();
    };

    return (
        <div className="max-w-2xl mx-auto space-y-8 pb-32 animate-in fade-in duration-700">
             <div className="text-center py-8">
                <h1 className="text-4xl font-display font-black text-white tracking-tight mb-2">SETTINGS</h1>
                <p className="text-brand-gold font-mono text-xs uppercase tracking-[0.4em]">Account Security</p>
            </div>

            <div className="glass-panel p-8 rounded-2xl border border-white/5">
                <h3 className="text-lg font-bold text-white mb-6 uppercase tracking-wider">Update Security Key</h3>
                <form onSubmit={handlePasswordChange} className="space-y-6">
                    <div>
                        <label className="block text-[10px] uppercase font-bold text-neutral-500 mb-2">Current Security Key</label>
                        <input 
                            type="password" 
                            value={passwords.current}
                            onChange={e => setPasswords({...passwords, current: e.target.value})}
                            className="w-full bg-black/50 border border-white/10 rounded-xl p-3 text-white focus:border-brand-red outline-none"
                            required
                        />
                    </div>
                    <div>
                        <label className="block text-[10px] uppercase font-bold text-neutral-500 mb-2">New Security Key</label>
                        <input 
                            type="password" 
                            value={passwords.new}
                            onChange={e => setPasswords({...passwords, new: e.target.value})}
                            className="w-full bg-black/50 border border-white/10 rounded-xl p-3 text-white focus:border-brand-red outline-none"
                            required
                        />
                    </div>
                    <div>
                        <label className="block text-[10px] uppercase font-bold text-neutral-500 mb-2">Confirm New Key</label>
                        <input 
                            type="password" 
                            value={passwords.confirm}
                            onChange={e => setPasswords({...passwords, confirm: e.target.value})}
                            className="w-full bg-black/50 border border-white/10 rounded-xl p-3 text-white focus:border-brand-red outline-none"
                            required
                        />
                    </div>

                    {msg.text && (
                        <div className={`p-3 rounded text-xs font-bold uppercase ${msg.type === 'error' ? 'bg-red-900/20 text-red-500' : 'bg-emerald-900/20 text-emerald-500'}`}>
                            {msg.text}
                        </div>
                    )}

                    <button type="submit" className="px-8 py-3 bg-brand-red text-white font-bold uppercase tracking-widest text-xs rounded-lg hover:bg-red-600 transition-colors">
                        Update Key
                    </button>
                </form>
            </div>

            <div className="glass-panel p-8 rounded-2xl border border-white/5 opacity-50">
                 <h3 className="text-lg font-bold text-white mb-2 uppercase tracking-wider">Protocol Info</h3>
                 <p className="text-sm text-neutral-400 font-mono">Username: {currentUser.studentId}</p>
                 <p className="text-sm text-neutral-400 font-mono">Current Rank: {currentUser.currentCard}</p>
                 <p className="text-sm text-neutral-400 font-mono">Initialized: {new Date(currentUser.joinDate).toLocaleDateString()}</p>
            </div>
        </div>
    );
};

default Settings;

const AuthScreen: React.FC<{ onLogin: (user: User) => void; onBack: () => void }> = ({ onLogin, onBack }) => {
  const [mode, setMode] = useState<'login' | 'register'>('login');
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [isProcessing, setIsProcessing] = useState(false);
  const [settings, setSettings] = useState<SystemSettings | null>(null);

  useEffect(() => {
    storage.getSettings().then(setSettings);
  }, []);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setIsProcessing(true);

    if (!username.trim() || username.length < 2) {
        setError('ACCESS DENIED // USERNAME INVALID');
        setIsProcessing(false);
        return;
    }

    if (mode === 'login') {
        const user = await storage.getUser(username);
        if (user) {
            if (user.isBanned) {
                setError('your account has been locked.');
                setIsProcessing(false);
                return;
            } 
            
            if (user.passwordHash === password) {
                // Streak Logic
                await storage.processLoginStreak(user.studentId);
                const updatedUser = await storage.getUser(user.studentId);
                if (updatedUser) onLogin(updatedUser);
            } else {
                setError('AUTHENTICATION FAILED // INVALID KEY');
            }
        } else {
            setError('ACCESS DENIED // ACCOUNT NOT FOUND.');
        }
    } else {
        if (password.length < 8) {
            setError('REGISTRATION FAILED // KEY MUST BE AT LEAST 8 CHARS');
        } else {
            const exists = await storage.userExists(username);
            if (exists) {
                setError('REGISTRATION FAILED // USERNAME TAKEN');
            } else {
                const newUser: User = {
                    studentId: username, 
                    username: username,
                    passwordHash: password,
                    currentRank: '2 of Spades',
                    currentCard: '2â™ ',
                    totalPoints: 0,
                    spadesBalance: 0,
                    streak: 1,
                    streakFreezes: 0,
                    lastLoginDate: new Date().toISOString(),
                    joinDate: new Date().toISOString(),
                    lastActive: new Date().toISOString(),
                    yearGroup: 13,
                    house: ['Phoenix', 'Dragon', 'Griffin', 'Raven'][Math.floor(Math.random() * 4)] as any,
                    stats: { postsCreated: 0, commentsCreated: 0, votesGiven: 0, resourcesShared: 0, moderationsPerformed: 0, minutesStudied: 0 },
                    isAdmin: username === 'ACE_PROTOCOL', 
                    requiresPasswordChange: false,
                    inventory: []
                };
                await storage.saveUser(newUser);
                onLogin(newUser);
            }
        }
    }
    setIsProcessing(false);
  };

  const handleGuestLogin = async () => {
    setIsProcessing(true);
    const guestId = `GUEST-${Math.floor(1000 + Math.random() * 9000)}`;
    const guestUser: User = {
        studentId: guestId,
        username: 'Visitor',
        passwordHash: '',
        currentRank: '2 of Spades',
        currentCard: '2â™ ',
        totalPoints: 0,
        spadesBalance: 0,
        streak: 0,
        streakFreezes: 0,
        lastLoginDate: '',
        joinDate: new Date().toISOString(),
        lastActive: new Date().toISOString(),
        yearGroup: 13,
        house: 'Phoenix',
        stats: { postsCreated: 0, commentsCreated: 0, votesGiven: 0, resourcesShared: 0, moderationsPerformed: 0, minutesStudied: 0 },
        isAdmin: false,
        requiresPasswordChange: false,
        inventory: [],
        isGuest: true
    };
    await storage.saveUser(guestUser);
    onLogin(guestUser);
  };

  return (
    <div className="min-h-screen bg-[#020202] flex items-center justify-center p-4 relative overflow-hidden font-sans">
      <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')] opacity-[0.4] mix-blend-overlay"></div>
      
      <div className="max-w-[900px] w-full grid grid-cols-1 md:grid-cols-2 bg-[#050505]/80 backdrop-blur-3xl border border-white/5 rounded-[32px] shadow-2xl relative overflow-hidden">
        <button onClick={onBack} className="absolute top-6 left-6 text-neutral-600 hover:text-white transition-colors z-30">
            <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
        </button>

        <div className="relative p-12 bg-black/50 flex flex-col justify-center">
            <h1 className="text-6xl font-display font-black text-white tracking-tighter mb-4 uppercase italic leading-none">Spa<span className="text-brand-red">des</span></h1>
            <p className="text-brand-gold font-mono text-xs uppercase tracking-[0.4em] font-bold opacity-80">Community Protocol</p>
            <div className="mt-12 space-y-6">
                <div className="flex items-center gap-4 text-neutral-500 group transition-all hover:text-white">
                    <div className="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center text-orange-500">
                        <Flame className="w-5 h-5 fill-current" />
                    </div>
                    <p className="text-xs font-bold uppercase tracking-widest">Global Streak Tracking</p>
                </div>
                <div className="flex items-center gap-4 text-neutral-500 group transition-all hover:text-white">
                    <div className="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center text-brand-gold">
                        <span className="font-display font-black">â™ </span>
                    </div>
                    <p className="text-xs font-bold uppercase tracking-widest">Dual-Currency Economy</p>
                </div>
            </div>
        </div>

        <div className="p-12 bg-[#080808] border-l border-white/5 flex flex-col justify-center">
            <div className="flex gap-4 mb-10 border-b border-white/5">
                {['login', 'register'].map(m => (
                    <button key={m} onClick={() => { setMode(m as any); setError(''); }} className={`pb-2 text-xs font-bold uppercase tracking-widest transition-all ${mode === m ? 'text-white border-b-2 border-brand-red' : 'text-neutral-500 hover:text-white'}`}>{m}</button>
                ))}
            </div>

            <form onSubmit={handleSubmit} className="space-y-6">
                <div className="space-y-2">
                    <label className="text-[10px] font-bold text-neutral-500 uppercase tracking-widest">Discord Identity</label>
                    <input type="text" value={username} onChange={(e) => setUsername(e.target.value)} placeholder="Username" className="w-full bg-[#111] border border-[#222] rounded-xl p-4 text-white font-mono placeholder-neutral-700 outline-none focus:border-brand-red" />
                    {mode === 'register' && <p className="text-[9px] text-red-500/80 uppercase font-mono tracking-tighter">MUST match your Discord name exactly.</p>}
                </div>
                <div className="space-y-2">
                    <label className="text-[10px] font-bold text-neutral-500 uppercase tracking-widest">Security Key</label>
                    <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" className="w-full bg-[#111] border border-[#222] rounded-xl p-4 text-white font-mono placeholder-neutral-700 outline-none focus:border-brand-red" />
                    {mode === 'register' && <p className="text-[9px] text-neutral-600 uppercase font-mono tracking-tighter">Site-specific key (not Discord PW).</p>}
                </div>
                {error && <div className="p-3 bg-red-950/20 border border-red-900/40 rounded-lg text-red-400 text-[10px] font-mono uppercase leading-relaxed text-center">{error}</div>}
                <button type="submit" disabled={isProcessing} className="w-full bg-white text-black font-black py-4 rounded-xl hover:scale-[1.01] transition-all uppercase tracking-[0.2em] text-xs shadow-2xl">
                    {isProcessing ? 'Processing Matrix...' : (mode === 'login' ? 'Authenticate' : 'Initialize Identity')}
                </button>
            </form>

            {settings?.allowGuestAccess && (
                <div className="mt-6 pt-6 border-t border-white/5">
                    <button onClick={handleGuestLogin} disabled={isProcessing} className="w-full py-3 text-neutral-500 hover:text-white font-mono text-[10px] uppercase tracking-widest transition-colors flex items-center justify-center gap-2 font-bold">
                        <span>Continue as Guest</span>
                        <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                    </button>
                </div>
            )}
        </div>
      </div>
    </div>
  );
};

const PasswordResetScreen: React.FC<{ user: User; onSuccess: () => void }> = ({ user, onSuccess }) => {
    const [password, setPassword] = useState('');
    const [confirm, setConfirm] = useState('');
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setError('');
        if (password.length < 8) return setError('Key must be at least 8 characters.');
        if (password !== confirm) return setError('Keys do not match.');
        
        setLoading(true);
        await storage.updatePassword(user.studentId, password);
        setLoading(false);
        onSuccess();
    };

    return (
        <div className="min-h-screen bg-[#020202] flex items-center justify-center p-4">
             <div className="max-w-md w-full bg-[#080808] border border-red-900/40 rounded-3xl p-10 shadow-[0_0_50px_rgba(220,38,38,0.2)]">
                 <div className="flex justify-center mb-6">
                     <div className="w-16 h-16 rounded-full bg-red-900/20 flex items-center justify-center animate-pulse">
                         <svg className="w-8 h-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                     </div>
                 </div>
                 <h2 className="text-2xl font-display font-bold text-white text-center mb-2 uppercase">Security Reset</h2>
                 <p className="text-center text-neutral-500 text-[10px] font-mono uppercase tracking-widest mb-8">Mandatory Protocol Update</p>
                 
                 <form onSubmit={handleSubmit} className="space-y-4">
                     <input type="password" value={password} onChange={e => setPassword(e.target.value)} placeholder="New Security Key" className="w-full bg-[#111] border border-[#222] rounded-xl p-4 text-white font-mono placeholder-neutral-700 outline-none focus:border-brand-red" />
                     <input type="password" value={confirm} onChange={e => setConfirm(e.target.value)} placeholder="Confirm Key" className="w-full bg-[#111] border border-[#222] rounded-xl p-4 text-white font-mono placeholder-neutral-700 outline-none focus:border-brand-red" />
                     {error && <div className="p-3 bg-red-950/20 text-red-400 text-xs font-bold text-center border border-red-900/40 rounded-xl">{error}</div>}
                     <button type="submit" disabled={loading} className="w-full bg-brand-red text-white font-black py-4 rounded-xl uppercase tracking-widest text-xs hover:bg-red-600 transition-colors shadow-2xl">
                         {loading ? 'Securing...' : 'Establish Key'}
                     </button>
                 </form>
             </div>
        </div>
    );
};

const App: React.FC = () => {
  const [user, setUser] = useState<User | null>(null);
  const [view, setView] = useState<'portfolio' | 'auth' | 'app'>('portfolio');
  const [activeTab, setActiveTab] = useState('dashboard');
  const [dataVersion, setDataVersion] = useState(0); 

  const checkRankUp = useCallback(async (u: User) => {
      const rankSequence: RankID[] = ['2â™ ', '3â™ ', '4â™ ', '5â™ ', '6â™ ', '7â™ ', '8â™ ', '9â™ ', '10â™ ', 'Jâ™ ', 'Qâ™ ', 'Kâ™ ', 'Aâ™ '];
      let currentRankIdx = rankSequence.indexOf(u.currentCard);

      let highestEligibleIdxByPoints = 0;
      for (let i = 0; i < rankSequence.length; i++) {
          if (u.totalPoints >= RANKS[rankSequence[i]].minPoints) {
              highestEligibleIdxByPoints = i;
          }
      }

      if (highestEligibleIdxByPoints > currentRankIdx) {
          const newRankId = rankSequence[highestEligibleIdxByPoints];
          const updatedUser = { ...u, currentCard: newRankId, currentRank: RANKS[newRankId].name };
          await storage.saveUser(updatedUser);
          setUser(updatedUser);
      } else {
          setUser(u);
      }
  }, []);

  const refreshData = useCallback(async () => {
      const savedId = localStorage.getItem('session_user_id');
      if (!savedId) return;
      const freshUser = await storage.getUser(savedId);
      if (freshUser) {
          if (freshUser.isBanned) handleLogout();
          else {
              setUser(freshUser);
              checkRankUp(freshUser);
              setDataVersion(v => v + 1);
          }
      }
  }, [checkRankUp]);

  useEffect(() => {
    const savedId = localStorage.getItem('session_user_id');
    if (savedId) {
       storage.getUser(savedId).then(u => {
           if (u) {
               if (u.isBanned) {
                   handleLogout();
               } else {
                   setUser(u);
                   setView('app');
                   checkRankUp(u);
               }
           }
       });
    }

    const handleStorageUpdate = (e: StorageEvent) => {
        if (e.key === 'users' || e.key === 'art_pieces') {
            refreshData();
        }
    };
    
    const handleInternalUpdate = () => {
        refreshData();
    };

    window.addEventListener('storage', handleStorageUpdate);
    window.addEventListener('storage_update', handleInternalUpdate);
    
    return () => {
        window.removeEventListener('storage', handleStorageUpdate);
        window.removeEventListener('storage_update', handleInternalUpdate);
    };
  }, [refreshData, checkRankUp]);

  const handleLogin = (u: User) => {
    localStorage.setItem('session_user_id', u.studentId);
    setUser(u);
    setView('app');
    checkRankUp(u);
  };

  const handleLogout = () => {
    localStorage.removeItem('session_user_id');
    setUser(null);
    setView('portfolio');
  };

  if (view === 'portfolio') return <Portfolio onEnterSystem={() => setView('auth')} />;
  if (view === 'auth' && !user) return <AuthScreen onLogin={handleLogin} onBack={() => setView('portfolio')} />;

  if (!user) return <Portfolio onEnterSystem={() => setView('auth')} />;

  if (user.requiresPasswordChange && !user.isGuest) {
      return <PasswordResetScreen user={user} onSuccess={refreshData} />;
  }

  return (
    <div className="min-h-screen bg-[#020202] text-neutral-100 flex font-sans">
      <Nav user={user} activeTab={activeTab} onTabChange={setActiveTab} onLogout={handleLogout} />
      <main className="flex-1 md:ml-72 p-4 md:p-10 overflow-x-hidden relative">
        <div className="max-w-6xl mx-auto mt-20 md:mt-0 relative z-10">
          {activeTab === 'dashboard' && <Dashboard user={user} />}
          {activeTab === 'feed' && <Feed currentUser={user} refreshTrigger={dataVersion} onActivity={refreshData} />}
          {activeTab === 'focus' && <FocusRealm currentUser={user} onActivity={refreshData} />}
          {activeTab === 'gallery' && <ArtGallery currentUser={user} onPurchase={refreshData} />}
          {activeTab === 'leaderboard' && <Leaderboard />}
          {activeTab === 'council' && <CouncilChamber currentUser={user} refreshTrigger={dataVersion} onActivity={refreshData} />}
          {activeTab === 'guide' && <Guide />}
          {activeTab === 'settings' && <Settings currentUser={user} onUpdate={refreshData} />}
          {activeTab === 'admin' && user.isAdmin && <AceControls currentUser={user} onActivity={refreshData} />}
        </div>
      </main>
    </div>
  );
};

default App;

(async()=>{console.log('ðŸŽ´ Initializing Spades Protocol with Firebase...');await storage.init();console.log('âœ“ Firebase initialized');const root=ReactDOM.createRoot(document.getElementById('root'));root.render(React.createElement(App));console.log('âœ“ App rendered');})();
</script>
</body>
</html>

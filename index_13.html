<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spades - Secure Student Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; }
        body { background: #020202; color: #f5f5f5; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .bg-gradient { background: radial-gradient(circle at 50% -20%, #1a0505 0%, #020202 50%); position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .card-spade { width: 100px; height: 140px; background: white; border: 2px solid #333; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 8px; font-weight: bold; color: #000; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .card-spade.ace { border-color: #d92323; }
        .card-spade.ace .value { color: #d92323; }
        .glass-panel { background: rgba(10, 10, 10, 0.6); backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 16px; padding: 24px; }
        .btn-primary { background: #d92323; color: white; padding: 12px 32px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s; text-transform: uppercase; font-size: 12px; letter-spacing: 1px; }
        .btn-primary:hover { background: #a01818; transform: scale(1.05); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .input-field { background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); color: white; padding: 12px 16px; border-radius: 8px; font-size: 14px; width: 100%; transition: all 0.3s; font-family: 'Inter', sans-serif; }
        .input-field:focus { outline: none; border-color: rgba(255, 255, 255, 0.3); background: rgba(0, 0, 0, 0.5); }
        .text-gradient-gold { background: linear-gradient(135deg, #fceeb5 0%, #e2b15b 50%, #8a6d3b 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .sidebar { position: fixed; left: 0; top: 0; width: 280px; height: 100vh; background: #0a0a0a; border-right: 1px solid rgba(255, 255, 255, 0.05); padding: 24px; overflow-y: auto; z-index: 50; }
        .sidebar-nav { display: flex; flex-direction: column; gap: 8px; margin-top: 32px; }
        .sidebar-nav button { background: transparent; color: #999; border: none; padding: 12px 16px; border-radius: 8px; cursor: pointer; text-align: left; font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.3s; }
        .sidebar-nav button:hover { background: rgba(255, 255, 255, 0.05); color: white; }
        .sidebar-nav button.active { background: #d92323; color: white; }
        .main-content { margin-left: 280px; padding: 40px; min-height: 100vh; }
        @media (max-width: 768px) { .sidebar { display: none; } .main-content { margin-left: 0; padding: 20px; } }
        .loading-spinner { width: 48px; height: 48px; border: 4px solid #d92323; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .error-message { background: rgba(217, 35, 35, 0.2); border: 1px solid rgba(217, 35, 35, 0.4); color: #ff6b6b; padding: 12px 16px; border-radius: 8px; font-size: 12px; font-weight: bold; }
        .post-card { background: rgba(10, 10, 10, 0.4); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 16px; margin-bottom: 16px; transition: all 0.3s; }
        .post-card:hover { background: rgba(20, 20, 20, 0.6); border-color: rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>
    <div id="app"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBYfyPC_PEejSVytCmgljnKQ2HUSROlIFc",
            authDomain: "spades-c87ee.firebaseapp.com",
            projectId: "spades-c87ee",
            storageBucket: "spades-c87ee.firebasestorage.app",
            messagingSenderId: "930924627451",
            appId: "1:930924627451:web:99576f0d2d88f508e6375e",
            measurementId: "G-X49C6SCGGW"
        };

        const firebaseApp = initializeApp(firebaseConfig);
        const db = getFirestore(firebaseApp);

        const SecureAuth = {
            async hashPassword(password) {
                const encoder = new TextEncoder();
                const data = encoder.encode(password);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
            },
            generateSalt() {
                const array = new Uint8Array(16);
                crypto.getRandomValues(array);
                return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
            },
            async hashPasswordWithSalt(password, salt) {
                const encoder = new TextEncoder();
                const data = encoder.encode(password + salt);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
            },
            sanitizeInput(input) {
                if (typeof input !== 'string') return '';
                return input.trim().replace(/[<>]/g, '').substring(0, 500);
            }
        };

        const DatabaseService = {
            async getUser(studentId) {
                try {
                    const userDoc = await getDoc(doc(db, 'users', studentId));
                    return userDoc.exists() ? userDoc.data() : null;
                } catch (e) { return null; }
            },
            async authenticateUser(studentId, password) {
                const user = await this.getUser(studentId);
                if (!user) return { success: false, message: 'User not found' };
                if (user.isBanned) return { success: false, message: 'Account suspended' };
                const hash = user.salt ? await SecureAuth.hashPasswordWithSalt(password, user.salt) : await SecureAuth.hashPassword(password);
                if (hash !== user.passwordHash) return { success: false, message: 'Invalid credentials' };
                await updateDoc(doc(db, 'users', studentId), { lastLoginDate: new Date().toISOString() });
                return { success: true, user };
            },
            async createUser(studentId, username, password, yearGroup, house) {
                const existing = await this.getUser(studentId);
                if (existing) return { success: false, message: 'User already exists' };
                const salt = SecureAuth.generateSalt();
                const passwordHash = await SecureAuth.hashPasswordWithSalt(password, salt);
                const newUser = {
                    studentId: SecureAuth.sanitizeInput(studentId),
                    username: SecureAuth.sanitizeInput(username),
                    passwordHash, salt, currentRank: '2 of Spades', currentCard: '2‚ô†',
                    totalPoints: 0, spadesBalance: 0, streak: 0,
                    lastLoginDate: new Date().toISOString(), joinDate: new Date().toISOString(),
                    yearGroup: parseInt(yearGroup), house: SecureAuth.sanitizeInput(house),
                    isAdmin: false, isBanned: false, inventory: []
                };
                await setDoc(doc(db, 'users', studentId), newUser);
                return { success: true, user: newUser };
            },
            async getPosts() {
                const q = query(collection(db, 'posts'), orderBy('createdAt', 'desc'));
                const snap = await getDocs(q);
                return snap.docs.map(d => d.data());
            },
            async savePost(postData) {
                await setDoc(doc(db, 'posts', postData.id), postData);
                return true;
            },
            async deletePost(postId) {
                await deleteDoc(doc(db, 'posts', postId));
                return true;
            }
        };

        let appState = { currentPage: 'landing', currentUser: null, posts: [], loading: false, message: '', isSignup: false, activeTab: 'dashboard' };
        const appEl = document.getElementById('app');

        function setState(newState) {
            appState = { ...appState, ...newState };
            render();
        }

        window.setState = setState;

        function render() {
            if (appState.loading) {
                appEl.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100vh;"><div style="text-align:center;"><div class="loading-spinner" style="margin:0 auto 20px;"></div><p style="color:#999;font-size:12px;letter-spacing:2px;text-transform:uppercase;">Initializing System...</p></div></div>`;
                return;
            }
            if (appState.currentPage === 'landing') renderLanding();
            else if (appState.currentPage === 'auth') renderAuth();
            else if (appState.currentPage === 'app') renderApp();
        }

        function renderLanding() {
            appEl.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100vh;padding:20px;"><div style="text-align:center;animation:fadeIn 1s ease-out;"><h1 style="font-size:72px;font-weight:900;margin-bottom:20px;letter-spacing:-2px;"><span class="text-gradient-gold">SPADES</span></h1><p style="color:#666;font-size:12px;letter-spacing:2px;text-transform:uppercase;margin-bottom:60px;">Elite Student Platform</p><div style="margin-bottom:60px;"><div class="card-spade ace" style="margin:0 auto;"><div class="value" style="font-size:24px;">A‚ô†</div><div style="font-size:48px;color:#d92323;">‚ô†</div><div class="value" style="font-size:24px;transform:rotate(180deg);">A‚ô†</div></div></div><button class="btn-primary" onclick="setState({currentPage:'auth'})">Enter System</button></div></div>`;
        }

        function renderAuth() {
            const isLogin = !appState.isSignup;
            appEl.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100vh;padding:20px;"><div style="width:100%;max-width:400px;animation:fadeIn 0.5s ease-out;"><div style="text-align:center;margin-bottom:40px;"><h2 style="font-size:32px;font-weight:bold;margin-bottom:10px;">${isLogin?'Access System':'Register'}</h2><p style="color:#666;font-size:10px;letter-spacing:2px;text-transform:uppercase;">Secure Authentication</p></div><div class="glass-panel" style="margin-bottom:20px;">${appState.message?`<div class="error-message" style="margin-bottom:16px;">${appState.message}</div>`:''}<div style="display:flex;flex-direction:column;gap:12px;"><input type="text" id="studentId" class="input-field" placeholder="Student ID" />${!isLogin?`<input type="text" id="username" class="input-field" placeholder="Username" />`:''}<input type="password" id="password" class="input-field" placeholder="Password" />${!isLogin?`<input type="number" id="yearGroup" class="input-field" placeholder="Year Group" /><input type="text" id="house" class="input-field" placeholder="House" />`:''}<button class="btn-primary" id="authBtn" style="width:100%;">${isLogin?'Access':'Register'}</button></div><div style="display:flex;gap:10px;margin-top:20px;font-size:12px;"><button onclick="setState({isSignup:${!appState.isSignup},message:''})" style="flex:1;background:none;color:#999;border:none;cursor:pointer;text-transform:uppercase;letter-spacing:0.5px;">${isLogin?'Create Account':'Back to Login'}</button></div><button onclick="setState({currentPage:'landing',message:''})" style="width:100%;background:none;color:#666;border:none;cursor:pointer;padding:12px;margin-top:10px;text-transform:uppercase;font-size:12px;letter-spacing:0.5px;">‚Üê Back</button></div></div></div>`;
            document.getElementById('authBtn').onclick = () => handleAuth(isLogin);
        }

        function renderApp() {
            const user = appState.currentUser;
            appEl.innerHTML = `<div style="display:flex;"><div class="sidebar"><h1 style="font-size:28px;font-weight:900;margin-bottom:10px;"><span class="text-gradient-gold">SPADES</span></h1><p style="color:#666;font-size:10px;letter-spacing:2px;text-transform:uppercase;">v2.0 Secure</p><div class="glass-panel" style="margin-top:20px;margin-bottom:20px;"><div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;"><div class="card-spade" style="width:60px;height:80px;font-size:12px;"><div>${user.currentCard.split('')[0]}</div><div>‚ô†</div></div><div><div style="color:white;font-weight:bold;font-size:14px;">${user.username}</div><div style="color:#999;font-size:10px;">${user.currentRank}</div></div></div><div style="font-size:12px;color:#999;"><div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>Points:</span><span style="color:#e2b15b;font-weight:bold;">${(user.totalPoints||0).toLocaleString()}</span></div><div style="display:flex;justify-content:space-between;"><span>Spades:</span><span style="color:#d92323;font-weight:bold;">${user.spadesBalance||0}</span></div></div></div><div class="sidebar-nav"><button class="${appState.activeTab==='dashboard'?'active':''}" onclick="setState({activeTab:'dashboard'})">üìä Dashboard</button><button class="${appState.activeTab==='feed'?'active':''}" onclick="setState({activeTab:'feed'})">üì° Feed</button><button class="${appState.activeTab==='gallery'?'active':''}" onclick="setState({activeTab:'gallery'})">üé® Gallery</button><button class="${appState.activeTab==='leaderboard'?'active':''}" onclick="setState({activeTab:'leaderboard'})">üèÜ Leaderboard</button><button class="${appState.activeTab==='settings'?'active':''}" onclick="setState({activeTab:'settings'})">‚öôÔ∏è Settings</button>${user.isAdmin?`<button class="${appState.activeTab==='admin'?'active':''}" onclick="setState({activeTab:'admin'})">üëë Admin</button>`:''}</div><button class="btn-primary" onclick="handleLogout()" style="width:100%;margin-top:40px;">Logout</button></div><div class="main-content"><div style="max-width:1200px;margin:0 auto;">${renderTabContent()}</div></div></div>`;
            if (appState.activeTab === 'feed') {
                document.getElementById('postBtn').onclick = handlePost;
                window.handleDeletePost = handleDeletePost;
            }
        }

        function renderTabContent() {
            const tab = appState.activeTab;
            const user = appState.currentUser;
            if (tab === 'dashboard') return `<div class="fade-in"><h1 style="font-size:36px;font-weight:900;margin-bottom:10px;">Dashboard</h1><p style="color:#999;font-size:14px;margin-bottom:40px;">Welcome back, ${user.username}</p><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:40px;"><div class="glass-panel"><div style="color:#999;font-size:11px;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">Total Points</div><div style="font-size:32px;font-weight:900;color:#e2b15b;">${(user.totalPoints||0).toLocaleString()}</div></div><div class="glass-panel"><div style="color:#999;font-size:11px;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">Spades Balance</div><div style="font-size:32px;font-weight:900;color:#d92323;">${user.spadesBalance||0}</div></div><div class="glass-panel"><div style="color:#999;font-size:11px;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">Current Rank</div><div style="font-size:24px;font-weight:900;">${user.currentRank}</div></div></div></div>`;
            if (tab === 'feed') {
                const postsHTML = appState.posts.length > 0 ? appState.posts.map(post => `<div class="post-card"><div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;"><div><div style="color:white;font-weight:bold;font-size:14px;">${post.authorName}</div><div style="color:#999;font-size:11px;">${new Date(post.createdAt).toLocaleDateString()}</div></div>${user&&(user.isAdmin||post.authorId===user.studentId)?`<button onclick="handleDeletePost('${post.id}')" style="background:none;color:#999;border:none;cursor:pointer;font-size:16px;">√ó</button>`:''}</div><p style="color:#ddd;line-height:1.6;white-space:pre-wrap;">${post.content}</p></div>`).join('') : '<p style="color:#999;text-align:center;padding:40px;">No posts yet</p>';
                return `<div class="fade-in"><h1 style="font-size:36px;font-weight:900;margin-bottom:40px;">Feed</h1><div class="glass-panel" style="margin-bottom:30px;"><textarea id="postContent" class="input-field" placeholder="Share your thoughts..." style="height:120px;resize:vertical;margin-bottom:15px;"></textarea><button class="btn-primary" id="postBtn">Post</button></div><div id="posts-container" style="display:flex;flex-direction:column;gap:16px;">${postsHTML}</div></div>`;
            }
            return `<div class="fade-in"><h1 style="font-size:36px;font-weight:900;margin-bottom:40px;">${tab.charAt(0).toUpperCase()+tab.slice(1)}</h1><p style="color:#999;">Feature coming soon</p></div>`;
        }

        async function handleAuth(isLogin) {
            const studentId = document.getElementById('studentId').value;
            const password = document.getElementById('password').value;
            if (!studentId || !password) { setState({ message: 'Error: Please fill all fields' }); return; }
            setState({ loading: true });
            if (isLogin) {
                const res = await DatabaseService.authenticateUser(studentId, password);
                if (res.success) {
                    localStorage.setItem('userId', studentId);
                    const posts = await DatabaseService.getPosts();
                    setState({ currentPage: 'app', currentUser: res.user, posts, loading: false });
                } else setState({ message: 'Error: ' + res.message, loading: false });
            } else {
                const username = document.getElementById('username').value;
                const yearGroup = document.getElementById('yearGroup').value;
                const house = document.getElementById('house').value;
                if (!username || !yearGroup || !house) { setState({ message: 'Error: Please fill all fields', loading: false }); return; }
                const res = await DatabaseService.createUser(studentId, username, password, yearGroup, house);
                if (res.success) {
                    localStorage.setItem('userId', studentId);
                    setState({ currentPage: 'app', currentUser: res.user, posts: [], loading: false });
                } else setState({ message: 'Error: ' + res.message, loading: false });
            }
        }

        async function handlePost() {
            const content = document.getElementById('postContent').value;
            if (!content.trim()) return;
            const newPost = { id: `post-${Date.now()}`, authorId: appState.currentUser.studentId, authorName: appState.currentUser.username, content: SecureAuth.sanitizeInput(content), createdAt: new Date().toISOString() };
            await DatabaseService.savePost(newPost);
            const posts = await DatabaseService.getPosts();
            setState({ posts });
        }

        async function handleDeletePost(postId) {
            if (confirm('Delete this post?')) {
                await DatabaseService.deletePost(postId);
                const posts = await DatabaseService.getPosts();
                setState({ posts });
            }
        }

        window.handleLogout = () => { localStorage.removeItem('userId'); setState({ currentPage: 'landing', currentUser: null, posts: [] }); };

        async function init() {
            const userId = localStorage.getItem('userId');
            if (userId) {
                const user = await DatabaseService.getUser(userId);
                if (user && !user.isBanned) {
                    const posts = await DatabaseService.getPosts();
                    setState({ currentPage: 'app', currentUser: user, posts, loading: false });
                } else setState({ loading: false });
            } else setState({ loading: false });
        }
        init();
    </script>
</body>
</html>
